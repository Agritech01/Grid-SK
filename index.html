<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Cane Dashboard 68/69 - Professional Version</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --light: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; line-height: 1.4; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .upload-card { border: 2px dashed #cbd5e0; padding: 20px; border-radius: 10px; text-align: center; background: #fff; }
        .status-badge { display: inline-block; margin-top: 10px; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; background: #edf2f7; }
        .status-ready { background: #c6f6d5; color: #2f855a; }
        .filter-container { display: flex; flex-wrap: nowrap; gap: 4px; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 12px; overflow-x: auto; }
        .btn-zone { flex: 1; padding: 8px 4px; border: 1px solid #cbd5e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; text-align: center; }
        .btn-zone.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-container { position: relative; height: 550px; width: 100%; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { padding: 20px; border-radius: 12px; color: #2c3e50; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card.blue { background: linear-gradient(135deg, #D6EAF8, #AED6F1); }
        .stat-card.green { background: linear-gradient(135deg, #D5F5E3, #ABEBC6); }
        .stat-card.orange { background: linear-gradient(135deg, #FCF3CF, #FAD7A0); }
        .stat-card.red { background: linear-gradient(135deg, #FADBD8, #F5B7B1); }
        .stat-label { font-size: 0.95em; font-weight: 600; opacity: 0.85; margin-bottom: 10px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .footer-actions { margin-top: 30px; text-align: right; }
        .btn-download { background: #2d3748; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

<div class="container" id="dashboardNode">
    <h2 id="dashboardTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69</h2>
    
    <div class="upload-grid" id="uploadPanel">
        <div class="upload-card">
            <strong>1. ‡πÑ‡∏ü‡∏•‡πå DATA TARGET (‡πÄ‡∏Ç‡∏ï, ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX, STD...)</strong><br>
            <input type="file" id="targetUpload" accept=".csv">
            <div id="targetStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
        <div class="upload-card">
            <strong>2. ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏Ç‡∏ï, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...)</strong><br>
            <input type="file" id="actualUpload" accept=".csv">
            <div id="actualStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
    </div>

    <div class="filter-container" id="zoneFilter" style="display:none;"></div>

    <div id="mainDashboard" style="display:none;">
        <div class="chart-container">
            <canvas id="sugarChart"></canvas>
        </div>
        <div class="stats-grid">
            <div class="stat-card blue"><div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardTarget">-</div></div>
            <div class="stat-card green"><div class="stat-label">‡∏´‡∏µ‡∏ö‡∏™‡∏∞‡∏™‡∏° (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardAcc">-</div></div>
            <div class="stat-card orange"><div class="stat-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div><div class="stat-value" id="cardPercent">-</div></div>
            <div class="stat-card red"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardRemain">-</div></div>
        </div>
        <div class="footer-actions">
            <button class="btn-download" onclick="exportImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    let rawTarget = [], rawActual = [], myChart = null;
    const zones = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12", "21", "C1", "C2", "C3", "C4"];

    document.getElementById('targetUpload').addEventListener('change', (e) => handleFile(e, 'target'));
    document.getElementById('actualUpload').addEventListener('change', (e) => handleFile(e, 'actual'));

function handleFile(event, type) {
    const file = event.target.files[0];
    if (!file) return;

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ---
    document.getElementById('mainDashboard').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Dashboard
    document.getElementById('zoneFilter').innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï
    if (myChart) {
        myChart.destroy(); // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á
        myChart = null;
    }

    if (type === 'target') {
        rawTarget = [];
        document.getElementById('targetStatus').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        document.getElementById('targetStatus').classList.remove('status-ready');
    } else {
        rawActual = []; 
        document.getElementById('actualStatus').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...";
        document.getElementById('actualStatus').classList.remove('status-ready');
    }

    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        transformHeader: (h) => h.trim(),
        complete: function(results) {
            if (type === 'target') {
                rawTarget = results.data;
                document.getElementById('targetStatus').innerText = "‚úì Target ‡∏û‡∏£‡πâ‡∏≠‡∏°";
                document.getElementById('targetStatus').classList.add('status-ready');
            } else {
                rawActual = results.data;
                document.getElementById('actualStatus').innerText = "‚úì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°";
                document.getElementById('actualStatus').classList.add('status-ready');
            }
      
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∂‡∏á‡πÅ‡∏™‡∏î‡∏á Dashboard
            if (rawTarget.length > 0 && rawActual.length > 0) {
                showDashboard();
            }
        }
    });
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
    event.target.value = '';
}

  function showDashboard() {
    // 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (Actual)
    const headers = Object.keys(rawActual[0]);
    
    // 2. ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ /)
    const dateColumns = headers.filter(h => h.includes('/'));

    // 3. ‡∏´‡∏≤‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠ 0)
    let lastDateWithData = dateColumns[0];
    for (let date of dateColumns) {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÑ‡∏´‡∏ô‡∏™‡∏±‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        const hasData = rawActual.some(row => row[date] && row[date] !== "0" && row[date] !== "");
        if (hasData) {
            lastDateWithData = date;
        } else {
            break; // ‡πÄ‡∏à‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î
        }
    }

    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á" ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏∑‡πà‡∏≠ activeDates
    // ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    window.activeDates = dateColumns.slice(0, dateColumns.indexOf(lastDateWithData) + 1);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
    initFilterButtons();
    document.getElementById('zoneFilter').style.display = 'flex';
    document.getElementById('mainDashboard').style.display = 'block';
    document.getElementById('uploadPanel').style.display = 'none';
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    updateDashboard('‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï');
}

    function initFilterButtons() {
        const container = document.getElementById('zoneFilter');
        container.innerHTML = `<button class="btn-zone active" onclick="changeZone(this, '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï')">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</button>`;
        zones.forEach(z => { container.innerHTML += `<button class="btn-zone" onclick="changeZone(this, '${z}')">‡πÄ‡∏Ç‡∏ï ${z}</button>`; });
    }

    function changeZone(btn, zone) {
        document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(zone);
    }

    function parseNum(val) {
        if (!val) return 0;
        let cleanVal = String(val).replace(/[^0-9.-]/g, '');
        return parseFloat(cleanVal) || 0;
    }

    function generateDateRange() {
        let dates = [], start = new Date(1968, 11, 7), end = new Date(1969, 2, 31), current = new Date(start);
        while (current <= end) { dates.push(new Date(current)); current.setDate(current.getDate() + 1); }
        return dates;
    }

    function updateDashboard(selectedZone) {
        const dates = generateDateRange();
        let targetMax = 0, std1 = 0, std2 = 0, std3 = 0;

        rawTarget.forEach(row => {
            if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                targetMax += parseNum(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]);
                std1 += parseNum(row["STD 14/12"]);
                std2 += parseNum(row["STD 5/1"]);
                std3 += parseNum(row["STD 21/1"]);
            }
        });

        const targetSeries = dates.map(d => {
            const m = d.getMonth() + 1, day = d.getDate();
            if (m === 12 && day >= 7 && day <= 27) return std1;
            if (m === 1 && day >= 5 && day <= 20) return std2;
            if ((m === 1 && day >= 21) || m === 2 || m === 3) return std3;
            return 0;
        });

        let lastDataIdx = -1;
        const actualDaily = dates.map((d, idx) => {
            const day = d.getDate(), month = d.getMonth() + 1, year = d.getFullYear();
            const k1 = `${day}/${month}/${year}`; 
            const k2 = `${String(day).padStart(2,'0')}/${String(month).padStart(2,'0')}/${year}`;
            const k3 = `${day}/${month}/${year + 543}`;
            const k4 = `${String(day).padStart(2,'0')}/${String(month).padStart(2,'0')}/${year + 543}`;

            let sum = 0, found = false;
            rawActual.forEach(row => {
                if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                    const matchKey = Object.keys(row).find(key => {
                        const ck = key.trim();
                        return ck === k1 || ck === k2 || ck === k3 || ck === k4;
                    });
                    if (matchKey) {
                        const val = parseNum(row[matchKey]);
                        if (row[matchKey] !== "" && row[matchKey] !== null) { found = true; sum += val; }
                    }
                }
            });
            if (found) lastDataIdx = idx;
            return sum;
        });

        let accSum = 0, actualAcc = [];
        for (let i = 0; i <= lastDataIdx; i++) { accSum += actualDaily[i]; actualAcc.push(accSum); }
        
        const projectionLine = new Array(actualAcc.length > 0 ? actualAcc.length - 1 : 0).fill(null);
        if (actualAcc.length > 0) projectionLine.push(accSum);
        if (lastDataIdx < dates.length - 1 && lastDataIdx !== -1) {
            let remTarget = Math.max(0, targetMax - accSum), remDays = dates.length - 1 - lastDataIdx, dailyProj = remTarget / remDays, tempAcc = accSum;
            for (let i = lastDataIdx + 1; i < dates.length; i++) { tempAcc += dailyProj; projectionLine.push(tempAcc); }
        }

        const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        const lastDateObj = dates[lastDataIdx !== -1 ? lastDataIdx : 0];
        const displayYear = lastDateObj.getFullYear() + 600;
        
        document.getElementById('dashboardTitle').innerHTML = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69<br>
            <span style="font-size: 0.8em; color: var(--accent);">${selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' : '‡πÄ‡∏Ç‡∏ï ' + selectedZone}</span><br>
            <span style="font-size: 0.6em; font-weight: normal;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${lastDateObj.getDate()} ${thaiMonths[lastDateObj.getMonth()]} ${displayYear}</span>`;
        
        document.getElementById('cardTarget').innerText = Math.round(targetMax).toLocaleString();
        document.getElementById('cardAcc').innerText = Math.round(accSum).toLocaleString();
        document.getElementById('cardPercent').innerText = ((accSum / (targetMax || 1)) * 100).toFixed(2) + "%";
        document.getElementById('cardRemain').innerText = Math.max(0, Math.round(targetMax - accSum)).toLocaleString();

        renderChart(dates, targetSeries, actualDaily, actualAcc, projectionLine, lastDataIdx);
    }

    function isValidZone(rowZone, selectedZone) {
        const cleanRowZone = String(rowZone || "").trim();
        if (selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï') return zones.includes(cleanRowZone);
        return cleanRowZone === selectedZone;
    }

    function renderChart(dates, targets, daily, acc, proj, lastIdx) {
        const labels = dates.map(d => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}`);
        const ctx = document.getElementById('sugarChart').getContext('2d');
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    { 
                        type: 'line', 
                        label: '‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°', 
                        data: acc, 
                        borderColor: '#27ae60', 
                        backgroundColor: '#27ae60', 
                        borderWidth: 3, 
                        yAxisID: 'yAcc', 
                        // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                        pointRadius: (ctx) => (ctx.dataIndex === lastIdx ? 5 : 0),
                        pointBackgroundColor: '#FF0000',
                        pointBorderColor: '#FF0000',
                        order: 1, 
                        datalabels: { display: (context) => context.dataIndex === lastIdx, anchor: 'end', align: 'right', backgroundColor: '#33CCCC', color: 'white', borderRadius: 4, padding: 4, formatter: (val) => Math.round(val).toLocaleString() } 
                    },
                    { 
                        type: 'line', 
                        label: '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏∞‡∏™‡∏°', 
                        data: proj, 
                        borderColor: '#27ae60', 
                        borderDash: [5, 5], // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
                        yAxisID: 'yAcc', 
                        // ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
                        pointRadius: (ctx) => (ctx.dataIndex === proj.length - 1 ? 5 : 0),
                        pointBackgroundColor: '#FF0000',
                        pointBorderColor: '#FF0000',
                        order: 2, 
                        datalabels: { display: (context) => context.dataIndex === proj.length - 1, anchor: 'end', align: 'right', backgroundColor: '#4682B4', color: 'white', borderRadius: 4, padding: 4, formatter: (val) => Math.round(val).toLocaleString() } 
                    },
                    { 
                        type: 'bar', 
                        label: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', 
                        data: daily, 
                        backgroundColor: '#3498db', 
                        yAxisID: 'yDaily', 
                        order: 3, 
                        datalabels: { display: (context) => context.dataIndex === lastIdx, anchor: 'end', align: 'top', backgroundColor: '#00CCFF', color: 'white', borderRadius: 4, padding: 4, formatter: (val) => Math.round(val).toLocaleString() } 
                    },
                    { 
                        type: 'bar', 
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ STD ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ï‡∏±‡∏ô)', 
                        data: targets, 
                        backgroundColor: 'rgba(200, 200, 200, 0.2)', 
                        barPercentage: 1, 
                        categoryPercentage: 1, 
                        yAxisID: 'yDaily', 
                        order: 4, 
                        datalabels: { display: false } 
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    tooltip: { mode: 'index', intersect: false }, 
                    datalabels: { clip: false, clamp: true, font: { weight: 'bold', size: 10 } } 
                },
                scales: {
                    x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 9 } } },
                    yDaily: { type: 'linear', position: 'left', title: { display: true, text: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' }, beginAtZero: true },
                    yAcc: { type: 'linear', position: 'right', title: { display: true, text: '‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°' }, grid: { drawOnChartArea: false }, beginAtZero: true }
                }
            }
        });
    }

    function exportImage() {
        const node = document.getElementById('dashboardNode');
        const filter = document.getElementById('zoneFilter'), footer = document.querySelector('.footer-actions');
        filter.style.display = 'none'; footer.style.display = 'none';
        html2canvas(node, { scale: 2 }).then(canvas => {
            const link = document.createElement('a'); link.download = 'Sugar_Report.png'; link.href = canvas.toURL(); link.click();
            filter.style.display = 'flex'; footer.style.display = 'block';
        });
    }
</script>
</body>
</html>
