window.onload = async function() {
        const status = document.getElementById('loadingOverlay');
        try {
            const [targetRes, actualRes] = await Promise.all([
                fetch(TARGET_CSV_URL),
                fetch(ACTUAL_CSV_URL)
            ]);

            // เช็คว่าดึงไฟล์ได้ไหม
            if (!targetRes.ok || !actualRes.ok) throw new Error("ดึงไฟล์ไม่สำเร็จ ตรวจสอบลิงก์ Publish");

            const targetText = await targetRes.text();
            const actualText = await actualRes.text();

            // เช็คว่าเป็นไฟล์ CSV จริงไหม (ถ้ามีคำว่า <html> แปลว่าได้หน้าเว็บมาแทนไฟล์)
            if (targetText.includes("<!DOCTYPE html>")) throw new Error("ลิงก์ที่ใช้ไม่ใช่ CSV (โปรดเลือกรูปแบบ CSV ใน Google Sheets)");

            Papa.parse(targetText, {
                header: true,
                skipEmptyLines: true,
                transformHeader: (h) => h.trim(),
                complete: function(tResults) {
                    rawTarget = tResults.data;
                    
                    // เช็คว่าในไฟล์ Target มีหัวข้อที่ต้องการไหม
                    if(!rawTarget[0]["เป้าหมาย MAX"]) {
                        status.innerHTML = "❌ ไม่พบหัวข้อ 'เป้าหมาย MAX' ในไฟล์ Target";
                        return;
                    }

                    Papa.parse(actualText, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (h) => h.trim(),
                        complete: function(aResults) {
                            rawActual = aResults.data;
                            status.style.display = 'none';
                            initDashboard();
                        }
                    });
                }
            });
        } catch (error) {
            status.innerHTML = `❌ ข้อผิดพลาด: ${error.message}`;
            console.error(error);
        }
    };
