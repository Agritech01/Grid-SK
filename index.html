<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Cane Dashboard 68/69</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --light: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1300px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        /* Upload Zone */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .upload-card { border: 2px dashed #cbd5e0; padding: 20px; border-radius: 10px; text-align: center; transition: 0.3s; background: #fff; }
        .upload-card:hover { border-color: var(--accent); background: #f0fff4; }
        .upload-card input { margin-top: 10px; width: 100%; }
        .status-badge { display: inline-block; margin-top: 10px; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; background: #edf2f7; }
        .status-ready { background: #c6f6d5; color: #2f855a; }

        /* Filter Buttons */
        .filter-container { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 30px; padding: 15px; background: #f8fafc; border-radius: 12px; }
        .btn-zone { padding: 8px 16px; border: 1px solid #cbd5e0; background: white; border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .btn-zone:hover { background: #edf2f7; }
        .btn-zone.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; text-align: center; position: relative; overflow: hidden; }
        .stat-card.blue { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-card.green { background: linear-gradient(135deg, #27ae60, #219150); }
        .stat-card.orange { background: linear-gradient(135deg, #f39c12, #d35400); }
        .stat-card.red { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 10px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }

        /* Chart Area */
        .chart-container { position: relative; height: 550px; width: 100%; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; }
        
        .footer-actions { margin-top: 30px; text-align: right; }
        .btn-download { background: #2d3748; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        .btn-download:hover { background: #1a202c; }

        #dataPreview { margin-top: 20px; font-size: 0.75rem; color: #718096; max-height: 100px; overflow: auto; display: none; }
    </style>
</head>
<body>

<div class="container" id="dashboardNode">
    <h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69</h2>

    <div class="upload-grid" id="uploadPanel">
        <div class="upload-card">
            <strong>1. ‡πÑ‡∏ü‡∏•‡πå DATA TARGET</strong>
            <input type="file" id="targetUpload" accept=".csv">
            <div id="targetStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
        <div class="upload-card">
            <strong>2. ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö 68/69</strong>
            <input type="file" id="actualUpload" accept=".csv">
            <div id="actualStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
    </div>

    <div class="filter-container" id="zoneFilter" style="display:none;"></div>

    <div id="mainDashboard" style="display:none;">
        <div class="stats-grid">
            <div class="stat-card blue">
                <div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï (‡∏ï‡∏±‡∏ô)</div>
                <div class="stat-value" id="cardTarget">-</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">‡∏´‡∏µ‡∏ö‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡∏ô)</div>
                <div class="stat-value" id="cardAcc">-</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div>
                <div class="stat-value" id="cardPercent">-</div>
            </div>
            <div class="stat-card red">
                <div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</div>
                <div class="stat-value" id="cardRemain">-</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="sugarChart"></canvas>
        </div>

        <div class="footer-actions">
            <button class="btn-download" onclick="exportImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
    
    <div id="dataPreview"></div>
</div>

<script>
    let rawTarget = [];
    let rawActual = [];
    let myChart = null;
    const zones = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12", "21", "C1", "C2", "C3", "C4"];

    // 1-3. File Upload & Processing
    document.getElementById('targetUpload').addEventListener('change', (e) => handleFile(e, 'target'));
    document.getElementById('actualUpload').addEventListener('change', (e) => handleFile(e, 'actual'));

    function handleFile(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        if (file.size > 100 * 1024 * 1024) { alert("‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB"); return; }
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (type === 'target') {
                    rawTarget = results.data;
                    updateStatus('targetStatus', "‚úì ‡πÑ‡∏ü‡∏•‡πå Target ‡∏û‡∏£‡πâ‡∏≠‡∏°");
                } else {
                    rawActual = results.data;
                    updateStatus('actualStatus', "‚úì ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°");
                }
                checkReady();
            }
        });
    }

    function updateStatus(id, text) {
        const el = document.getElementById(id);
        el.innerText = text;
        el.classList.add('status-ready');
    }

    function checkReady() {
        if (rawTarget.length > 0 && rawActual.length > 0) {
            initFilterButtons();
            document.getElementById('zoneFilter').style.display = 'flex';
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('uploadPanel').style.display = 'none';
            updateDashboard('‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï');
        }
    }

    function initFilterButtons() {
        const container = document.getElementById('zoneFilter');
        container.innerHTML = `<button class="btn-zone active" onclick="changeZone(this, '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï')">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</button>`;
        zones.forEach(z => {
            container.innerHTML += `<button class="btn-zone" onclick="changeZone(this, '${z}')">‡πÄ‡∏Ç‡∏ï ${z}</button>`;
        });
    }

    function changeZone(btn, zone) {
        document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(zone);
    }

    // --- Core Logic ---
    function parseNum(val) {
        if (!val) return 0;
        return parseFloat(String(val).replace(/,/g, '')) || 0;
    }

    function generateDateRange() {
        let dates = [];
        let start = new Date(1968, 11, 7); // Dec 7, 1968 (mapping CSV format)
        let end = new Date(1969, 2, 31);   // Mar 31, 1969
        let current = new Date(start);
        while (current <= end) {
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return dates;
    }

    function updateDashboard(selectedZone) {
        const dates = generateDateRange();
        
        // 1. Process Target Data
        let targetMax = 0, std1 = 0, std2 = 0, std3 = 0;
        rawTarget.forEach(row => {
            if (selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' || String(row["‡πÄ‡∏Ç‡∏ï"]).trim() === selectedZone) {
                targetMax += parseNum(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]);
                std1 += parseNum(row[" STD 14/12 "]);
                std2 += parseNum(row[" STD 5/1 "]);
                std3 += parseNum(row[" STD 21/1 "]);
            }
        });

        // 2. Prepare Target Background Series
        const targetSeries = dates.map(d => {
            const m = d.getMonth() + 1;
            const day = d.getDate();
            // 07/12 - 27/12
            if (m === 12 && day >= 7 && day <= 27) return std1;
            // 05/01 - 20/01
            if (m === 1 && day >= 5 && day <= 20) return std2;
            // 21/01 - 31/03
            if ((m === 1 && day >= 21) || m === 2 || m === 3) return std3;
            return 0; // Holiday/No target
        });

        // 3. Process Actual Daily Data
        let lastDataIdx = -1;
        const actualDaily = dates.map((d, idx) => {
            const colName = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}/${d.getFullYear()}`;
            let sum = 0;
            rawActual.forEach(row => {
                if (selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' || String(row["‡πÄ‡∏Ç‡∏ï"]).trim() === selectedZone) {
                    sum += parseNum(row[colName]);
                }
            });
            if (sum > 0) lastDataIdx = idx;
            return sum;
        });

        // 4. Accumulated and Projection
        let accSum = 0;
        const actualAcc = [];
        for (let i = 0; i <= lastDataIdx; i++) {
            accSum += actualDaily[i];
            actualAcc.push(accSum);
        }

        const projectionLine = new Array(actualAcc.length - 1).fill(null);
        projectionLine.push(accSum);

        if (lastDataIdx < dates.length - 1) {
            const remainingTarget = targetMax - accSum;
            const remainingDays = dates.length - 1 - lastDataIdx;
            const dailyProj = remainingTarget / remainingDays;
            
            let tempAcc = accSum;
            for (let i = lastDataIdx + 1; i < dates.length; i++) {
                tempAcc += dailyProj;
                projectionLine.push(tempAcc);
            }
        }

        // Update Cards
        document.getElementById('cardTarget').innerText = targetMax.toLocaleString();
        document.getElementById('cardAcc').innerText = accSum.toLocaleString();
        document.getElementById('cardPercent').innerText = ((accSum / (targetMax || 1)) * 100).toFixed(2) + "%";
        document.getElementById('cardRemain').innerText = Math.max(0, targetMax - accSum).toLocaleString();

        renderChart(dates, targetSeries, actualDaily, actualAcc, projectionLine);
    }

    function renderChart(dates, targets, daily, acc, proj) {
        const labels = dates.map(d => d.toLocaleDateString('th-TH', {day:'numeric', month:'short'}));
        const ctx = document.getElementById('sugarChart').getContext('2d');
        
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: '‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á',
                        data: acc,
                        borderColor: '#27ae60',
                        backgroundColor: '#27ae60',
                        borderWidth: 3,
                        yAxisID: 'yAcc',
                        pointRadius: 0,
                        order: 1
                    },
                    {
                        type: 'line',
                        label: '‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏™‡∏∞‡∏™‡∏°',
                        data: proj,
                        borderColor: '#27ae60',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        yAxisID: 'yAcc',
                        fill: false,
                        order: 2
                    },
                    {
                        type: 'bar',
                        label: '‡∏¢‡∏≠‡∏î‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô',
                        data: daily,
                        backgroundColor: '#3498db',
                        yAxisID: 'yDaily',
                        order: 3
                    },
                    {
                        type: 'bar',
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (STD)',
                        data: targets,
                        backgroundColor: 'rgba(200, 200, 200, 0.2)',
                        barPercentage: 1,
                        categoryPercentage: 1,
                        yAxisID: 'yDaily',
                        order: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    yDaily: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' },
                        beginAtZero: true
                    },
                    yAcc: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°' },
                        grid: { drawOnChartArea: false },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function exportImage() {
        const dashboard = document.getElementById('dashboardNode');
        html2canvas(dashboard, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Sugar_Cane_Report_6869.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }
</script>
</body>
</html>
