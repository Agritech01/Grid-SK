<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡πâ‡∏≠‡∏¢ - Dashboard</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --purple: #9b59b6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Kanit', 'Sarabun', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        /* Header */
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-title h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .header-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-box {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #f1c40f;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        /* Main Content */
        .dashboard-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 800px;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--light);
            padding: 30px 0;
            border-right: 1px solid #ddd;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            padding: 20px 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            border-left: 5px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .nav-item.active {
            background: rgba(52, 152, 219, 0.15);
            border-left-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }
        
        .nav-icon {
            font-size: 20px;
            width: 30px;
            text-align: center;
        }
        
        /* Main Panel */
        .main-panel {
            padding: 30px;
            overflow-y: auto;
            max-height: 800px;
        }
        
        .panel-title {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title span {
            color: var(--secondary);
        }
        
        /* Upload Panel */
        .upload-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        
        .upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .upload-card {
            background: var(--light);
            border-radius: 10px;
            padding: 25px;
            border: 2px dashed #bdc3c7;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .upload-card.required {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.05);
        }
        
        .upload-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--secondary);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            background: var(--secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .required .card-icon {
            background: var(--danger);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .required-tag {
            background: var(--danger);
            color: white;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            position: absolute;
            top: -10px;
            right: 15px;
        }
        
        .file-info {
            color: var(--gray);
            font-size: 14px;
            margin-top: 10px;
        }
        
        .file-info ul {
            margin: 10px 0 0 20px;
        }
        
        .file-info li {
            margin-bottom: 5px;
        }
        
        .file-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #bdc3c7;
        }
        
        .status-indicator.uploaded {
            background: var(--success);
        }
        
        .upload-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #2980b9);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--primary);
        }
        
        .btn-secondary:hover {
            background: #d5dbdb;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #229954);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #e67e22);
            color: white;
        }
        
        /* Analysis Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
        }
        
        .metric-card.green::before { background: var(--success); }
        .metric-card.blue::before { background: var(--secondary); }
        .metric-card.orange::before { background: var(--warning); }
        .metric-card.red::before { background: var(--danger); }
        .metric-card.purple::before { background: var(--purple); }
        
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .metric-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* Heatmap Grid */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            color: white;
            font-size: 12px;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .heatmap-cell.green { background: var(--success); }
        .heatmap-cell.blue { background: var(--secondary); }
        .heatmap-cell.orange { background: var(--warning); }
        .heatmap-cell.red { background: var(--danger); }
        .heatmap-cell.gray { background: var(--gray); }
        
        /* Grid Details */
        .grid-details-header {
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .grid-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 16px;
            width: 200px;
        }
        
        .grid-selector option {
            color: var(--primary);
        }
        
        .grid-info-container {
            background: white;
            border-radius: 0 0 15px 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .info-item {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
        }
        
        .info-label {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Critical Plots */
        .critical-plots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .plot-card {
            background: white;
            border: 2px solid var(--danger);
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .plot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.2);
        }
        
        .season-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .season-6768 { background: #3498db; color: white; }
        .season-6869 { background: #9b59b6; color: white; }
        
        /* Unmatched Plots */
        .unmatched-plots-container {
            margin: 30px 0;
        }
        
        .unmatched-plot-card {
            background: white;
            border: 2px solid var(--warning);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Data Inconsistency */
        .inconsistency-item {
            background: rgba(243, 156, 18, 0.1);
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        
        /* Alert Container */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .alert {
            background: white;
            border-left: 5px solid var(--success);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .alert.show {
            transform: translateX(0);
        }
        
        .alert.error { border-left-color: var(--danger); }
        .alert.warning { border-left-color: var(--warning); }
        .alert.info { border-left-color: var(--secondary); }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: #ddd;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, var(--secondary), var(--purple));
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .upload-grid {
                grid-template-columns: 1fr;
            }
            
            .header-stats {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-stats {
                width: 100%;
                justify-content: center;
            }
            
            .stat-box {
                flex: 1;
                min-width: 140px;
            }
            
            .upload-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .heatmap-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
            
            .grid-details-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .grid-selector {
                width: 100%;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color: white; margin-left: 20px;">
            <h3 id="loadingTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h3>
            <p id="loadingMessage">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
            <div class="progress-container" style="width: 300px; margin-top: 20px;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Data Inconsistency -->
    <div class="modal-overlay" id="inconsistencyModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--warning);">
                    <i class="fas fa-exclamation-triangle"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
                </h2>
                <button onclick="closeModal('inconsistencyModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">
                    &times;
                </button>
            </div>
            <div id="inconsistencyContent"></div>
            <div style="margin-top: 30px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('inconsistencyModal')">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Unmatched Plots -->
    <div class="modal-overlay" id="unmatchedModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--warning);">
                    <i class="fas fa-unlink"></i> ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                </h2>
                <button onclick="closeModal('unmatchedModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray);">
                    &times;
                </button>
            </div>
            <div id="unmatchedContent"></div>
            <div style="margin-top: 30px; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('unmatchedModal')">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-title">
                <div style="font-size: 32px;">üåæ</div>
                <div>
                    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡πâ‡∏≠‡∏¢</h1>
                    <p style="opacity: 0.9;">Dashboard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</p>
                </div>
            </div>
            
            <div class="header-stats">
                <div class="stat-box">
                    <div class="stat-value" id="headerGrids">0</div>
                    <div class="stat-label">Grid ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="headerPlots">0</div>
                    <div class="stat-label">‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="headerProblems">0</div>
                    <div class="stat-label">‡πÅ‡∏õ‡∏•‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="headerYield">0</div>
                    <div class="stat-label">‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="dashboard-content">
            <!-- Sidebar Navigation -->
            <div class="sidebar">
                <ul class="nav-menu">
                    <li class="nav-item active" onclick="showPanel('upload')">
                        <div class="nav-icon">üìÅ</div>
                        <div>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</div>
                    </li>
                    <li class="nav-item" onclick="showPanel('analysis')">
                        <div class="nav-icon">üìä</div>
                        <div>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Dashboard</div>
                    </li>
                    <li class="nav-item" onclick="showPanel('heatmap')">
                        <div class="nav-icon">üó∫Ô∏è</div>
                        <div>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô</div>
                    </li>
                    <li class="nav-item" onclick="showPanel('gridDetails')">
                        <div class="nav-icon">üîç</div>
                        <div>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Grid</div>
                    </li>
                    <li class="nav-item" onclick="showPanel('reports')">
                        <div class="nav-icon">üìà</div>
                        <div>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</div>
                    </li>
                </ul>
                
                <div style="padding: 30px; border-top: 1px solid #ddd; margin-top: 20px;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</h4>
                    <ul style="list-style: none; font-size: 14px; color: var(--gray);">
                        <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            ‡πÑ‡∏ü‡∏•‡πå GRID ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏°‡∏≠
                        </li>
                        <li style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            ‡πÑ‡∏ü‡∏•‡πå KAT ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå
                        </li>
                        <li style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á 2 ‡πÑ‡∏ü‡∏•‡πå KAT
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Main Panel Content -->
            <div class="main-panel">
                <!-- Upload Panel -->
                <div id="uploadPanel" class="panel active">
                    <div class="panel-title">
                        <span>üìÅ</span> ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                    
                    <div class="upload-container">
                        <div class="upload-grid">
                            <!-- GRID File -->
                            <div class="upload-card required" onclick="openFilePicker('gridFile')">
                                <div class="required-tag">‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</div>
                                <div class="card-header">
                                    <div class="card-icon">
                                        <i class="fas fa-map"></i>
                                    </div>
                                    <div>
                                        <div class="card-title">‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GRID</div>
                                        <div class="file-info">
                                            <strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
                                            <ul>
                                                <li><strong>Grid</strong> (‡∏£‡∏´‡∏±‡∏™ Grid)</li>
                                                <li><strong>landno</strong> (‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô)</li>
                                            </ul>
                                            <em>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</em>
                                        </div>
                                    </div>
                                </div>
                                <div class="file-status">
                                    <div class="status-indicator" id="gridStatus"></div>
                                    <span id="gridFileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                                </div>
                                <input type="file" id="gridFile" accept=".csv" style="display: none;" onchange="handleFileSelect('grid', this)">
                            </div>
                            
                            <!-- KAT 67/68 File -->
                            <div class="upload-card" onclick="openFilePicker('kat6768File')">
                                <div class="card-header">
                                    <div class="card-icon" style="background: #3498db;">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                    <div>
                                        <div class="card-title">‡πÑ‡∏ü‡∏•‡πå KAT 67/68</div>
                                        <div class="file-info">
                                            <strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
                                            <ul>
                                                <li><strong>‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech</strong> (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà)</li>
                                                <li><strong>‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà</strong> (‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï)</li>
                                                <li><strong>‡πÄ‡∏Ç‡∏ï</strong> (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)</li>
                                                <li><strong>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</strong></li>
                                                <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£</strong></li>
                                                <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</strong></li>
                                                <li><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢</strong></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="file-status">
                                    <div class="status-indicator" id="kat6768Status"></div>
                                    <span id="kat6768FileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                                </div>
                                <input type="file" id="kat6768File" accept=".csv" style="display: none;" onchange="handleFileSelect('kat6768', this)">
                            </div>
                            
                            <!-- KAT 68/69 File -->
                            <div class="upload-card" onclick="openFilePicker('kat6869File')">
                                <div class="card-header">
                                    <div class="card-icon" style="background: #9b59b6;">
                                        <i class="fas fa-calendar-check"></i>
                                    </div>
                                    <div>
                                        <div class="card-title">‡πÑ‡∏ü‡∏•‡πå KAT 68/69</div>
                                        <div class="file-info">
                                            <strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
                                            <ul>
                                                <li><strong>‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech</strong> (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà)</li>
                                                <li><strong>‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà</strong> (‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï)</li>
                                                <li><strong>‡πÄ‡∏Ç‡∏ï</strong> (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà)</li>
                                                <li><strong>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</strong></li>
                                                <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£</strong></li>
                                                <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</strong></li>
                                                <li><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢</strong></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="file-status">
                                    <div class="status-indicator" id="kat6869Status"></div>
                                    <span id="kat6869FileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                                </div>
                                <input type="file" id="kat6869File" accept=".csv" style="display: none;" onchange="handleFileSelect('kat6869', this)">
                            </div>
                        </div>
                        
                        <div class="upload-actions">
                            <button class="btn btn-secondary" onclick="clearAllFiles()">
                                <i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button class="btn btn-primary" onclick="validateAndAnalyze()">
                                <i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Dashboard -->
                <div id="analysisPanel" class="panel" style="display: none;">
                    <div class="panel-title">
                        <span>üìä</span> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° Dashboard
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="dashboard-grid">
                        <div class="metric-card green">
                            <div class="metric-value" id="totalGridCount">0</div>
                            <div class="metric-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Grid ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå GRID
                            </div>
                        </div>
                        
                        <div class="metric-card blue">
                            <div class="metric-value" id="kat6768Plots">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô KAT 67/68</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                <span id="kat6768Matched">0</span> ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ
                            </div>
                        </div>
                        
                        <div class="metric-card blue">
                            <div class="metric-value" id="kat6869Plots">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô KAT 68/69</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                <span id="kat6869Matched">0</span> ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ
                            </div>
                        </div>
                        
                        <div class="metric-card orange">
                            <div class="metric-value" id="matchedPlots">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                <span id="matchRate">0%</span> ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
                            </div>
                        </div>
                        
                        <div class="metric-card red">
                            <div class="metric-value" id="criticalPlots">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà
                            </div>
                        </div>
                        
                        <div class="metric-card green">
                            <div class="metric-value" id="avgYield">0.0</div>
                            <div class="metric-label">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà
                            </div>
                        </div>
                        
                        <div class="metric-card purple" onclick="showUnmatchedModal()" style="cursor: pointer;">
                            <div class="metric-value" id="unmatchedPlots">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>
                            <div style="margin-top: 15px; font-size: 14px; color: var(--gray);">
                                ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Summary -->
                    <div class="upload-container">
                        <h3 style="color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: var(--secondary);"></i>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 15px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå GRID</h4>
                                <div id="gridSummary" style="color: var(--gray); font-size: 14px; line-height: 1.6;">
                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="color: var(--primary); margin-bottom: 15px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå KAT</h4>
                                <div id="katSummary" style="color: var(--gray); font-size: 14px; line-height: 1.6;">
                                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding: 20px; background: #e8f4fc; border-radius: 10px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
                                ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÉ‡∏´‡∏°‡πà)
                            </h4>
                            <p style="color: var(--gray); line-height: 1.6;">
                                1. ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå <strong>GRID</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mapping ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: Grid ‚Üí landno<br>
                                2. ‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå <strong>KAT</strong> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô<br>
                                3. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà: '‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech' (KAT) ‡∏Å‡∏±‡∏ö 'landno' (GRID)<br>
                                4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ: ‡∏î‡∏∂‡∏á Grid ID ‡∏à‡∏≤‡∏Å GRID + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å KAT<br>
                                5. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡πÄ‡∏Ç‡∏ï, ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£, ‡∏Ø‡∏•‡∏Ø) ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå KAT ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
                                6. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Grid ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                            </p>
                        </div>
                        
                        <!-- Data Inconsistency Section -->
                        <div id="inconsistencySection" style="display: none; margin-top: 30px;">
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; border-left: 5px solid var(--warning);">
                                <h4 style="color: var(--warning); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
                                    <button class="btn btn-warning" style="padding: 5px 15px; font-size: 12px; margin-left: auto;" onclick="showInconsistencyModal()">
                                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                    </button>
                                </h4>
                                <div id="inconsistencySummary" style="color: var(--gray);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Heatmap Panel -->
                <div id="heatmapPanel" class="panel" style="display: none;">
                    <div class="panel-title">
                        <span>üó∫Ô∏è</span> ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï
                    </div>
                    
                    <div class="upload-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <div>
                                <h3 style="color: var(--primary);">‡πÅ‡∏™‡∏î‡∏á Grid ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏£‡∏î‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h3>
                                <p style="color: var(--gray); margin-top: 5px;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Grid ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn" style="background: var(--success); color: white;" onclick="filterHeatmap('all')">
                                    ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                                <button class="btn" style="background: var(--success); color: white;" onclick="filterHeatmap('high')">
                                    üü¢ ‡∏™‡∏π‡∏á (>15)
                                </button>
                                <button class="btn" style="background: #f1c40f; color: white;" onclick="filterHeatmap('medium')">
                                    üü° ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (10-15)
                                </button>
                                <button class="btn" style="background: var(--warning); color: white;" onclick="filterHeatmap('improve')">
                                    üü† ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (7-10)
                                </button>
                                <button class="btn" style="background: var(--danger); color: white;" onclick="filterHeatmap('low')">
                                    üî¥ ‡∏ï‡πà‡∏≥ (<7)
                                </button>
                            </div>
                        </div>
                        
                        <div class="heatmap-grid" id="heatmapContainer">
                            <!-- Heatmap cells will be generated here -->
                            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                                <i class="fas fa-map" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô</h3>
                                <p>‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <div style="width: 20px; height: 20px; background: var(--success); border-radius: 4px;"></div>
                                    <div style="font-weight: 600; color: var(--primary);">‡∏™‡∏π‡∏á (>15 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà)</div>
                                </div>
                                <div id="highCount" style="font-size: 24px; font-weight: 700; color: var(--success);">0</div>
                            </div>
                            
                            <div style="background: rgba(241, 196, 15, 0.1); padding: 15px; border-radius: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <div style="width: 20px; height: 20px; background: #f1c40f; border-radius: 4px;"></div>
                                    <div style="font-weight: 600; color: var(--primary);">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (10-15)</div>
                                </div>
                                <div id="mediumCount" style="font-size: 24px; font-weight: 700; color: #f1c40f;">0</div>
                            </div>
                            
                            <div style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <div style="width: 20px; height: 20px; background: var(--warning); border-radius: 4px;"></div>
                                    <div style="font-weight: 600; color: var(--primary);">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (7-10)</div>
                                </div>
                                <div id="improveCount" style="font-size: 24px; font-weight: 700; color: var(--warning);">0</div>
                            </div>
                            
                            <div style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <div style="width: 20px; height: 20px; background: var(--danger); border-radius: 4px;"></div>
                                    <div style="font-weight: 600; color: var(--primary);">‡∏ï‡πà‡∏≥ (<7)</div>
                                </div>
                                <div id="lowCount" style="font-size: 24px; font-weight: 700; color: var(--danger);">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grid Details Panel -->
                <div id="gridDetailsPanel" class="panel" style="display: none;">
                    <div class="panel-title">
                        <span>üîç</span> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Grid
                    </div>
                    
                    <div class="grid-details-header">
                        <div>
                            <h3 style="color: white;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Grid ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                            <p style="opacity: 0.9; margin-top: 5px;">‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</p>
                        </div>
                        
                        <select class="grid-selector" id="gridSelector" onchange="loadGridDetails(this.value)">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Grid --</option>
                        </select>
                    </div>
                    
                    <div class="grid-info-container">
                        <div id="gridDetailsContent">
                            <div style="text-align: center; padding: 50px; color: var(--gray);">
                                <i class="fas fa-map-marked-alt" style="font-size: 64px; margin-bottom: 20px;"></i>
                                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Grid</h3>
                                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Grid ‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Panel -->
                <div id="reportsPanel" class="panel" style="display: none;">
                    <div class="panel-title">
                        <span>üìà</span> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="metric-card blue">
                            <div class="metric-value" id="reportGrids">0</div>
                            <div class="metric-label">Grid ‡∏ó‡∏µ‡πà‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß</div>
                        </div>
                        
                        <div class="metric-card orange">
                            <div class="metric-value" id="reportProblems">0</div>
                            <div class="metric-label">Grid ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
                        </div>
                        
                        <div class="metric-card red">
                            <div class="metric-value" id="reportCritical">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        
                        <div class="metric-card purple">
                            <div class="metric-value" id="reportUnmatched">0</div>
                            <div class="metric-label">‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>
                        </div>
                    </div>
                    
                    <div class="upload-container">
                        <h3 style="color: var(--primary); margin-bottom: 20px;">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</h3>
                        
                        <div id="recommendations" style="line-height: 1.6;">
                            <!-- Dynamic recommendations will be loaded here -->
                            <div style="text-align: center; padding: 50px; color: var(--gray);">
                                <i class="fas fa-chart-line" style="font-size: 64px; margin-bottom: 20px;"></i>
                                <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</p>
                            </div>
                        </div>
                        
                        <!-- Trend Analysis -->
                        <div id="trendAnalysisSection" style="margin-top: 30px; display: none;">
                            <h4 style="color: var(--primary); margin-bottom: 15px;">
                                <i class="fas fa-chart-line"></i> ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°
                            </h4>
                            <div id="trendAnalysisContent" style="background: var(--light); padding: 20px; border-radius: 10px;">
                                <!-- Trend analysis will be loaded here -->
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-success" onclick="exportPDFReport()">
                                <i class="fas fa-file-pdf"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF
                            </button>
                            <button class="btn btn-primary" onclick="exportExcelReport()">
                                <i class="fas fa-file-excel"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel
                            </button>
                            <button class="btn btn-secondary" onclick="saveSession()">
                                <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session
                            </button>
                            <button class="btn btn-secondary" onclick="loadSession()">
                                <i class="fas fa-folder-open"></i> ‡πÇ‡∏´‡∏•‡∏î Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Global Variables
        let uploadedFiles = {
            grid: null,
            kat6768: null,
            kat6869: null
        };
        
        let analysisData = null;
        let currentPanel = 'upload';
        let currentHeatmapFilter = 'all';
        let sessionId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check for saved session
            const savedSession = localStorage.getItem('sugarcaneAnalysisSession');
            if (savedSession) {
                if (confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    loadSavedSession(JSON.parse(savedSession));
                }
            }
            
            showPanel('upload');
        });
        
        // Alert System
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${type}`;
            alertDiv.id = alertId;
            alertDiv.innerHTML = `
                <div>
                    <i class="fas ${type === 'error' ? 'fa-times-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-check-circle'}" 
                       style="font-size: 24px; color: ${type === 'error' ? 'var(--danger)' : type === 'warning' ? 'var(--warning)' : 'var(--success)'};"></i>
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--primary);">${type === 'error' ? '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : type === 'warning' ? '‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô' : '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}</div>
                    <div style="color: var(--gray); margin-top: 5px;">${message}</div>
                </div>
                <button onclick="closeAlert('${alertId}')" style="background: none; border: none; color: var(--gray); cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                closeAlert(alertId);
            }, 5000);
        }
        
        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 500);
            }
        }
        
        // Panel Navigation
        function showPanel(panelId) {
            document.querySelectorAll('.panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(panelId + 'Panel').style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                const panelOrder = ['upload', 'analysis', 'heatmap', 'gridDetails', 'reports'];
                if (panelOrder[index] === panelId) {
                    item.classList.add('active');
                }
            });
            
            currentPanel = panelId;
            
            if (panelId === 'analysis' && analysisData) {
                updateAnalysisDashboard();
            } else if (panelId === 'heatmap' && analysisData) {
                renderHeatmap();
            } else if (panelId === 'reports' && analysisData) {
                updateReports();
            }
        }
        
        // File Handling
        function openFilePicker(fileId) {
            document.getElementById(fileId).click();
        }
        
        function handleFileSelect(fileType, input) {
            const file = input.files[0];
            if (!file) return;
            
            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô 100MB
            if (file.size > 100 * 1024 * 1024) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 100MB limit
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                showAlert(`‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${fileSizeMB} MB) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 100MB`, 'error');
                input.value = '';
                return;
            }
            
            uploadedFiles[fileType] = file;
            
            const fileNameElement = document.getElementById(fileType + 'FileName');
            const statusElement = document.getElementById(fileType + 'Status');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            fileNameElement.textContent = `${file.name} (${fileSizeMB} MB)`;
            fileNameElement.style.color = 'var(--primary)';
            fileNameElement.style.fontWeight = '600';
            
            statusElement.classList.add('uploaded');
            
            showAlert(`‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${getFileTypeName(fileType)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${file.name} (${fileSizeMB} MB)`, 'info');
            
            readFileData(file, fileType);
        }
        
        function getFileTypeName(fileType) {
            const names = {
                'grid': 'GRID',
                'kat6768': 'KAT 67/68',
                'kat6869': 'KAT 68/69'
            };
            return names[fileType] || fileType;
        }
        
        function readFileData(file, fileType) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').filter(line => line.trim() !== '');
                    
                    if (lines.length === 0) {
                        showAlert(`‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`, 'warning');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    const rowCount = Math.max(0, lines.length - 1);
                    
                    const sampleData = {};
                    if (lines.length > 1) {
                        const firstRow = lines[1].split(',');
                        headers.forEach((header, index) => {
                            if (index < firstRow.length) {
                                sampleData[header] = firstRow[index].trim();
                            }
                        });
                    }
                    
                    updateFileSummary(fileType, headers, rowCount, sampleData);
                    
                } catch (error) {
                    console.error('Error reading file:', error);
                    showAlert(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showAlert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name}`, 'error');
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        function updateFileSummary(fileType, headers, rowCount, sampleData) {
            let summary = '';
            
            if (fileType === 'grid') {
                summary = `
                    <div style="margin-bottom: 10px;">
                        <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ${rowCount} ‡πÅ‡∏ñ‡∏ß
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong> ${headers.join(', ')}
                    </div>
                    <div style="color: ${headers.includes('Grid') && headers.includes('landno') ? 'var(--success)' : 'var(--danger)'};">
                        <i class="fas fa-${headers.includes('Grid') && headers.includes('landno') ? 'check' : 'times'}"></i>
                        ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå: ${headers.includes('Grid') && headers.includes('landno') ? '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'}
                    </div>
                `;
                document.getElementById('gridSummary').innerHTML = summary;
            } else {
                const season = fileType === 'kat6768' ? '67/68' : '68/69';
                const requiredColumns = ['‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech', '‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà'];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                
                summary = `
                    <div style="margin-bottom: 10px;">
                        <strong>‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•:</strong> ${season}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏õ‡∏•‡∏á:</strong> ${rowCount} ‡πÅ‡∏õ‡∏•‡∏á
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö:</strong> ${headers.join(', ')}
                    </div>
                `;
                
                if (missingColumns.length > 0) {
                    summary += `
                        <div style="color: var(--warning); margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î:</strong> ${missingColumns.join(', ')}
                        </div>
                    `;
                } else {
                    summary += `
                        <div style="color: var(--success); margin-top: 10px;">
                            <i class="fas fa-check"></i>
                            ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
                        </div>
                    `;
                }
                
                if (rowCount > 0) {
                    summary += `
                        <div style="margin-top: 15px; background: rgba(155, 89, 182, 0.1); padding: 10px; border-radius: 6px;">
                            <strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á:</strong>
                            <div style="margin-top: 5px; font-size: 13px;">
                                ${Object.entries(sampleData).slice(0, 5).map(([key, value]) => 
                                    `<div><strong>${key}:</strong> ${value || '-'}</div>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }
                
                const katSummary = document.getElementById('katSummary');
                if (katSummary.innerHTML.includes('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå')) {
                    katSummary.innerHTML = '';
                }
                
                katSummary.innerHTML += `<div style="margin-bottom: 20px;">${summary}</div>`;
            }
        }
        
        function clearAllFiles() {
            ['gridFile', 'kat6768File', 'kat6869File'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            ['grid', 'kat6768', 'kat6869'].forEach(type => {
                document.getElementById(type + 'FileName').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
                document.getElementById(type + 'FileName').style.color = '';
                document.getElementById(type + 'FileName').style.fontWeight = '';
                document.getElementById(type + 'Status').classList.remove('uploaded');
            });
            
            uploadedFiles = { grid: null, kat6768: null, kat6869: null };
            
            document.getElementById('gridSummary').innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå';
            document.getElementById('katSummary').innerHTML = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå';
            
            analysisData = null;
            
            showAlert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }
        
        // Validation and Analysis
        async function validateAndAnalyze() {
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå...', 10);
            
            try {
                if (!uploadedFiles.grid) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GRID (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)');
                }
                
                if (!uploadedFiles.kat6768 && !uploadedFiles.kat6869) {
                    throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå KAT ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå (67/68 ‡∏´‡∏£‡∏∑‡∏≠ 68/69)');
                }
                
                updateProgress(30, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå...');
                
                const gridData = await readCSVFile(uploadedFiles.grid);
                const kat6768Data = uploadedFiles.kat6768 ? await readCSVFile(uploadedFiles.kat6768) : null;
                const kat6869Data = uploadedFiles.kat6869 ? await readCSVFile(uploadedFiles.kat6869) : null;
                
                updateProgress(50, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                validateFileStructures(gridData, kat6768Data, kat6869Data);
                
                updateProgress(70, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                analysisData = await analyzeData(gridData, kat6768Data, kat6869Data);
                
                updateProgress(90, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•...');
                
                hideLoading();
                showAlert('‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', 'info');
                
                showPanel('analysis');
                updateAnalysisDashboard();
                updateHeaderStats();
                
                saveSession();
                
            } catch (error) {
                hideLoading();
                showAlert(error.message, 'error');
                console.error('Analysis error:', error);
            }
        }
        
        function updateProgress(percent, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('loadingMessage').textContent = message;
        }
        
        async function readCSVFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim() !== '');
                        
                        if (lines.length === 0) {
                            reject(new Error(`‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`));
                            return;
                        }
                        
                        const headers = lines[0].split(',').map(h => h.trim());
                        const data = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            const row = {};
                            
                            headers.forEach((header, index) => {
                                if (index < values.length) {
                                    row[header] = values[index].trim();
                                } else {
                                    row[header] = '';
                                }
                            });
                            
                            data.push(row);
                        }
                        
                        resolve({
                            filename: file.name,
                            headers: headers,
                            data: data,
                            count: data.length
                        });
                        
                    } catch (error) {
                        reject(new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name}: ${error.message}`));
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name}`));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        function validateFileStructures(gridData, kat6768Data, kat6869Data) {
            // Validate GRID file
            if (!gridData.headers.includes('Grid')) {
                throw new Error('‡πÑ‡∏ü‡∏•‡πå GRID ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "Grid"');
            }
            
            if (!gridData.headers.includes('landno')) {
                throw new Error('‡πÑ‡∏ü‡∏•‡πå GRID ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "landno"');
            }
            
            // Validate KAT files
            const validateKatFile = (katData, season) => {
                if (katData) {
                    const requiredColumns = ['‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech', '‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà'];
                    const missingColumns = requiredColumns.filter(col => !katData.headers.includes(col));
                    
                    if (missingColumns.length > 0) {
                        throw new Error(`‡πÑ‡∏ü‡∏•‡πå KAT ${season} ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${missingColumns.join(', ')}`);
                    }
                    
                    // Check for data inconsistencies in basic info columns
                    const basicInfoColumns = ['‡πÄ‡∏Ç‡∏ï', '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£', '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£', '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢'];
                    const missingBasicInfo = basicInfoColumns.filter(col => !katData.headers.includes(col));
                    
                    if (missingBasicInfo.length > 0) {
                        showAlert(`‡πÑ‡∏ü‡∏•‡πå KAT ${season} ‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô: ${missingBasicInfo.join(', ')}`, 'warning');
                    }
                }
            };
            
            validateKatFile(kat6768Data, '67/68');
            validateKatFile(kat6869Data, '68/69');
        }
        
        async function analyzeData(gridData, kat6768Data, kat6869Data) {
            // 1. Create mapping from landno to Grid ID (from GRID file)
            const landnoToGridMap = {};
            const gridLandnoCount = {};
            
            gridData.data.forEach(row => {
                const gridId = row.Grid;
                const landno = row.landno;
                
                if (gridId && landno) {
                    landnoToGridMap[landno] = gridId;
                    
                    if (!gridLandnoCount[gridId]) {
                        gridLandnoCount[gridId] = 0;
                    }
                    gridLandnoCount[gridId]++;
                }
            });
            
            // 2. Analyze KAT data (get all data from KAT files)
            const kat6768Analysis = await analyzeKatData(kat6768Data, '67/68', landnoToGridMap);
            const kat6869Analysis = await analyzeKatData(kat6869Data, '68/69', landnoToGridMap);
            
            // 3. Combine analyses and calculate statistics
            const analysis = {
                gridCountFromGrid: Object.keys(gridLandnoCount).length,
                totalLandnos: Object.keys(landnoToGridMap).length,
                landnoToGridMap: landnoToGridMap,
                gridLandnoCount: gridLandnoCount,
                kat6768: kat6768Analysis,
                kat6869: kat6869Analysis,
                dataInconsistencies: [],
                summary: {
                    matchedPlots: 0,
                    criticalPlots: 0,
                    avgYield: 0,
                    unmatchedPlots: 0,
                    matchRate: 0,
                    gradeDistribution: {
                        high: 0,
                        medium: 0,
                        improve: 0,
                        low: 0
                    }
                },
                gridDetails: {},
                unmatchedPlotsData: []
            };
            
            // Combine unmatched plots
            analysis.unmatchedPlotsData = [
                ...kat6768Analysis.unmatchedPlotsData,
                ...kat6869Analysis.unmatchedPlotsData
            ];
            analysis.summary.unmatchedPlots = analysis.unmatchedPlotsData.length;
            
            // Calculate total matched plots
            analysis.summary.matchedPlots = kat6768Analysis.matchedPlots + kat6869Analysis.matchedPlots;
            
            // Calculate match rate
            const totalPlotsInKAT = (kat6768Data?.count || 0) + (kat6869Data?.count || 0);
            analysis.summary.matchRate = totalPlotsInKAT > 0 ? 
                (analysis.summary.matchedPlots / totalPlotsInKAT * 100) : 0;
            
            // Process each Grid from matched data
            const allGrids = new Set([
                ...Object.keys(kat6768Analysis.gridData),
                ...Object.keys(kat6869Analysis.gridData)
            ]);
            
            allGrids.forEach(gridId => {
                const kat6768Grid = kat6768Analysis.gridData[gridId] || { plots: [], critical: [], basicInfo: null };
                const kat6869Grid = kat6869Analysis.gridData[gridId] || { plots: [], critical: [], basicInfo: null };
                
                // Check for data inconsistencies between seasons
                if (kat6768Grid.basicInfo && kat6869Grid.basicInfo) {
                    checkDataInconsistency(gridId, kat6768Grid.basicInfo, kat6869Grid.basicInfo, analysis);
                }
                
                // Determine which basic info to use (prefer 68/69 if available)
                const basicInfo = kat6869Grid.basicInfo || kat6768Grid.basicInfo || {};
                
                // Combine all plots
                const allPlots = [...kat6768Grid.plots, ...kat6869Grid.plots];
                const allCritical = [...kat6768Grid.critical, ...kat6869Grid.critical];
                
                // Calculate average yield
                const yields = allPlots.map(p => p.yield).filter(y => y > 0);
                const avgYield = yields.length > 0 ? 
                    yields.reduce((a, b) => a + b, 0) / yields.length : 0;
                
                // Determine grade
                let grade = 'low';
                if (avgYield >= 15) grade = 'high';
                else if (avgYield >= 10) grade = 'medium';
                else if (avgYield >= 7) grade = 'improve';
                
                analysis.summary.gradeDistribution[grade]++;
                analysis.summary.criticalPlots += allCritical.length;
                
                // Store Grid details
                analysis.gridDetails[gridId] = {
                    gridId: gridId,
                    basicInfo: basicInfo,
                    totalLandnos: gridLandnoCount[gridId] || 0,
                    kat6768: {
                        matchedPlots: kat6768Grid.plots.length,
                        plots: kat6768Grid.plots,
                        critical: kat6768Grid.critical
                    },
                    kat6869: {
                        matchedPlots: kat6869Grid.plots.length,
                        plots: kat6869Grid.plots,
                        critical: kat6869Grid.critical
                    },
                    avgYield: avgYield,
                    grade: grade,
                    criticalPlots: allCritical,
                    allPlots: allPlots
                };
            });
            
            // Calculate overall average yield
            const allGridYields = Object.values(analysis.gridDetails)
                .map(grid => grid.avgYield)
                .filter(y => y > 0);
            
            analysis.summary.avgYield = allGridYields.length > 0 ?
                allGridYields.reduce((a, b) => a + b, 0) / allGridYields.length : 0;
            
            return analysis;
        }
        
        async function analyzeKatData(katData, season, landnoToGridMap) {
            if (!katData) {
                return {
                    season: season,
                    totalPlots: 0,
                    matchedPlots: 0,
                    unmatchedPlots: 0,
                    gridData: {},
                    unmatchedPlotsData: []
                };
            }
            
            const gridData = {};
            const unmatchedPlotsData = [];
            let matchedCount = 0;
            
            for (const row of katData.data) {
                const intechNo = row.‡πÄ‡∏•‡∏Ç‡πÅ‡∏õ‡∏•‡∏áintech;
                const gridId = landnoToGridMap[intechNo];
                
                // Create plot data object with all data from KAT
                const plotData = {
                    landno: intechNo,
                    gridId: gridId,
                    yield: parseFloat(row['‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà']) || 0,
                    area: parseFloat(row.‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà) || 0,
                    season: season,
                    zone: row.‡πÄ‡∏Ç‡∏ï || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    farmerCode: row.‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    agriculturist: row.‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£ || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    farmerName: row.‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    sugarcaneType: row.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢ || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                    quota: row.‡πÄ‡∏•‡∏Ç‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ || '',
                    source: 'KAT'
                };
                
                if (gridId) {
                    // Matched successfully
                    matchedCount++;
                    
                    if (!gridData[gridId]) {
                        gridData[gridId] = {
                            plots: [],
                            critical: [],
                            basicInfo: null
                        };
                    }
                    
                    gridData[gridId].plots.push(plotData);
                    
                    // Store basic info from first matched plot
                    if (!gridData[gridId].basicInfo) {
                        gridData[gridId].basicInfo = {
                            zone: plotData.zone,
                            farmerCode: plotData.farmerCode,
                            agriculturist: plotData.agriculturist,
                            farmerName: plotData.farmerName,
                            sugarcaneType: plotData.sugarcaneType,
                            season: season
                        };
                    }
                    
                    // Check for critical plot
                    if (plotData.yield > 0 && plotData.yield < 7) {
                        gridData[gridId].critical.push(plotData);
                    }
                    
                } else {
                    // Unmatched plot
                    unmatchedPlotsData.push(plotData);
                }
            }
            
            return {
                season: season,
                totalPlots: katData.count,
                matchedPlots: matchedCount,
                unmatchedPlots: unmatchedPlotsData.length,
                gridData: gridData,
                unmatchedPlotsData: unmatchedPlotsData
            };
        }
        
        function checkDataInconsistency(gridId, info1, info2, analysis) {
            const inconsistencies = [];
            
            const fields = ['zone', 'farmerCode', 'agriculturist', 'farmerName', 'sugarcaneType'];
            
            fields.forEach(field => {
                if (info1[field] && info2[field] && info1[field] !== info2[field]) {
                    inconsistencies.push({
                        field: field,
                        value1: info1[field],
                        value2: info2[field],
                        season1: info1.season,
                        season2: info2.season
                    });
                }
            });
            
            if (inconsistencies.length > 0) {
                analysis.dataInconsistencies.push({
                    gridId: gridId,
                    inconsistencies: inconsistencies
                });
            }
        }
        
        // Update Dashboard
        function updateAnalysisDashboard() {
            if (!analysisData) return;
            
            // Update metric cards
            document.getElementById('totalGridCount').textContent = analysisData.gridCountFromGrid;
            document.getElementById('kat6768Plots').textContent = analysisData.kat6768.totalPlots;
            document.getElementById('kat6869Plots').textContent = analysisData.kat6869.totalPlots;
            document.getElementById('kat6768Matched').textContent = analysisData.kat6768.matchedPlots;
            document.getElementById('kat6869Matched').textContent = analysisData.kat6869.matchedPlots;
            document.getElementById('matchedPlots').textContent = analysisData.summary.matchedPlots;
            document.getElementById('criticalPlots').textContent = analysisData.summary.criticalPlots;
            document.getElementById('avgYield').textContent = analysisData.summary.avgYield.toFixed(1);
            document.getElementById('unmatchedPlots').textContent = analysisData.summary.unmatchedPlots;
            document.getElementById('matchRate').textContent = analysisData.summary.matchRate.toFixed(1) + '%';
            
            // Update detailed summary
            let gridSummary = `
                <div style="margin-bottom: 15px;">
                    <strong>Grid ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${analysisData.gridCountFromGrid} Grid
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>landno ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${analysisData.totalLandnos} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:</strong> landno ‚Üí Grid ID mapping
                </div>
                <div style="color: var(--success);">
                    <i class="fas fa-check"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                </div>
            `;
            
            document.getElementById('gridSummary').innerHTML = gridSummary;
            
            // Update KAT summary
            let katSummary = `
                <div style="margin-bottom: 15px;">
                    <strong>KAT 67/68:</strong> ${analysisData.kat6768.totalPlots} ‡πÅ‡∏õ‡∏•‡∏á
                    (‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ ${analysisData.kat6768.matchedPlots} ‡πÅ‡∏õ‡∏•‡∏á)
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>KAT 68/69:</strong> ${analysisData.kat6869.totalPlots} ‡πÅ‡∏õ‡∏•‡∏á
                    (‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ ${analysisData.kat6869.matchedPlots} ‡πÅ‡∏õ‡∏•‡∏á)
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ:</strong> ${analysisData.summary.matchedPlots} ‡πÅ‡∏õ‡∏•‡∏á
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà:</strong> ${analysisData.summary.matchRate.toFixed(1)}%
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï:</strong> ${analysisData.summary.criticalPlots} ‡πÅ‡∏õ‡∏•‡∏á
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:</strong> ${analysisData.summary.unmatchedPlots} ‡πÅ‡∏õ‡∏•‡∏á
                </div>
            `;
            
            // Show data inconsistencies if any
            if (analysisData.dataInconsistencies.length > 0) {
                document.getElementById('inconsistencySection').style.display = 'block';
                document.getElementById('inconsistencySummary').innerHTML = `
                    ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ${analysisData.dataInconsistencies.length} Grid
                    <button class="btn btn-warning" style="padding: 2px 10px; font-size: 11px; margin-left: 10px;" onclick="showInconsistencyModal()">
                        ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                    </button>
                `;
            }
            
            document.getElementById('katSummary').innerHTML = katSummary;
        }
        
        function updateHeaderStats() {
            if (!analysisData) return;
            
            document.getElementById('headerGrids').textContent = Object.keys(analysisData.gridDetails).length;
            document.getElementById('headerPlots').textContent = analysisData.summary.matchedPlots;
            document.getElementById('headerProblems').textContent = analysisData.summary.criticalPlots;
            document.getElementById('headerYield').textContent = analysisData.summary.avgYield.toFixed(1);
        }
        
        // Heatmap Functions
        function renderHeatmap() {
            if (!analysisData) return;
            
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            const gradeCounts = {
                high: 0,
                medium: 0,
                improve: 0,
                low: 0
            };
            
            // Create heatmap cells
            Object.values(analysisData.gridDetails).forEach(grid => {
                if (currentHeatmapFilter !== 'all' && grid.grade !== currentHeatmapFilter) {
                    return;
                }
                
                const cell = document.createElement('div');
                cell.className = `heatmap-cell ${grid.grade}`;
                cell.textContent = grid.gridId;
                cell.title = `${grid.gridId}: ${grid.avgYield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà (${getGradeThai(grid.grade)})`;
                
                cell.onclick = () => {
                    showPanel('gridDetails');
                    document.getElementById('gridSelector').value = grid.gridId;
                    loadGridDetails(grid.gridId);
                };
                
                container.appendChild(cell);
                gradeCounts[grid.grade]++;
            });
            
            // If no cells after filtering
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-filter" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <h3>‡πÑ‡∏°‡πà‡∏û‡∏ö Grid ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</h3>
                        <p>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Grid ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    </div>
                `;
            }
            
            // Update grade counts
            document.getElementById('highCount').textContent = gradeCounts.high;
            document.getElementById('mediumCount').textContent = gradeCounts.medium;
            document.getElementById('improveCount').textContent = gradeCounts.improve;
            document.getElementById('lowCount').textContent = gradeCounts.low;
        }
        
        function getGradeThai(grade) {
            const grades = {
                'high': '‡∏™‡∏π‡∏á',
                'medium': '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
                'improve': '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',
                'low': '‡∏ï‡πà‡∏≥'
            };
            return grades[grade] || grade;
        }
        
        function filterHeatmap(grade) {
            currentHeatmapFilter = grade;
            renderHeatmap();
            showAlert(`‡πÅ‡∏™‡∏î‡∏á Grid ‡πÄ‡∏Å‡∏£‡∏î: ${grade === 'all' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : getGradeThai(grade)}`, 'info');
        }
        
        // Grid Details Functions
        function loadGridDetails(gridId) {
            if (!analysisData || !analysisData.gridDetails[gridId]) {
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Grid ‡∏ô‡∏µ‡πâ', 'error');
                return;
            }
            
            const grid = analysisData.gridDetails[gridId];
            const content = document.getElementById('gridDetailsContent');
            
            // Get grade color and icon
            const gradeConfig = {
                high: { color: '#27ae60', icon: 'üü¢', label: '‡∏™‡∏π‡∏á' },
                medium: { color: '#f1c40f', icon: 'üü°', label: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' },
                improve: { color: '#f39c12', icon: 'üü†', label: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á' },
                low: { color: '#e74c3c', icon: 'üî¥', label: '‡∏ï‡πà‡∏≥' }
            };
            
            const grade = gradeConfig[grid.grade];
            
            // Build HTML
            let html = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h2 style="color: var(--primary);">Grid: ${grid.gridId}</h2>
                            <p style="color: var(--gray);">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå KAT</p>
                        </div>
                        <div style="background: ${grade.color}; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600;">
                            ${grade.icon} ‡πÄ‡∏Å‡∏£‡∏î: ${grade.label} (${grid.avgYield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà)
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>
                            <div class="info-value">${grid.basicInfo.zone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</div>
                            <div class="info-value">${grid.basicInfo.farmerCode || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£</div>
                            <div class="info-value">${grid.basicInfo.agriculturist || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà</div>
                            <div class="info-value">${grid.basicInfo.farmerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢</div>
                            <div class="info-value">${grid.basicInfo.sugarcaneType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                            <div class="info-value">KAT ${grid.basicInfo.season || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: var(--gray);">landno ‡πÉ‡∏ô Grid</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${grid.totalLandnos || 0}</div>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå GRID</div>
                        </div>
                        
                        <div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: var(--gray);">‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${grid.allPlots.length}</div>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                                KAT 67/68: ${grid.kat6768.matchedPlots}<br>
                                KAT 68/69: ${grid.kat6869.matchedPlots}
                            </div>
                        </div>
                        
                        <div style="background: rgba(231, 76, 60, 0.1); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: var(--gray);">‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--danger);">${grid.criticalPlots.length}</div>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                                ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà
                            </div>
                        </div>
                        
                        <div style="background: rgba(39, 174, 96, 0.1); padding: 20px; border-radius: 10px;">
                            <div style="font-size: 14px; color: var(--gray);">‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--success);">${grid.avgYield.toFixed(1)}</div>
                            <div style="font-size: 12px; color: var(--gray); margin-top: 5px;">
                                ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Show critical plots if any
            if (grid.criticalPlots.length > 0) {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--danger); margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle"></i> ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà)
                        </h3>
                        <div class="critical-plots-grid">
                `;
                
                grid.criticalPlots.forEach((plot, index) => {
                    html += `
                        <div class="plot-card">
                            <div class="season-badge ${plot.season === '67/68' ? 'season-6768' : 'season-6869'}">
                                ‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• ${plot.season}
                            </div>
                            <div style="font-weight: 600; color: var(--primary); margin-bottom: 5px;">‡πÅ‡∏õ‡∏•‡∏á ${plot.landno}</div>
                            <div style="color: var(--danger); font-size: 24px; font-weight: 700; margin: 10px 0;">${plot.yield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà</div>
                            <div style="color: var(--gray); font-size: 14px;">
                                <div>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${plot.area} ‡πÑ‡∏£‡πà</div>
                                <div>‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤: ${plot.quota}</div>
                                <div>‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ${plot.farmerName}</div>
                                <div>‡πÄ‡∏Ç‡∏ï: ${plot.zone}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            
            // Populate grid selector
            const selector = document.getElementById('gridSelector');
            if (selector.options.length <= 1) {
                Object.keys(analysisData.gridDetails).forEach(gId => {
                    if (!Array.from(selector.options).some(opt => opt.value === gId)) {
                        const option = document.createElement('option');
                        option.value = gId;
                        const gridInfo = analysisData.gridDetails[gId];
                        option.textContent = `${gId} - ${gridInfo.basicInfo.zone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏Ç‡∏ï'} (${gridInfo.avgYield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà)`;
                        selector.appendChild(option);
                    }
                });
            }
        }
        
        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function showInconsistencyModal() {
            if (!analysisData || analysisData.dataInconsistencies.length === 0) return;
            
            const content = document.getElementById('inconsistencyContent');
            let html = '<p style="color: var(--gray); margin-bottom: 20px;">‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•:</p>';
            
            analysisData.dataInconsistencies.forEach((item, index) => {
                html += `
                    <div class="inconsistency-item">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">Grid: ${item.gridId}</h4>
                        <div style="font-size: 14px; color: var(--gray);">
                            ${item.inconsistencies.map(inc => `
                                <div style="margin-bottom: 5px;">
                                    <strong>${getFieldThai(inc.field)}:</strong><br>
                                    ‚Ä¢ KAT ${inc.season1}: ${inc.value1}<br>
                                    ‚Ä¢ KAT ${inc.season2}: ${inc.value2}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
            showModal('inconsistencyModal');
        }
        
        function getFieldThai(field) {
            const fields = {
                'zone': '‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà',
                'farmerCode': '‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£',
                'agriculturist': '‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏©‡∏ï‡∏£',
                'farmerName': '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà',
                'sugarcaneType': '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢'
            };
            return fields[field] || field;
        }
        
        function showUnmatchedModal() {
            if (!analysisData || analysisData.unmatchedPlotsData.length === 0) {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'info');
                return;
            }
            
            const content = document.getElementById('unmatchedContent');
            let html = `
                <p style="color: var(--gray); margin-bottom: 20px;">
                    ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå KAT ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö landno ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå GRID:
                    <span style="color: var(--warning); font-weight: bold;">${analysisData.unmatchedPlotsData.length} ‡πÅ‡∏õ‡∏•‡∏á</span>
                </p>
                
                <div style="max-height: 400px; overflow-y: auto; padding: 10px;">
            `;
            
            // Group by season
            const groupedBySeason = {};
            analysisData.unmatchedPlotsData.forEach(plot => {
                if (!groupedBySeason[plot.season]) {
                    groupedBySeason[plot.season] = [];
                }
                groupedBySeason[plot.season].push(plot);
            });
            
            Object.keys(groupedBySeason).forEach(season => {
                const plots = groupedBySeason[season];
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">
                            ‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• ${season} (${plots.length} ‡πÅ‡∏õ‡∏•‡∏á)
                        </h4>
                `;
                
                plots.slice(0, 10).forEach((plot, index) => {
                    html += `
                        <div class="unmatched-plot-card">
                            <div>
                                <div style="font-weight: 600; color: var(--primary);">‡πÅ‡∏õ‡∏•‡∏á ${plot.landno}</div>
                                <div style="color: var(--gray); font-size: 14px; margin-top: 5px;">
                                    ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï: ${plot.yield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà | 
                                    ‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£: ${plot.farmerName} | 
                                    ‡πÄ‡∏Ç‡∏ï: ${plot.zone}
                                </div>
                            </div>
                            <div style="color: ${plot.yield < 7 ? 'var(--danger)' : plot.yield < 10 ? 'var(--warning)' : 'var(--success)'}; font-weight: 600;">
                                ${plot.yield.toFixed(1)} ‡∏ï‡∏±‡∏ô
                            </div>
                        </div>
                    `;
                });
                
                if (plots.length > 10) {
                    html += `<p style="color: var(--gray); text-align: center; margin-top: 10px;">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${plots.length - 10} ‡πÅ‡∏õ‡∏•‡∏á...</p>`;
                }
                
                html += `</div>`;
            });
            
            html += `</div>`;
            
            content.innerHTML = html;
            showModal('unmatchedModal');
        }
        
        // Reports Functions
        function updateReports() {
            if (!analysisData) return;
            
            const analyzedGrids = Object.keys(analysisData.gridDetails).length;
            const problemGrids = Object.values(analysisData.gridDetails).filter(grid => grid.criticalPlots.length > 0).length;
            
            document.getElementById('reportGrids').textContent = analyzedGrids;
            document.getElementById('reportProblems').textContent = problemGrids;
            document.getElementById('reportCritical').textContent = analysisData.summary.criticalPlots;
            document.getElementById('reportUnmatched').textContent = analysisData.summary.unmatchedPlots;
            
            // Update recommendations
            generateRecommendations();
            
            // Update trend analysis if both seasons available
            if (analysisData.kat6768.totalPlots > 0 && analysisData.kat6869.totalPlots > 0) {
                generateTrendAnalysis();
            }
        }
        
        function generateRecommendations() {
            const recommendations = document.getElementById('recommendations');
            
            // Identify problematic grids
            const problematicGrids = Object.values(analysisData.gridDetails)
                .filter(grid => grid.grade === 'low' || grid.criticalPlots.length > 0);
            
            const lowYieldGrids = Object.values(analysisData.gridDetails)
                .filter(grid => grid.avgYield < 7);
            
            const urgentIssues = [];
            const recommendationsList = [];
            const improvements = [];
            
            // Urgent issues
            if (lowYieldGrids.length > 0) {
                urgentIssues.push(`‡∏°‡∏µ Grid ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≥ ${lowYieldGrids.length} Grid (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 7 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà)`);
                const gridNames = lowYieldGrids.slice(0, 3).map(g => g.gridId).join(', ');
                urgentIssues.push(`Grid ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πà‡∏ß‡∏ô: ${gridNames}${lowYieldGrids.length > 3 ? ' ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ' : ''}`);
            }
            
            if (analysisData.summary.criticalPlots > 0) {
                urgentIssues.push(`‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï ${analysisData.summary.criticalPlots} ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏î‡πà‡∏ß‡∏ô`);
            }
            
            if (analysisData.summary.unmatchedPlots > 0) {
                urgentIssues.push(`‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ${analysisData.summary.unmatchedPlots} ‡πÅ‡∏õ‡∏•‡∏á (${analysisData.summary.matchRate.toFixed(1)}% ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ)`);
            }
            
            if (analysisData.dataInconsistencies.length > 0) {
                urgentIssues.push(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô ${analysisData.dataInconsistencies.length} Grid`);
            }
            
            // Recommendations
            if (analysisData.summary.unmatchedPlots > 0) {
                recommendationsList.push(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (${analysisData.summary.unmatchedPlots} ‡πÅ‡∏õ‡∏•‡∏á)`);
            }
            
            recommendationsList.push(`‡∏à‡∏±‡∏î‡∏≠‡∏ö‡∏£‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ï‡πà‡∏≥ (${lowYieldGrids.length} Grid)`);
            recommendationsList.push(`‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï`);
            
            if (analysisData.dataInconsistencies.length > 0) {
                recommendationsList.push(`‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•`);
            }
            
            // Improvements
            improvements.push(`‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≥‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏´‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏á`);
            improvements.push(`‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πã‡∏¢‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡∏¥‡∏ô`);
            improvements.push(`‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á`);
            improvements.push(`‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á`);
            
            recommendations.innerHTML = `
                <div style="background: rgba(231, 76, 60, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--danger);">
                    <h4 style="color: var(--danger); margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </h4>
                    <ul style="color: var(--gray); padding-left: 20px;">
                        ${urgentIssues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--warning);">
                    <h4 style="color: var(--warning); margin-bottom: 10px;">
                        <i class="fas fa-clipboard-check"></i> ‡∏Ñ‡∏ß‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                    </h4>
                    <ul style="color: var(--gray); padding-left: 20px;">
                        ${recommendationsList.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
                
                <div style="background: rgba(39, 174, 96, 0.1); padding: 20px; border-radius: 10px; border-left: 5px solid var(--success);">
                    <h4 style="color: var(--success); margin-bottom: 10px;">
                        <i class="fas fa-chart-line"></i> ‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
                    </h4>
                    <ul style="color: var(--gray); padding-left: 20px;">
                        ${improvements.map(imp => `<li>${imp}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
        
        function generateTrendAnalysis() {
            const trendContent = document.getElementById('trendAnalysisContent');
            
            // Calculate yield changes for grids that appear in both seasons
            const trendGrids = [];
            
            Object.keys(analysisData.gridDetails).forEach(gridId => {
                const grid = analysisData.gridDetails[gridId];
                const plots6768 = grid.kat6768.plots;
                const plots6869 = grid.kat6869.plots;
                
                if (plots6768.length > 0 && plots6869.length > 0) {
                    const avg6768 = plots6768.reduce((sum, p) => sum + p.yield, 0) / plots6768.length;
                    const avg6869 = plots6869.reduce((sum, p) => sum + p.yield, 0) / plots6869.length;
                    const change = ((avg6869 - avg6768) / avg6768 * 100);
                    
                    trendGrids.push({
                        gridId: gridId,
                        avg6768: avg6768,
                        avg6869: avg6869,
                        change: change,
                        direction: change > 0 ? 'up' : change < 0 ? 'down' : 'stable'
                    });
                }
            });
            
            // Sort by biggest improvement and decline
            const improvedGrids = trendGrids.filter(g => g.change > 10).sort((a, b) => b.change - a.change);
            const declinedGrids = trendGrids.filter(g => g.change < -10).sort((a, b) => a.change - b.change);
            
            let html = '';
            
            if (improvedGrids.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--success); margin-bottom: 10px;">
                            <i class="fas fa-arrow-up"></i> Grid ‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (>10%)
                        </h5>
                        <div style="font-size: 14px; color: var(--gray);">
                            ${improvedGrids.slice(0, 5).map(g => `
                                <div style="margin-bottom: 5px; padding: 8px; background: rgba(39, 174, 96, 0.1); border-radius: 5px;">
                                    <strong>${g.gridId}</strong>: ${g.avg6768.toFixed(1)} ‚Üí ${g.avg6869.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà 
                                    <span style="color: var(--success);">(+${g.change.toFixed(1)}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (declinedGrids.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--danger); margin-bottom: 10px;">
                            <i class="fas fa-arrow-down"></i> Grid ‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (>10%)
                        </h5>
                        <div style="font-size: 14px; color: var(--gray);">
                            ${declinedGrids.slice(0, 5).map(g => `
                                <div style="margin-bottom: 5px; padding: 8px; background: rgba(231, 76, 60, 0.1); border-radius: 5px;">
                                    <strong>${g.gridId}</strong>: ${g.avg6768.toFixed(1)} ‚Üí ${g.avg6869.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà 
                                    <span style="color: var(--danger);">(${g.change.toFixed(1)}%)</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (html) {
                document.getElementById('trendAnalysisSection').style.display = 'block';
                trendContent.innerHTML = html;
            }
        }
        
        // Export Functions
        function exportPDFReport() {
            if (!analysisData) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'warning');
                return;
            }
            
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF...', 0);
            
            setTimeout(() => {
                hideLoading();
                showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
                
                const reportContent = createPDFReport();
                downloadFile(reportContent, '‡∏≠‡πâ‡∏≠‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå_‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô.pdf', 'application/pdf');
            }, 2000);
        }
        
        function exportExcelReport() {
            if (!analysisData) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'warning');
                return;
            }
            
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel...', 0);
            
            setTimeout(() => {
                hideLoading();
                showAlert('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
                
                const csvContent = createCSVReport();
                downloadFile(csvContent, '‡∏≠‡πâ‡∏≠‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå_‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô.csv', 'text/csv');
            }, 2000);
        }
        
        function createPDFReport() {
            let report = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡πâ‡∏≠‡∏¢\n`;
            report += `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}\n`;
            report += `‡πÄ‡∏ß‡∏•‡∏≤: ${new Date().toLocaleTimeString('th-TH')}\n`;
            report += `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢: ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡πâ‡∏≠‡∏¢\n\n`;
            
            report += `‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:\n`;
            report += `----------------------------------------\n`;
            report += `Grid ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå GRID: ${analysisData.gridCountFromGrid}\n`;
            report += `‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô KAT 67/68: ${analysisData.kat6768.totalPlots} ‡πÅ‡∏õ‡∏•‡∏á\n`;
            report += `‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô KAT 68/69: ${analysisData.kat6869.totalPlots} ‡πÅ‡∏õ‡∏•‡∏á\n`;
            report += `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ: ${analysisData.summary.matchedPlots} ‡πÅ‡∏õ‡∏•‡∏á\n`;
            report += `‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà: ${analysisData.summary.matchRate.toFixed(1)}%\n`;
            report += `‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (<7 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà): ${analysisData.summary.criticalPlots} ‡πÅ‡∏õ‡∏•‡∏á\n`;
            report += `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${analysisData.summary.unmatchedPlots} ‡πÅ‡∏õ‡∏•‡∏á\n`;
            report += `‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${analysisData.summary.avgYield.toFixed(1)} ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà\n\n`;
            
            report += `‡πÄ‡∏Å‡∏£‡∏î‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï:\n`;
            report += `----------------------------------------\n`;
            report += `‡∏™‡∏π‡∏á (>15 ‡∏ï‡∏±‡∏ô/‡πÑ‡∏£‡πà): ${analysisData.summary.gradeDistribution.high} Grid\n`;
            report += `‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (10-15): ${analysisData.summary.gradeDistribution.medium} Grid\n`;
            report += `‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (7-10): ${analysisData.summary.gradeDistribution.improve} Grid\n`;
            report += `‡∏ï‡πà‡∏≥ (<7): ${analysisData.summary.gradeDistribution.low} Grid\n\n`;
            
            report += `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô:\n`;
            report += `----------------------------------------\n`;
            if (analysisData.dataInconsistencies.length > 0) {
                analysisData.dataInconsistencies.forEach(item => {
                    report += `Grid ${item.gridId}:\n`;
                    item.inconsistencies.forEach(inc => {
                        report += `  - ${inc.field}: ${inc.value1} (${inc.season1}) vs ${inc.value2} (${inc.season2})\n`;
                    });
                });
            } else {
                report += `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô\n`;
            }
            report += `\n`;
            
            return report;
        }
        
        function createCSVReport() {
            let csv = 'Grid ID,‡πÄ‡∏Ç‡∏ï,‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£,‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏≤‡∏ß‡πÑ‡∏£‡πà,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡πâ‡∏≠‡∏¢,‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏î‡πâ,‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏Å‡∏§‡∏ï,‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢,‡πÄ‡∏Å‡∏£‡∏î,‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•\n';
            
            Object.values(analysisData.gridDetails).forEach(grid => {
                csv += `"${grid.gridId}",`;
                csv += `"${grid.basicInfo.zone || ''}",`;
                csv += `"${grid.basicInfo.farmerCode || ''}",`;
                csv += `"${grid.basicInfo.farmerName || ''}",`;
                csv += `"${grid.basicInfo.sugarcaneType || ''}",`;
                csv += `"${grid.allPlots.length}",`;
                csv += `"${grid.criticalPlots.length}",`;
                csv += `"${grid.avgYield.toFixed(1)}",`;
                csv += `"${getGradeThai(grid.grade)}",`;
                csv += `"KAT ${grid.basicInfo.season || ''}"\n`;
            });
            
            return csv;
        }
        
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Session Management
        function saveSession() {
            if (!analysisData) {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'warning');
                return;
            }
            
            const sessionData = {
                timestamp: new Date().toISOString(),
                analysisData: analysisData,
                uploadedFiles: {
                    grid: uploadedFiles.grid ? uploadedFiles.grid.name : null,
                    kat6768: uploadedFiles.kat6768 ? uploadedFiles.kat6768.name : null,
                    kat6869: uploadedFiles.kat6869 ? uploadedFiles.kat6869.name : null
                }
            };
            
            sessionId = 'session_' + Date.now();
            localStorage.setItem('sugarcaneAnalysisSession', JSON.stringify(sessionData));
            localStorage.setItem('sugarcaneAnalysisSessionId', sessionId);
            
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Session ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
        }
        
        function loadSession() {
            const savedSession = localStorage.getItem('sugarcaneAnalysisSession');
            if (!savedSession) {
                showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Session ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ', 'warning');
                return;
            }
            
            if (confirm('‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Session ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                loadSavedSession(JSON.parse(savedSession));
            }
        }
        
        function loadSavedSession(sessionData) {
            try {
                analysisData = sessionData.analysisData;
                
                // Update file names in UI
                if (sessionData.uploadedFiles.grid) {
                    document.getElementById('gridFileName').textContent = sessionData.uploadedFiles.grid;
                    document.getElementById('gridStatus').classList.add('uploaded');
                }
                if (sessionData.uploadedFiles.kat6768) {
                    document.getElementById('kat6768FileName').textContent = sessionData.uploadedFiles.kat6768;
                    document.getElementById('kat6768Status').classList.add('uploaded');
                }
                if (sessionData.uploadedFiles.kat6869) {
                    document.getElementById('kat6869FileName').textContent = sessionData.uploadedFiles.kat6869;
                    document.getElementById('kat6869Status').classList.add('uploaded');
                }
                
                // Update all displays
                showPanel('analysis');
                updateAnalysisDashboard();
                updateHeaderStats();
                
                showAlert('‡πÇ‡∏´‡∏•‡∏î Session ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'info');
            } catch (error) {
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î Session', 'error');
                console.error('Load session error:', error);
            }
        }
        
        // Loading Functions
        function showLoading(title, progress = 0) {
            document.getElementById('loadingOverlay').classList.add('active');
            document.getElementById('loadingTitle').textContent = title || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            document.getElementById('loadingMessage').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('progressBar').style.width = '0%';
        }
    </script>
</body>
</html>
