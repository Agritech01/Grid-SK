<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Cane Dashboard 68/69 - Professional Version</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --light: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 10px; line-height: 1.4; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .upload-card { border: 2px dashed #cbd5e0; padding: 20px; border-radius: 10px; text-align: center; background: #fff; position: relative; }
        .status-badge { display: inline-block; margin-top: 10px; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; background: #edf2f7; }
        .status-ready { background: #c6f6d5; color: #2f855a; }
        .filter-container { display: flex; flex-wrap: nowrap; gap: 4px; justify-content: space-between; margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 12px; overflow-x: auto; }
        .btn-zone { flex: 1; padding: 8px 4px; border: 1px solid #cbd5e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; text-align: center; }
        .btn-zone.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-container { position: relative; height: 550px; width: 100%; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #eee; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { padding: 20px; border-radius: 12px; color: #2c3e50; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card.blue { background: linear-gradient(135deg, #D6EAF8, #AED6F1); }
        .stat-card.green { background: linear-gradient(135deg, #D5F5E3, #ABEBC6); }
        .stat-card.orange { background: linear-gradient(135deg, #FCF3CF, #FAD7A0); }
        .stat-card.red { background: linear-gradient(135deg, #FADBD8, #F5B7B1); }
        .stat-label { font-size: 0.95em; font-weight: 600; opacity: 0.85; margin-bottom: 10px; }
        .stat-value { font-size: 1.8em; font-weight: bold; }
        .footer-actions { margin-top: 30px; text-align: right; }
        .btn-download { background: #2d3748; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-reset { background: #718096; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px; }
    </style>
</head>
<body>

<div class="container" id="dashboardNode">
    <h2 id="dashboardTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69</h2>
    
    <div class="upload-grid" id="uploadPanel">
        <div class="upload-card">
            <strong>1. ‡πÑ‡∏ü‡∏•‡πå DATA TARGET (‡πÄ‡∏Ç‡∏ï, ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX, STD...)</strong><br><br>
            <input type="file" id="targetUpload" accept=".csv">
            <div id="targetStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
        <div class="upload-card">
            <strong>2. ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏Ç‡∏ï, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...)</strong><br><br>
            <input type="file" id="actualUpload" accept=".csv">
            <div id="actualStatus" class="status-badge">‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...</div>
        </div>
    </div>

    <div class="filter-container" id="zoneFilter" style="display:none;"></div>

    <div id="mainDashboard" style="display:none;">
        <div class="chart-container">
            <canvas id="sugarChart"></canvas>
        </div>
        <div class="stats-grid">
            <div class="stat-card blue"><div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardTarget">-</div></div>
            <div class="stat-card green"><div class="stat-label">‡∏´‡∏µ‡∏ö‡∏™‡∏∞‡∏™‡∏° (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardAcc">-</div></div>
            <div class="stat-card orange"><div class="stat-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div><div class="stat-value" id="cardPercent">-</div></div>
            <div class="stat-card red"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardRemain">-</div></div>
        </div>
        <div class="footer-actions">
            <button class="btn-reset" onclick="resetDashboard()">üìÇ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</button>
            <button class="btn-download" onclick="exportImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);
    
    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (State)
    let rawTarget = [];
    let rawActual = [];
    let myChart = null;
    const zones = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12", "21", "C1", "C2", "C3", "C4"];

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    document.getElementById('targetUpload').addEventListener('change', (e) => handleFile(e, 'target'));
    document.getElementById('actualUpload').addEventListener('change', (e) => handleFile(e, 'actual'));

    function handleFile(event, type) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: (h) => h.trim(), // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            complete: function(results) {
                if (type === 'target') {
                    rawTarget = results.data;
                    document.getElementById('targetStatus').innerText = "‚úì Target ‡∏û‡∏£‡πâ‡∏≠‡∏° (" + rawTarget.length + " ‡πÅ‡∏ñ‡∏ß)";
                    document.getElementById('targetStatus').classList.add('status-ready');
                } else {
                    rawActual = results.data;
                    document.getElementById('actualStatus').innerText = "‚úì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏° (" + rawActual.length + " ‡πÅ‡∏ñ‡∏ß)";
                    document.getElementById('actualStatus').classList.add('status-ready');
                }
                
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                if (rawTarget.length > 0 && rawActual.length > 0) {
                    initDashboard();
                }
            }
        });
        event.target.value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    function resetDashboard() {
        rawTarget = [];
        rawActual = [];
        if (myChart) {
            myChart.destroy();
            myChart = null;
        }
        
        document.getElementById('targetStatus').innerText = "‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...";
        document.getElementById('targetStatus').classList.remove('status-ready');
        document.getElementById('actualStatus').innerText = "‡∏£‡∏≠‡πÑ‡∏ü‡∏•‡πå...";
        document.getElementById('actualStatus').classList.remove('status-ready');
        
        document.getElementById('uploadPanel').style.display = 'grid';
        document.getElementById('zoneFilter').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('zoneFilter').innerHTML = '';
    }

    function initDashboard() {
        initFilterButtons();
        document.getElementById('zoneFilter').style.display = 'flex';
        document.getElementById('mainDashboard').style.display = 'block';
        document.getElementById('uploadPanel').style.display = 'none';
        updateDashboard('‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï');
    }

    function initFilterButtons() {
        const container = document.getElementById('zoneFilter');
        container.innerHTML = `<button class="btn-zone active" onclick="changeZone(this, '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï')">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</button>`;
        zones.forEach(z => { 
            container.innerHTML += `<button class="btn-zone" onclick="changeZone(this, '${z}')">‡πÄ‡∏Ç‡∏ï ${z}</button>`; 
        });
    }

    function changeZone(btn, zone) {
        document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(zone);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    function parseNum(val) {
        if (val === undefined || val === null || val === "") return 0;
        let cleanVal = String(val).replace(/[^0-9.-]/g, '');
        return parseFloat(cleanVal) || 0;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° (07/12/1968 - 31/03/1969)
    function generateDateRange() {
        let dates = [], 
            start = new Date(1968, 11, 7, 12, 0, 0), // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô timezone shift
            end = new Date(1969, 2, 31, 12, 0, 0),
            current = new Date(start);
        while (current <= end) { 
            dates.push(new Date(current));
            current.setDate(current.getDate() + 1); 
        }
        return dates;
    }

    function updateDashboard(selectedZone) {
        const dates = generateDateRange();
        let targetMax = 0, std1 = 0, std2 = 0, std3 = 0;

        // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Target
        rawTarget.forEach(row => {
            if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                targetMax += parseNum(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]);
                std1 += parseNum(row["STD 14/12"]);
                std2 += parseNum(row["STD 5/1"]);
                std3 += parseNum(row["STD 21/1"]);
            }
        });

        const targetSeries = dates.map(d => {
            const m = d.getMonth() + 1, day = d.getDate();
            if (d.getFullYear() === 1968 && m === 12 && day >= 7 && day <= 27) return std1;
            if (d.getFullYear() === 1969 && m === 1 && day >= 5 && day <= 20) return std2;
            if (d.getFullYear() === 1969 && ((m === 1 && day >= 21) || m === 2 || m === 3)) return std3;
            return 0;
        });

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Actual)
        let lastDataIdx = -1;
        const actualDaily = dates.map((d, idx) => {
            const dStr = String(d.getDate()).padStart(2, '0');
            const mStr = String(d.getMonth() + 1).padStart(2, '0');
            const yStr = d.getFullYear();
            const searchKey = `${dStr}/${mStr}/${yStr}`;

            let daySum = 0;
            let foundInDay = false;

            rawActual.forEach(row => {
                if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                    // ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤/‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
                    const actualKey = Object.keys(row).find(k => k.trim() === searchKey);
                    if (actualKey) {
                        const val = row[actualKey];
                        if (val !== undefined && val !== null && String(val).trim() !== "") {
                            const n = parseNum(val);
                            daySum += n;
                            if (n > 0) foundInDay = true; // ‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏≠‡πâ‡∏≠‡∏¢‡∏à‡∏£‡∏¥‡∏á
                        }
                    }
                }
            });

            if (foundInDay) lastDataIdx = idx; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            return daySum;
        });

        // 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏° (Accumulated)
        let accSum = 0, actualAcc = [];
        for (let i = 0; i <= lastDataIdx; i++) { 
            accSum += actualDaily[i];
            actualAcc.push(accSum);
        }
        
        // 4. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (Projection)
        const projectionLine = new Array(actualAcc.length > 0 ? actualAcc.length - 1 : 0).fill(null);
        if (actualAcc.length > 0) projectionLine.push(accSum);

        if (lastDataIdx < dates.length - 1 && lastDataIdx !== -1) {
            let remTarget = Math.max(0, targetMax - accSum);
            let remDays = (dates.length - 1) - lastDataIdx;
            let dailyProj = remTarget / remDays;
            let tempAcc = accSum;
            for (let i = lastDataIdx + 1; i < dates.length; i++) { 
                tempAcc += dailyProj;
                projectionLine.push(tempAcc);
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        const lastDateObj = dates[lastDataIdx !== -1 ? lastDataIdx : 0];
        document.getElementById('dashboardTitle').innerHTML = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69<br>
            <span style="font-size: 0.8em; color: var(--accent);">${selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' : '‡πÄ‡∏Ç‡∏ï ' + selectedZone}</span><br>
            <span style="font-size: 0.6em; font-weight: normal;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${lastDateObj.getDate()} ${thaiMonths[lastDateObj.getMonth()]} ${lastDateObj.getFullYear() + 543}</span>`;

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô Card
        document.getElementById('cardTarget').innerText = Math.round(targetMax).toLocaleString();
        document.getElementById('cardAcc').innerText = Math.round(accSum).toLocaleString();
        document.getElementById('cardPercent').innerText = ((accSum / (targetMax || 1)) * 100).toFixed(2) + "%";
        document.getElementById('cardRemain').innerText = Math.max(0, Math.round(targetMax - accSum)).toLocaleString();

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü
        renderChart(dates, targetSeries, actualDaily, actualAcc, projectionLine, lastDataIdx);
    }

    function isValidZone(rowZone, selectedZone) {
        const cleanRowZone = String(rowZone || "").trim();
        if (selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï') return zones.includes(cleanRowZone);
        return cleanRowZone === selectedZone;
    }

    function renderChart(dates, targets, daily, acc, proj, lastIdx) {
        const labels = dates.map(d => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}`);
        const ctx = document.getElementById('sugarChart').getContext('2d');
        
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    { 
                        type: 'line', 
                        label: '‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏° (Actual)', 
                        data: acc, 
                        borderColor: '#27ae60', 
                        backgroundColor: '#27ae60', 
                        borderWidth: 3, 
                        yAxisID: 'yAcc', 
                        pointRadius: (ctx) => (ctx.dataIndex === lastIdx ? 5 : 0),
                        pointBackgroundColor: '#FF0000',
                        order: 1, 
                        datalabels: { display: (context) => context.dataIndex === lastIdx, anchor: 'end', align: 'right', backgroundColor: '#33CCCC', color: 'white', borderRadius: 4, padding: 4, formatter: (val) => Math.round(val).toLocaleString() } 
                    },
                    { 
                        type: 'line', 
                        label: '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏∞‡∏™‡∏° (Projection)', 
                        data: proj, 
                        borderColor: '#27ae60', 
                        borderDash: [5, 5],
                        yAxisID: 'yAcc', 
                        pointRadius: (ctx) => (ctx.dataIndex === proj.length - 1 ? 5 : 0),
                        pointBackgroundColor: '#FF0000',
                        order: 2, 
                        datalabels: { display: (context) => context.dataIndex === proj.length - 1, anchor: 'end', align: 'right', backgroundColor: '#4682B4', color: 'white', borderRadius: 4, padding: 4, formatter: (val) => Math.round(val).toLocaleString() } 
                    },
                    { 
                        type: 'bar', 
                        label: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Actual)', 
                        data: daily.slice(0, lastIdx + 1), 
                        backgroundColor: '#3498db', 
                        yAxisID: 'yDaily', 
                        order: 3, 
                        datalabels: { 
                            display: (context) => context.dataIndex === lastIdx || (context.dataIndex > 0 && context.dataIndex % 10 === 0), 
                            anchor: 'end', align: 'top', backgroundColor: '#00CCFF', color: 'white', borderRadius: 4, padding: 2, font: { size: 9 },
                            formatter: (val) => val > 0 ? Math.round(val).toLocaleString() : ''
                        } 
                    },
                    { 
                        type: 'bar', 
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ STD ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', 
                        data: targets, 
                        backgroundColor: 'rgba(200, 200, 200, 0.2)', 
                        barPercentage: 1, 
                        categoryPercentage: 1, 
                        yAxisID: 'yDaily', 
                        order: 4, 
                        datalabels: { display: false } 
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { 
                    tooltip: { mode: 'index', intersect: false }, 
                    datalabels: { clip: false, clamp: true, font: { weight: 'bold' } } 
                },
                scales: {
                    x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 9 } } },
                    yDaily: { type: 'linear', position: 'left', title: { display: true, text: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô' }, beginAtZero: true },
                    yAcc: { type: 'linear', position: 'right', title: { display: true, text: '‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏°' }, grid: { drawOnChartArea: false }, beginAtZero: true }
                }
            }
        });
    }

    function exportImage() {
        const node = document.getElementById('dashboardNode');
        const filter = document.getElementById('zoneFilter'), footer = document.querySelector('.footer-actions');
        filter.style.display = 'none'; footer.style.display = 'none';
        html2canvas(node, { scale: 2 }).then(canvas => {
            const link = document.createElement('a'); link.download = 'Sugar_Report_68-69.png'; link.href = canvas.toDataURL(); link.click();
            filter.style.display = 'flex'; footer.style.display = 'block';
        });
    }
</script>
</body>
</html>
