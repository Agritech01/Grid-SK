<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดรายงานอ้อยเข้าหีบ ปี 68/69</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Prompt', sans-serif;
        }
        
        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --secondary: #FF9800;
            --danger: #D32F2F;
            --light: #F5F5F5;
            --dark: #333;
            --gray: #757575;
            --border: #E0E0E0;
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-title {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .header-title i {
            font-size: 32px;
            margin-right: 15px;
        }
        
        .header-title h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .header-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 25px;
            transition: grid-template-columns 0.3s ease;
        }
        
        .main-content.collapsed {
            grid-template-columns: 0fr 4fr;
        }
        
        .main-content.collapsed .left-panel {
            display: none;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .main-content.collapsed {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .collapsible-header i {
            transition: transform 0.3s ease;
        }
        
        .collapsible-header.collapsed i.fa-chevron-down {
            transform: rotate(180deg);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .card-title i {
            color: var(--primary);
            margin-right: 10px;
            font-size: 20px;
        }
        
        .card-title h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .collapsible-content {
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 1000px;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }
        
        /* อัพโหลดไฟล์ */
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            background-color: rgba(46, 125, 50, 0.03);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: rgba(46, 125, 50, 0.08);
        }
        
        .upload-area.dragover {
            background-color: rgba(46, 125, 50, 0.15);
            border-color: var(--primary-light);
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .upload-text h3 {
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .upload-text p {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .file-requirements {
            text-align: left;
            margin-top: 15px;
            padding: 15px;
            background-color: var(--light);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .file-requirements ul {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .file-requirements li {
            margin-bottom: 5px;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .file-info {
            display: flex;
            align-items: center;
        }
        
        .file-icon {
            color: var(--primary);
            margin-right: 12px;
            font-size: 20px;
        }
        
        .file-name {
            font-weight: 500;
        }
        
        .file-size {
            font-size: 14px;
            color: var(--gray);
            margin-top: 3px;
        }
        
        .file-status {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #FFF3E0;
            color: #EF6C00;
        }
        
        .status-success {
            background-color: #E8F5E9;
            color: var(--primary);
        }
        
        .status-error {
            background-color: #FFEBEE;
            color: var(--danger);
        }
        
        /* ปุ่มดำเนินการ */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-light);
        }
        
        .btn-primary:disabled {
            background-color: #BDBDBD;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #EEEEEE;
            color: var(--dark);
        }
        
        .btn-secondary:hover {
            background-color: #E0E0E0;
        }
        
        /* ตัวอย่างข้อมูล */
        .data-preview {
            overflow-x: auto;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .preview-table th {
            background-color: var(--primary);
            color: white;
            text-align: left;
            padding: 12px 15px;
            font-weight: 500;
        }
        
        .preview-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .preview-table tr:nth-child(even) {
            background-color: #F9F9F9;
        }
        
        .preview-table tr:hover {
            background-color: #F5F5F5;
        }
        
        /* ปุ่มเลือกเขต - แก้ไขการจัดเรียง */
        .zone-selection {
            margin-bottom: 25px;
        }
        
        .zone-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .zone-title i {
            color: var(--primary);
            margin-right: 10px;
        }
        
        .zone-buttons {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
        }
        
        @media (max-width: 1600px) {
            .zone-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .zone-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .zone-btn {
            padding: 12px 15px;
            background-color: #EEEEEE;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .zone-btn:hover {
            background-color: #E0E0E0;
        }
        
        .zone-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-light);
        }
        
        .zone-btn.all {
            background-color: #2196F3;
            color: white;
            grid-column: span 8;
        }
        
        @media (max-width: 1600px) {
            .zone-btn.all {
                grid-column: span 4;
            }
        }
        
        @media (max-width: 768px) {
            .zone-btn.all {
                grid-column: span 2;
            }
        }
        
        .zone-btn.all.active {
            background-color: #1976D2;
            border-color: #2196F3;
        }
        
        /* แดชบอร์ดและกราฟ */
        .dashboard-section {
            margin-top: 20px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }
        
        .stat-1 { background-color: #4CAF50; }
        .stat-2 { background-color: #2196F3; }
        .stat-3 { background-color: #FF9800; }
        .stat-4 { background-color: #9C27B0; }
        
        .stat-info h3 {
            font-size: 28px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .stat-info p {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* คอนเทนเนอร์กราฟหลัก */
        .main-chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border);
            height: 700px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
        }
        
        .chart-title i {
            color: var(--primary);
            margin-right: 10px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .chart-container {
            width: 100%;
            height: 580px;
            position: relative;
            overflow: hidden;
        }
        
        .chart-canvas {
            width: 100%;
            height: 100%;
        }
        
        /* สถานะการประมวลผล */
        .processing-status {
            padding: 20px;
            background-color: #E3F2FD;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #BBDEFB;
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #2196F3;
            width: 0%;
            transition: width 0.5s;
        }
        
        /* ส่วนบันทึกรายงาน */
        .report-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px solid var(--border);
        }
        
        .hidden {
            display: none;
        }
        
        /* โหลดข้อมูล */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ปุ่มควบคุมการยุบ/ขยาย */
        .collapse-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .collapse-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .collapse-btn:hover {
            background: var(--primary-light);
        }
        
        /* Legend */
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: #F9F9F9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        /* ปรับปรุงกราฟสำหรับวันที่มาก */
        .chart-container {
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .chart-canvas {
            min-width: 2000px; /* เพิ่มความกว้างขั้นต่ำสำหรับ 115 วัน */
        }
        
        .date-label {
            font-size: 10px;
            transform: rotate(-90deg);
            transform-origin: left top;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">
                <i class="fas fa-chart-line"></i>
                <div>
                    <h1>แดชบอร์ดรายงานอ้อยเข้าหีบ ปี 68/69</h1>
                    <div class="header-subtitle">ระบบประมวลผลและวิเคราะห์ข้อมูลอ้อยเข้าหีบประจำปีการผลิต 2568/2569</div>
                </div>
            </div>
        </header>
        
        <div class="collapse-controls">
            <button class="collapse-btn" id="toggleCollapseBtn">
                <i class="fas fa-chevron-left"></i> ยุบส่วนอัพโหลด
            </button>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- ส่วนอัพโหลดไฟล์ -->
            <div class="left-panel">
                <div class="card">
                    <div class="collapsible-header" id="uploadHeader">
                        <div class="card-title">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h2>อัพโหลดไฟล์ข้อมูล</h2>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="collapsible-content" id="uploadContent">
                        <div class="upload-section">
                            <div class="upload-area" id="uploadArea">
                                <div class="upload-icon">
                                    <i class="fas fa-file-upload"></i>
                                </div>
                                <div class="upload-text">
                                    <h3>ลากและวางไฟล์ที่นี่</h3>
                                    <p>หรือคลิกเพื่อเลือกไฟล์จากคอมพิวเตอร์ของคุณ</p>
                                    <p>รองรับเฉพาะไฟล์ .csv ขนาดไม่เกิน 100MB</p>
                                </div>
                            </div>
                            
                            <div class="file-requirements">
                                <strong>ข้อกำหนดไฟล์:</strong>
                                <ul>
                                    <li>ต้องอัพโหลด 2 ไฟล์: <strong>Target</strong> และ <strong>รายงานอ้อยเข้าหีบ 68/69</strong></li>
                                    <li>ไฟล์ Target ต้องมีคอลัมน์: STD 14/12, STD 5/1, STD 21/1, เขต</li>
                                    <li>ไฟล์รายงานต้องมีคอลัมน์ D (เขต) และคอลัมน์วันที่</li>
                                    <li>ไฟล์ต้องเป็นรูปแบบ .csv เท่านั้น</li>
                                </ul>
                            </div>
                            
                            <div class="file-list" id="fileList">
                                <!-- ไฟล์ที่อัพโหลดจะแสดงที่นี่ -->
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn btn-primary" id="processBtn" disabled>
                                    <i class="fas fa-cogs"></i> ประมวลผลข้อมูล
                                </button>
                                <button class="btn btn-secondary" id="resetBtn">
                                    <i class="fas fa-redo"></i> ล้างข้อมูล
                                </button>
                            </div>
                            
                            <div class="processing-status" id="processingStatus">
                                <div class="collapsible-header" id="progressHeader">
                                    <div class="status-info">
                                        <strong><i class="fas fa-sync-alt fa-spin"></i> กำลังประมวลผลข้อมูล...</strong>
                                    </div>
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                                <div class="collapsible-content" id="progressContent">
                                    <p>ระบบกำลังอ่านและประมวลผลไฟล์ข้อมูล กรุณารอสักครู่</p>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progressFill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ตัวอย่างข้อมูล -->
                <div class="card">
                    <div class="collapsible-header" id="previewHeader">
                        <div class="card-title">
                            <i class="fas fa-table"></i>
                            <h2>ตัวอย่างข้อมูล</h2>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    
                    <div class="collapsible-content" id="previewContent">
                        <div class="data-preview">
                            <table class="preview-table" id="previewTable">
                                <thead>
                                    <tr>
                                        <th>คอลัมน์ตัวอย่าง</th>
                                        <th>ข้อมูล</th>
                                        <th>สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                    <tr>
                                        <td colspan="3" style="text-align: center; padding: 40px; color: var(--gray);">
                                            <i class="fas fa-file-import" style="font-size: 36px; margin-bottom: 15px; display: block;"></i>
                                            ยังไม่มีข้อมูล กรุณาอัพโหลดไฟล์เพื่อดูตัวอย่าง
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- แดชบอร์ดและกราฟ -->
            <div>
                <!-- ปุ่มเลือกเขต - แก้ไขการจัดเรียงตามคำขอ -->
                <div class="card zone-selection">
                    <div class="zone-title">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>เลือกเขตแสดงผล</span>
                    </div>
                    <div class="zone-buttons" id="zoneButtons">
                        <!-- แถวที่ 1: 8 ปุ่ม -->
                        <button class="zone-btn all active" data-zone="all">รวมทุกเขต</button>
                        <button class="zone-btn" data-zone="1">เขต 1</button>
                        <button class="zone-btn" data-zone="2">เขต 2</button>
                        <button class="zone-btn" data-zone="3">เขต 3</button>
                        <button class="zone-btn" data-zone="4">เขต 4</button>
                        <button class="zone-btn" data-zone="5">เขต 5</button>
                        <button class="zone-btn" data-zone="6">เขต 6</button>
                        <button class="zone-btn" data-zone="7">เขต 7</button>
                        <!-- แถวที่ 2: 8 ปุ่ม -->
                        <button class="zone-btn" data-zone="8">เขต 8</button>
                        <button class="zone-btn" data-zone="10">เขต 10</button>
                        <button class="zone-btn" data-zone="11">เขต 11</button>
                        <button class="zone-btn" data-zone="12">เขต 12</button>
                        <button class="zone-btn" data-zone="21">เขต 21</button>
                        <button class="zone-btn" data-zone="C1">เขต C1</button>
                        <button class="zone-btn" data-zone="C2">เขต C2</button>
                        <button class="zone-btn" data-zone="C3">เขต C3</button>
                        <button class="zone-btn" data-zone="C4">เขต C4</button>
                    </div>
                </div>
                
                <!-- กราฟหลัก -->
                <div class="main-chart-container">
                    <div class="chart-title-bar">
                        <div class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            <span id="chartMainTitle">กราฟแสดงผลอ้อยเข้าหีบ</span>
                        </div>
                        <div class="chart-controls">
                            <button class="btn btn-secondary" id="zoomInBtn">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-secondary" id="zoomOutBtn">
                                <i class="fas fa-search-minus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading hidden" id="dashboardLoading">
                        <div class="spinner"></div>
                        <p>กำลังโหลดแดชบอร์ด...</p>
                    </div>
                    
                    <div id="dashboardContent" class="hidden">
                        <!-- คอนเทนเนอร์กราฟ -->
                        <div class="chart-container">
                            <canvas id="mainChart" class="chart-canvas"></canvas>
                        </div>
                        
                        <!-- Legend -->
                        <div class="chart-legend" id="chartLegend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(76, 175, 80, 0.6);"></div>
                                <span>ตันรายวัน (แท่ง)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2196F3;"></div>
                                <span>ตันสะสม (เส้น)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(255, 152, 0, 0.3);"></div>
                                <span>เป้าหมาย STD 14/12 (07/12-27/12)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(156, 39, 176, 0.3);"></div>
                                <span>เป้าหมาย STD 5/1 (05/01-20/01)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: rgba(244, 67, 54, 0.3);"></div>
                                <span>เป้าหมาย STD 21/1 (21/01-31/03)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="dashboardPlaceholder" class="chart-placeholder" style="height: 580px;">
                        <i class="fas fa-chart-line"></i>
                        <p>กราฟจะแสดงที่นี่หลังจากอัพโหลดและประมวลผลไฟล์ข้อมูล</p>
                    </div>
                </div>
                
                <!-- สถิติสรุป -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon stat-1">
                            <i class="fas fa-weight-hanging"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalWeight">0</h3>
                            <p>น้ำหนักอ้อยทั้งหมด (ตัน)</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon stat-2">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="targetAchievement">0%</h3>
                            <p>บรรลุเป้าหมาย</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon stat-3">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalTrips">0</h3>
                            <p>จำนวนรถเข้าหีบ</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon stat-4">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="processingDays">0</h3>
                            <p>วันทำงาน</p>
                        </div>
                    </div>
                </div>
                
                <!-- ปุ่มบันทึกรายงาน -->
                <div class="report-actions">
                    <button class="btn btn-secondary" id="saveReportBtn">
                        <i class="fas fa-download"></i> บันทึกรายงานเป็นภาพ
                    </button>
                    <button class="btn btn-primary" id="exportDataBtn">
                        <i class="fas fa-file-export"></i> ส่งออกรายงาน
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Input file ที่ซ่อนอยู่ -->
    <input type="file" id="fileInput" accept=".csv" multiple style="display: none;">
    
    <!-- เพิ่ม Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ตัวแปรเก็บข้อมูลไฟล์
        let uploadedFiles = {
            target: null,
            report: null
        };
        
        // ตัวแปรเก็บข้อมูลที่ประมวลผลแล้ว
        let processedData = null;
        let chartData = null;
        let mainChart = null;
        
        // สถานะการยุบ/ขยาย
        let isCollapsed = false;
        let uploadCollapsed = false;
        let progressCollapsed = false;
        let previewCollapsed = false;
        
        // เขตที่เลือก
        let selectedZone = "all";
        
        // อ้างอิง DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const resetBtn = document.getElementById('resetBtn');
        const previewBody = document.getElementById('previewBody');
        const processingStatus = document.getElementById('processingStatus');
        const progressFill = document.getElementById('progressFill');
        const dashboardPlaceholder = document.getElementById('dashboardPlaceholder');
        const dashboardLoading = document.getElementById('dashboardLoading');
        const dashboardContent = document.getElementById('dashboardContent');
        const saveReportBtn = document.getElementById('saveReportBtn');
        const toggleCollapseBtn = document.getElementById('toggleCollapseBtn');
        const mainContent = document.getElementById('mainContent');
        const zoneButtons = document.getElementById('zoneButtons');
        const chartMainTitle = document.getElementById('chartMainTitle');
        
        // Elements สำหรับการยุบ/ขยาย
        const uploadHeader = document.getElementById('uploadHeader');
        const uploadContent = document.getElementById('uploadContent');
        const progressHeader = document.getElementById('progressHeader');
        const progressContent = document.getElementById('progressContent');
        const previewHeader = document.getElementById('previewHeader');
        const previewContent = document.getElementById('previewContent');
        
        // ฟังก์ชันตรวจสอบประเภทไฟล์
        function isValidFileType(file) {
            return file.name.toLowerCase().endsWith('.csv');
        }
        
        // ฟังก์ชันตรวจสอบขนาดไฟล์
        function isValidFileSize(file) {
            const maxSize = 100 * 1024 * 1024; // 100MB
            return file.size <= maxSize;
        }
        
        // ฟังก์ชันตรวจสอบว่าเป็นไฟล์ Target หรือ Report
        function getFileType(fileName) {
            const lowerName = fileName.toLowerCase();
            if (lowerName.includes('target') || lowerName.includes('เป้าหมาย') || lowerName.includes('เป้า')) return 'target';
            if (lowerName.includes('รายงาน') || lowerName.includes('report') || lowerName.includes('6869') || lowerName.includes('อ้อยเข้าหีบ')) return 'report';
            return 'unknown';
        }
        
        // ฟังก์ชันอ่านและแยกข้อมูลจากไฟล์ Target CSV
        async function parseTargetCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        
                        if (lines.length === 0) {
                            reject(new Error('ไฟล์ Target ว่างเปล่า'));
                            return;
                        }
                        
                        // หา header
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        // ตรวจสอบคอลัมน์ที่จำเป็น
                        const requiredColumns = ['เขต', 'STD 14/12', 'STD 5/1', 'STD 21/1'];
                        const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                        
                        if (missingColumns.length > 0) {
                            reject(new Error(`ไฟล์ Target ขาดคอลัมน์: ${missingColumns.join(', ')}`));
                            return;
                        }
                        
                        // แปลงข้อมูล
                        const targetData = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim() === '') continue;
                            
                            const values = lines[i].split(',').map(v => v.trim());
                            const row = {};
                            
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            
                            const zone = row['เขต'];
                            if (zone) {
                                targetData[zone] = {
                                    std1412: parseFloat(row['STD 14/12']) || 0,
                                    std51: parseFloat(row['STD 5/1']) || 0,
                                    std211: parseFloat(row['STD 21/1']) || 0
                                };
                            }
                        }
                        
                        resolve({
                            type: 'target',
                            filename: file.name,
                            data: targetData,
                            totalZones: Object.keys(targetData).length
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('ไม่สามารถอ่านไฟล์ Target ได้'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ฟังก์ชันอ่านและแยกข้อมูลจากไฟล์รายงาน CSV
        async function parseReportCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n').map(line => line.trim());
                        
                        if (lines.length === 0) {
                            reject(new Error('ไฟล์รายงานว่างเปล่า'));
                            return;
                        }
                        
                        // หาคอลัมน์เขต (คอลัมน์ D = index 3 ถ้าเริ่มจาก 0)
                        const firstLine = lines[0].split(',');
                        let zoneColumnIndex = -1;
                        
                        // หาคอลัมน์ที่มีชื่อว่า "เขต" หรือคอลัมน์ที่ 4 (D)
                        for (let i = 0; i < firstLine.length; i++) {
                            if (firstLine[i].toLowerCase().includes('เขต') || i === 3) {
                                zoneColumnIndex = i;
                                break;
                            }
                        }
                        
                        if (zoneColumnIndex === -1) {
                            zoneColumnIndex = 3; // ใช้คอลัมน์ที่ 4 เป็น default
                        }
                        
                        // เก็บวันที่จากแถวแรก
                        const dateColumns = [];
                        const dateValues = firstLine;
                        
                        // เริ่มจากคอลัมน์ F (index 5) ถึง DP1
                        for (let i = 5; i < dateValues.length; i++) {
                            const dateStr = dateValues[i].trim();
                            if (dateStr) {
                                // แปลงวันที่จาก DD/MM/YYYY
                                const dateParts = dateStr.split('/');
                                if (dateParts.length === 3) {
                                    const day = parseInt(dateParts[0]);
                                    const month = parseInt(dateParts[1]);
                                    const year = parseInt(dateParts[2]);
                                    
                                    // แปลงปีจาก 1968 เป็น 2568
                                    const adjustedYear = year < 2000 ? year + 600 : year;
                                    const dateObj = new Date(adjustedYear, month - 1, day);
                                    
                                    if (!isNaN(dateObj.getTime())) {
                                        dateColumns.push({
                                            index: i,
                                            date: dateObj,
                                            display: `${day}/${month}`,
                                            day: day,
                                            month: month,
                                            year: adjustedYear
                                        });
                                    }
                                }
                            }
                        }
                        
                        // เรียงวันที่จากน้อยไปมาก
                        dateColumns.sort((a, b) => a.date - b.date);
                        
                        // เก็บข้อมูลตามเขต
                        const reportData = {};
                        let totalRows = 0;
                        
                        // อ่านข้อมูลจากแถวที่ 2 เป็นต้นไป
                        for (let rowIndex = 1; rowIndex < lines.length; rowIndex++) {
                            if (lines[rowIndex].trim() === '') continue;
                            
                            const values = lines[rowIndex].split(',');
                            const zone = values[zoneColumnIndex] ? values[zoneColumnIndex].trim() : '';
                            
                            if (!zone) continue;
                            
                            if (!reportData[zone]) {
                                reportData[zone] = {
                                    dailyData: {},
                                    cumulativeData: {},
                                    totalWeight: 0
                                };
                            }
                            
                            // อ่านข้อมูลน้ำหนักสำหรับแต่ละวัน
                            dateColumns.forEach(dateCol => {
                                const weight = parseFloat(values[dateCol.index]) || 0;
                                const dateKey = dateCol.date.toISOString().split('T')[0];
                                
                                if (!reportData[zone].dailyData[dateKey]) {
                                    reportData[zone].dailyData[dateKey] = 0;
                                }
                                
                                reportData[zone].dailyData[dateKey] += weight;
                            });
                            
                            totalRows++;
                        }
                        
                        // คำนวณข้อมูลสะสมสำหรับแต่ละเขต
                        Object.keys(reportData).forEach(zone => {
                            const zoneData = reportData[zone];
                            const dates = Object.keys(zoneData.dailyData).sort();
                            let cumulative = 0;
                            
                            dates.forEach(date => {
                                cumulative += zoneData.dailyData[date];
                                zoneData.cumulativeData[date] = cumulative;
                            });
                            
                            zoneData.totalWeight = cumulative;
                        });
                        
                        resolve({
                            type: 'report',
                            filename: file.name,
                            dateColumns: dateColumns,
                            data: reportData,
                            totalRows: totalRows
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('ไม่สามารถอ่านไฟล์รายงานได้'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // ฟังก์ชันวิเคราะห์ข้อมูล
        function analyzeData(targetData, reportData) {
            // สร้างข้อมูลสำหรับกราฟ
            const allZones = Object.keys(reportData.data);
            const dates = reportData.dateColumns.map(col => col.date);
            const dateLabels = reportData.dateColumns.map(col => col.display);
            const dateDetails = reportData.dateColumns.map(col => ({
                day: col.day,
                month: col.month,
                year: col.year
            }));
            
            // คำนวณข้อมูลรวมทุกเขต
            const combinedData = {
                daily: {},
                cumulative: {},
                totalWeight: 0
            };
            
            dates.forEach(date => {
                const dateKey = date.toISOString().split('T')[0];
                combinedData.daily[dateKey] = 0;
                combinedData.cumulative[dateKey] = 0;
            });
            
            allZones.forEach(zone => {
                const zoneData = reportData.data[zone];
                Object.keys(zoneData.dailyData).forEach(dateKey => {
                    combinedData.daily[dateKey] += zoneData.dailyData[dateKey];
                });
            });
            
            // คำนวณข้อมูลสะสมรวม
            let cumulativeTotal = 0;
            dates.forEach(date => {
                const dateKey = date.toISOString().split('T')[0];
                cumulativeTotal += combinedData.daily[dateKey];
                combinedData.cumulative[dateKey] = cumulativeTotal;
            });
            
            combinedData.totalWeight = cumulativeTotal;
            
            return {
                target: targetData.data,
                report: reportData.data,
                combined: combinedData,
                dates: dates,
                dateLabels: dateLabels,
                dateDetails: dateDetails,
                allZones: allZones,
                targetFileInfo: targetData,
                reportFileInfo: reportData
            };
        }
        
        // ฟังก์ชันเตรียมข้อมูลสำหรับกราฟ - แก้ไขตามข้อกำหนดเป้าหมายใหม่
        function prepareChartData(processedData, selectedZone) {
            const dates = processedData.dates;
            const dateLabels = processedData.dateLabels;
            const dateDetails = processedData.dateDetails;
            
            let dailyData = [];
            let cumulativeData = [];
            let targetData = [];
            
            if (selectedZone === "all") {
                // ใช้ข้อมูลรวมทุกเขต
                dates.forEach((date, index) => {
                    const dateKey = date.toISOString().split('T')[0];
                    dailyData.push(processedData.combined.daily[dateKey] || 0);
                    cumulativeData.push(processedData.combined.cumulative[dateKey] || 0);
                    
                    // กำหนดเป้าหมายตามช่วงวันที่ - แก้ไขตามข้อกำหนดใหม่
                    const day = dateDetails[index].day;
                    const month = dateDetails[index].month;
                    
                    let targetValue = 0;
                    
                    // ช่วง STD 14/12: 07/12 - 27/12 (แก้ไขจาก 28 เป็น 27)
                    if (month === 12 && day >= 7 && day <= 27) {
                        // หาค่าเป้าหมายรวมจากทุกเขต
                        const targets = Object.values(processedData.target);
                        if (targets.length > 0) {
                            const sum = targets.reduce((acc, zoneTarget) => acc + (zoneTarget.std1412 || 0), 0);
                            targetValue = sum; // ไม่หารจำนวนวัน ใช้ค่าจริง
                        }
                    }
                    // ช่วง STD 5/1: 05/01 - 20/01
                    else if (month === 1 && day >= 5 && day <= 20) {
                        const targets = Object.values(processedData.target);
                        if (targets.length > 0) {
                            const sum = targets.reduce((acc, zoneTarget) => acc + (zoneTarget.std51 || 0), 0);
                            targetValue = sum; // ไม่หารจำนวนวัน ใช้ค่าจริง
                        }
                    }
                    // ช่วง STD 21/1: 21/01 - 31/03
                    else if ((month === 1 && day >= 21) || month === 2 || (month === 3 && day <= 31)) {
                        const targets = Object.values(processedData.target);
                        if (targets.length > 0) {
                            const sum = targets.reduce((acc, zoneTarget) => acc + (zoneTarget.std211 || 0), 0);
                            targetValue = sum; // ไม่หารจำนวนวัน ใช้ค่าจริง
                        }
                    }
                    // ช่วง 28/12 - 04/01: ไม่มีเป้าหมาย (targetValue = 0)
                    
                    targetData.push(targetValue);
                });
            } else {
                // ใช้ข้อมูลเฉพาะเขต
                const zoneData = processedData.report[selectedZone];
                const zoneTarget = processedData.target[selectedZone];
                
                if (zoneData) {
                    dates.forEach((date, index) => {
                        const dateKey = date.toISOString().split('T')[0];
                        dailyData.push(zoneData.dailyData[dateKey] || 0);
                        cumulativeData.push(zoneData.cumulativeData[dateKey] || 0);
                        
                        // กำหนดเป้าหมายตามช่วงวันที่ - แก้ไขตามข้อกำหนดใหม่
                        const day = dateDetails[index].day;
                        const month = dateDetails[index].month;
                        
                        let targetValue = 0;
                        
                        if (zoneTarget) {
                            // ช่วง STD 14/12: 07/12 - 27/12 (แก้ไขจาก 28 เป็น 27)
                            if (month === 12 && day >= 7 && day <= 27) {
                                targetValue = zoneTarget.std1412 || 0; // ไม่หารจำนวนวัน ใช้ค่าจริง
                            }
                            // ช่วง STD 5/1: 05/01 - 20/01
                            else if (month === 1 && day >= 5 && day <= 20) {
                                targetValue = zoneTarget.std51 || 0; // ไม่หารจำนวนวัน ใช้ค่าจริง
                            }
                            // ช่วง STD 21/1: 21/01 - 31/03
                            else if ((month === 1 && day >= 21) || month === 2 || (month === 3 && day <= 31)) {
                                targetValue = zoneTarget.std211 || 0; // ไม่หารจำนวนวัน ใช้ค่าจริง
                            }
                            // ช่วง 28/12 - 04/01: ไม่มีเป้าหมาย (targetValue = 0)
                        }
                        
                        targetData.push(targetValue);
                    });
                }
            }
            
            return {
                dateLabels: dateLabels,
                dailyData: dailyData,
                cumulativeData: cumulativeData,
                targetData: targetData,
                dateDetails: dateDetails
            };
        }
        
        // ฟังก์ชันสร้างกราฟ - แก้ไขตามข้อกำหนดเป้าหมายใหม่
        function createChart(chartData, selectedZone) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // ลบกราฟเก่าถ้ามี
            if (mainChart) {
                mainChart.destroy();
            }
            
            // ตั้งค่าชื่อกราฟ
            const zoneName = selectedZone === "all" ? "ทุกเขต" : `เขต ${selectedZone}`;
            chartMainTitle.textContent = `กราฟแสดงผลอ้อยเข้าหีบ - ${zoneName}`;
            
            // หาค่าสูงสุดสำหรับการแบ่งแกน Y
            const maxDaily = Math.max(...chartData.dailyData);
            const maxCumulative = Math.max(...chartData.cumulativeData);
            const maxTarget = Math.max(...chartData.targetData);
            const maxYLeft = Math.max(maxDaily, maxTarget) * 1.1;
            const maxYRight = maxCumulative * 1.1;
            
            // สร้างกราฟ
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.dateLabels,
                    datasets: [
                        // Dataset 1: เป้าหมาย (พื้นหลัง) - แก้ไขตามข้อกำหนดใหม่
                        {
                            type: 'bar',
                            label: 'เป้าหมาย',
                            data: chartData.targetData,
                            backgroundColor: function(context) {
                                const index = context.dataIndex;
                                const day = chartData.dateDetails[index].day;
                                const month = chartData.dateDetails[index].month;
                                
                                // กำหนดสีตามช่วง STD - แก้ไขตามข้อกำหนดใหม่
                                // STD 14/12: 07/12 - 27/12
                                if (month === 12 && day >= 7 && day <= 27) {
                                    return 'rgba(255, 152, 0, 0.3)'; // ส้ม
                                }
                                // STD 5/1: 05/01 - 20/01
                                else if (month === 1 && day >= 5 && day <= 20) {
                                    return 'rgba(156, 39, 176, 0.3)'; // ม่วง
                                }
                                // STD 21/1: 21/01 - 31/03
                                else if ((month === 1 && day >= 21) || month === 2 || (month === 3 && day <= 31)) {
                                    return 'rgba(244, 67, 54, 0.3)'; // แดง
                                }
                                // ช่วงอื่นๆ (28/12-04/01): ไม่มีเป้าหมาย
                                else {
                                    return 'transparent'; // ไม่แสดง
                                }
                            },
                            borderColor: 'transparent',
                            borderWidth: 0,
                            order: 3, // ด้านหลังสุด
                            yAxisID: 'y',
                            barPercentage: 1.0,
                            categoryPercentage: 0.8
                        },
                        // Dataset 2: ตันรายวัน (แท่ง)
                        {
                            type: 'bar',
                            label: 'ตันรายวัน',
                            data: chartData.dailyData,
                            backgroundColor: 'rgba(76, 175, 80, 0.6)',
                            borderColor: 'rgba(76, 175, 80, 1)',
                            borderWidth: 1,
                            order: 1, // หน้าสุด
                            yAxisID: 'y',
                            barPercentage: 0.6,
                            categoryPercentage: 0.6
                        },
                        // Dataset 3: ตันสะสม (เส้น)
                        {
                            type: 'line',
                            label: 'ตันสะสม',
                            data: chartData.cumulativeData,
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.1,
                            order: 2, // กลาง
                            yAxisID: 'y1',
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false // ใช้ legend ภายนอกแทน
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toLocaleString('th-TH') + ' ตัน';
                                    return label;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0 && context.parsed.y > 0) {
                                        // แสดงข้อมูลเป้าหมายเพิ่มเติม
                                        const day = chartData.dateDetails[context.dataIndex].day;
                                        const month = chartData.dateDetails[context.dataIndex].month;
                                        
                                        if (month === 12 && day >= 7 && day <= 27) {
                                            return 'ช่วง STD 14/12';
                                        } else if (month === 1 && day >= 5 && day <= 20) {
                                            return 'ช่วง STD 5/1';
                                        } else if ((month === 1 && day >= 21) || month === 2 || (month === 3 && day <= 31)) {
                                            return 'ช่วง STD 21/1';
                                        }
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'วันที่',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 90,
                                minRotation: 90,
                                font: {
                                    size: 10
                                },
                                callback: function(value, index) {
                                    // แสดงทุกวันที่
                                    return chartData.dateLabels[index];
                                },
                                autoSkip: false
                            },
                            grid: {
                                display: true
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'ตันรายวัน',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            max: maxYLeft,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('th-TH') + ' ตัน';
                                },
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                drawBorder: true
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'ตันสะสม',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: 0,
                            max: maxYRight,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('th-TH') + ' ตัน';
                                },
                                autoSkip: true,
                                maxTicksLimit: 10
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }
        
        // ฟังก์ชันอัพเดทสถิติ
        function updateStatistics(processedData, selectedZone) {
            let totalWeight = 0;
            let targetValue = 0;
            let processingDays = 0;
            
            if (selectedZone === "all") {
                totalWeight = processedData.combined.totalWeight;
                processingDays = processedData.dates.length;
                
                // คำนวณเป้าหมายรวมจากทุกเขต
                const targets = Object.values(processedData.target);
                if (targets.length > 0) {
                    const sum1412 = targets.reduce((acc, t) => acc + (t.std1412 || 0), 0);
                    const sum51 = targets.reduce((acc, t) => acc + (t.std51 || 0), 0);
                    const sum211 = targets.reduce((acc, t) => acc + (t.std211 || 0), 0);
                    targetValue = sum1412 + sum51 + sum211;
                }
            } else {
                const zoneData = processedData.report[selectedZone];
                const zoneTarget = processedData.target[selectedZone];
                
                if (zoneData) {
                    totalWeight = zoneData.totalWeight;
                    processingDays = Object.keys(zoneData.dailyData).length;
                    
                    if (zoneTarget) {
                        targetValue = (zoneTarget.std1412 || 0) + (zoneTarget.std51 || 0) + (zoneTarget.std211 || 0);
                    }
                }
            }
            
            // อัพเดท UI
            document.getElementById('totalWeight').textContent = totalWeight.toLocaleString('th-TH');
            document.getElementById('processingDays').textContent = processingDays.toLocaleString('th-TH');
            
            // คำนวณเปอร์เซ็นต์บรรลุเป้าหมาย
            const achievement = targetValue > 0 ? (totalWeight / targetValue * 100) : 0;
            document.getElementById('targetAchievement').textContent = achievement.toFixed(1) + '%';
            
            // จำนวนรถเข้าหีบ (ประมาณการ)
            const estimatedTrips = Math.ceil(totalWeight / 20); // ประมาณ 20 ตันต่อเที่ยว
            document.getElementById('totalTrips').textContent = estimatedTrips.toLocaleString('th-TH');
        }
        
        // ฟังก์ชันอัพเดทสถานะไฟล์
        function updateFileStatus() {
            const targetUploaded = uploadedFiles.target !== null;
            const reportUploaded = uploadedFiles.report !== null;
            
            // เปิด/ปิดปุ่มประมวลผล
            processBtn.disabled = !(targetUploaded && reportUploaded);
            
            // อัพเดทตัวอย่างข้อมูล
            updateDataPreview();
        }
        
        // ฟังก์ชันอัพเดทตัวอย่างข้อมูล
        function updateDataPreview() {
            if (!uploadedFiles.target && !uploadedFiles.report) {
                previewBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-file-import" style="font-size: 36px; margin-bottom: 15px; display: block;"></i>
                            ยังไม่มีข้อมูล กรุณาอัพโหลดไฟล์เพื่อดูตัวอย่าง
                        </td>
                    </tr>
                `;
                return;
            }
            
            let previewHTML = '';
            
            // แสดงข้อมูลไฟล์ Target
            if (uploadedFiles.target) {
                previewHTML += `
                    <tr>
                        <td><strong>ไฟล์ Target</strong></td>
                        <td>${uploadedFiles.target.name}</td>
                        <td><span class="file-status status-success">อัพโหลดสำเร็จ</span></td>
                    </tr>
                `;
            }
            
            // แสดงข้อมูลไฟล์ Report
            if (uploadedFiles.report) {
                previewHTML += `
                    <tr>
                        <td><strong>ไฟล์รายงานอ้อยเข้าหีบ 68/69</strong></td>
                        <td>${uploadedFiles.report.name}</td>
                        <td><span class="file-status status-success">อัพโหลดสำเร็จ</span></td>
                    </tr>
                `;
            }
            
            previewHTML += `
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px; color: var(--primary);">
                        <i class="fas fa-check-circle"></i> พร้อมประมวลผล: ไฟล์ครบถ้วนตามข้อกำหนด
                    </td>
                </tr>
            `;
            
            previewBody.innerHTML = previewHTML;
        }
        
        // ฟังก์ชันจัดรูปแบบขนาดไฟล์
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ฟังก์ชันแสดงรายการไฟล์
        function updateFileList() {
            fileList.innerHTML = '';
            
            if (uploadedFiles.target) {
                addFileToList(uploadedFiles.target, 'target');
            }
            
            if (uploadedFiles.report) {
                addFileToList(uploadedFiles.report, 'report');
            }
        }
        
        // ฟังก์ชันเพิ่มไฟล์ในรายการ
        function addFileToList(file, type) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            const fileTypeName = type === 'target' ? 'ไฟล์ Target' : 'ไฟล์รายงานอ้อยเข้าหีบ 68/69';
            
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)} • ${fileTypeName}</div>
                    </div>
                </div>
                <div class="file-status status-success">
                    <i class="fas fa-check"></i> สำเร็จ
                </div>
            `;
            
            fileList.appendChild(fileItem);
        }
        
        // ฟังก์ชันจัดการการอัพโหลดไฟล์
        async function handleFileUpload(files) {
            let hasNewFile = false;
            
            for (const file of files) {
                // ตรวจสอบประเภทไฟล์
                if (!isValidFileType(file)) {
                    alert(`ไฟล์ ${file.name} ไม่ใช่ไฟล์ .csv กรุณาอัพโหลดไฟล์ .csv เท่านั้น`);
                    continue;
                }
                
                // ตรวจสอบขนาดไฟล์
                if (!isValidFileSize(file)) {
                    alert(`ไฟล์ ${file.name} มีขนาดเกิน 100MB กรุณาอัพโหลดไฟล์ที่มีขนาดเล็กกว่า`);
                    continue;
                }
                
                // ระบุประเภทไฟล์
                const fileType = getFileType(file.name);
                
                if (fileType === 'target') {
                    uploadedFiles.target = file;
                    hasNewFile = true;
                } else if (fileType === 'report') {
                    uploadedFiles.report = file;
                    hasNewFile = true;
                } else {
                    alert(`ไม่สามารถระบุประเภทไฟล์ ${file.name} ได้ กรุณาตั้งชื่อไฟล์ให้มีคำว่า "Target" หรือ "รายงาน"`);
                }
            }
            
            if (hasNewFile) {
                updateFileList();
                updateFileStatus();
            }
        }
        
        // ฟังก์ชันประมวลผลข้อมูล
        async function processData() {
            // ตรวจสอบว่ามีไฟล์ครบถ้วนหรือไม่
            if (!uploadedFiles.target || !uploadedFiles.report) {
                alert('กรุณาอัพโหลดไฟล์ทั้ง 2 ไฟล์ก่อนดำเนินการ');
                return;
            }
            
            // แสดงสถานะการประมวลผล
            processingStatus.style.display = 'block';
            progressFill.style.width = '10%';
            
            // ซ่อน placeholder และแสดง loading
            dashboardPlaceholder.classList.add('hidden');
            dashboardLoading.classList.remove('hidden');
            
            try {
                // อ่านและแยกข้อมูลจากไฟล์ CSV
                progressFill.style.width = '30%';
                
                const targetData = await parseTargetCSV(uploadedFiles.target);
                progressFill.style.width = '60%';
                
                const reportData = await parseReportCSV(uploadedFiles.report);
                progressFill.style.width = '80%';
                
                // วิเคราะห์ข้อมูล
                processedData = analyzeData(targetData, reportData);
                progressFill.style.width = '100%';
                
                // เตรียมข้อมูลสำหรับกราฟแรก (ทั้งหมด)
                chartData = prepareChartData(processedData, "all");
                
                // แสดงแดชบอร์ด
                setTimeout(() => {
                    processingStatus.style.display = 'none';
                    showDashboard();
                }, 500);
                
            } catch (error) {
                alert(`เกิดข้อผิดพลาดในการประมวลผลข้อมูล: ${error.message}`);
                processingStatus.style.display = 'none';
                dashboardLoading.classList.add('hidden');
                dashboardPlaceholder.classList.remove('hidden');
                progressFill.style.width = '0%';
                console.error(error);
            }
        }
        
        // ฟังก์ชันแสดงแดชบอร์ด
        function showDashboard() {
            // ซ่อน loading และแสดงแดชบอร์ด
            dashboardLoading.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            
            // สร้างกราฟ
            createChart(chartData, selectedZone);
            
            // อัพเดทสถิติ
            updateStatistics(processedData, selectedZone);
        }
        
        // ฟังก์ชันเปลี่ยนเขตที่เลือก
        function changeSelectedZone(zone) {
            // อัพเดทปุ่ม
            document.querySelectorAll('.zone-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.zone === zone) {
                    btn.classList.add('active');
                }
            });
            
            selectedZone = zone;
            
            if (processedData && chartData) {
                // เตรียมข้อมูลใหม่สำหรับเขตที่เลือก
                chartData = prepareChartData(processedData, zone);
                
                // อัพเดทกราฟ
                createChart(chartData, zone);
                
                // อัพเดทสถิติ
                updateStatistics(processedData, zone);
            }
        }
        
        // ฟังก์ชันรีเซ็ตข้อมูล
        function resetData() {
            uploadedFiles = {
                target: null,
                report: null
            };
            
            processedData = null;
            chartData = null;
            
            if (mainChart) {
                mainChart.destroy();
                mainChart = null;
            }
            
            // รีเซ็ต UI
            fileList.innerHTML = '';
            updateFileStatus();
            processingStatus.style.display = 'none';
            progressFill.style.width = '0%';
            
            // ซ่อนแดชบอร์ดและแสดง placeholder
            dashboardContent.classList.add('hidden');
            dashboardLoading.classList.add('hidden');
            dashboardPlaceholder.classList.remove('hidden');
            
            // รีเซ็ตปุ่มเขต
            changeSelectedZone("all");
            
            // รีเซ็ตสถิติ
            document.getElementById('totalWeight').textContent = '0';
            document.getElementById('targetAchievement').textContent = '0%';
            document.getElementById('totalTrips').textContent = '0';
            document.getElementById('processingDays').textContent = '0';
            
            chartMainTitle.textContent = 'กราฟแสดงผลอ้อยเข้าหีบ';
        }
        
        // ฟังก์ชันบันทึกรายงานเป็นภาพ
        function saveReportAsImage() {
            if (!mainChart) {
                alert('กรุณาประมวลผลข้อมูลก่อนบันทึกรายงาน');
                return;
            }
            
            const link = document.createElement('a');
            link.download = `อ้อยเข้าหีบ-เขต${selectedZone}-${new Date().toISOString().slice(0,10)}.png`;
            link.href = document.getElementById('mainChart').toDataURL('image/png');
            link.click();
            
            alert('บันทึกรายงานเป็นภาพเรียบร้อยแล้ว');
        }
        
        // ฟังก์ชันสลับการยุบ/ขยายส่วนอัพโหลด
        function toggleUploadSection() {
            uploadCollapsed = !uploadCollapsed;
            uploadContent.classList.toggle('collapsed', uploadCollapsed);
            uploadHeader.classList.toggle('collapsed', uploadCollapsed);
        }
        
        // ฟังก์ชันสลับการยุบ/ขยายแถบความคืบหน้า
        function toggleProgressSection() {
            progressCollapsed = !progressCollapsed;
            progressContent.classList.toggle('collapsed', progressCollapsed);
            progressHeader.classList.toggle('collapsed', progressCollapsed);
        }
        
        // ฟังก์ชันสลับการยุบ/ขยายตัวอย่างข้อมูล
        function togglePreviewSection() {
            previewCollapsed = !previewCollapsed;
            previewContent.classList.toggle('collapsed', previewCollapsed);
            previewHeader.classList.toggle('collapsed', previewCollapsed);
        }
        
        // ฟังก์ชันสลับการยุบ/ขยายส่วนซ้ายทั้งหมด
        function toggleMainCollapse() {
            isCollapsed = !isCollapsed;
            mainContent.classList.toggle('collapsed', isCollapsed);
            
            // อัพเดทข้อความปุ่ม
            const icon = toggleCollapseBtn.querySelector('i');
            const text = toggleCollapseBtn.querySelector('span') || document.createElement('span');
            
            if (isCollapsed) {
                icon.className = 'fas fa-chevron-right';
                text.textContent = ' ขยายส่วนอัพโหลด';
            } else {
                icon.className = 'fas fa-chevron-left';
                text.textContent = ' ยุบส่วนอัพโหลด';
            }
            
            if (!toggleCollapseBtn.contains(text)) {
                toggleCollapseBtn.appendChild(text);
            }
            
            // ปรับขนาดกราฟเมื่อยุบ/ขยาย
            if (mainChart) {
                setTimeout(() => {
                    mainChart.resize();
                }, 300);
            }
        }
        
        // ฟังก์ชันซูมกราฟ
        function zoomChart(direction) {
            if (!mainChart) return;
            
            const options = mainChart.options;
            if (!options.scales.x.min) {
                options.scales.x.min = 0;
                options.scales.x.max = chartData.dateLabels.length - 1;
            }
            
            const range = options.scales.x.max - options.scales.x.min;
            const zoomFactor = 0.2;
            
            if (direction === 'in' && range > 10) {
                options.scales.x.min += range * zoomFactor / 2;
                options.scales.x.max -= range * zoomFactor / 2;
            } else if (direction === 'out') {
                options.scales.x.min = Math.max(0, options.scales.x.min - range * zoomFactor / 2);
                options.scales.x.max = Math.min(chartData.dateLabels.length - 1, options.scales.x.max + range * zoomFactor / 2);
            }
            
            mainChart.update();
        }
        
        // Event Listeners
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            handleFileUpload(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            handleFileUpload(files);
            
            // รีเซ็ต input file เพื่อให้สามารถเลือกไฟล์เดิมได้อีกครั้ง
            fileInput.value = '';
        });
        
        processBtn.addEventListener('click', processData);
        
        resetBtn.addEventListener('click', resetData);
        
        saveReportBtn.addEventListener('click', saveReportAsImage);
        
        // Event Listeners สำหรับการยุบ/ขยาย
        uploadHeader.addEventListener('click', toggleUploadSection);
        progressHeader.addEventListener('click', toggleProgressSection);
        previewHeader.addEventListener('click', togglePreviewSection);
        toggleCollapseBtn.addEventListener('click', toggleMainCollapse);
        
        // Event Listeners สำหรับปุ่มเขต
        zoneButtons.addEventListener('click', (e) => {
            if (e.target.classList.contains('zone-btn')) {
                const zone = e.target.dataset.zone;
                changeSelectedZone(zone);
            }
        });
        
        // Event Listeners สำหรับปุ่มซูม
        document.getElementById('zoomInBtn').addEventListener('click', () => zoomChart('in'));
        document.getElementById('zoomOutBtn').addEventListener('click', () => zoomChart('out'));
        
        // เริ่มต้นซ่อนแถบความคืบหน้า
        processingStatus.style.display = 'none';
        
        // เริ่มต้นด้วยปุ่ม "รวมทุกเขต" ถูกเลือก
        changeSelectedZone("all");
    </script>
</body>
</html>
