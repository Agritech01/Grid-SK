<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Cane Dashboard 68/69 - Auto Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --light: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #000000; margin-bottom: 0px; line-height: 1.1; font-size: 32px; }
        .dashboard-subtitle { text-align: center; margin-top: 5px; margin-bottom: 0px; line-height: 1.2; }
        .filter-container { display: flex; flex-wrap: nowrap; gap: 4px; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 12px; overflow-x: auto; }
        .btn-zone { flex: 1; padding: 8px 4px; border: 1px solid #cbd5e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; text-align: center; }
        .btn-zone.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-wrapper { background: #fff; padding: 0px 10px; border-radius: 12px; margin-top: -5px; margin-bottom: 10px; }
        .chart-container { position: relative; height: 550px; width: 100%; }
        .slider-container { margin-top: 5px; padding: 8px 15px; display: flex; align-items: center; gap: 15px; background: #f8fafc; border-radius: 8px; }
        .slider-container input { flex-grow: 1; cursor: pointer; height: 8px; border-radius: 5px; background: #dcdde1; outline: none; }
        .zoom-controls { display: flex; gap: 5px; align-items: center; }
        .btn-zoom { background: #fff; border: 1px solid #cbd5e0; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--primary); }
        .btn-zoom.active { background: var(--primary); color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px; }
        .stat-card { padding: 15px; border-radius: 12px; color: #2c3e50; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card.blue { background: linear-gradient(135deg, #D6EAF8, #AED6F1); }
        .stat-card.green { background: linear-gradient(135deg, #D5F5E3, #ABEBC6); }
        .stat-card.purple { background: linear-gradient(135deg, #E8DAEF, #D2B4DE); }
        .stat-card.orange { background: linear-gradient(135deg, #FCF3CF, #FAD7A0); }
        .stat-card.red { background: linear-gradient(135deg, #FADBD8, #F5B7B1); }
        .stat-label { font-size: 0.9em; font-weight: 600; opacity: 0.85; margin-bottom: 5px; }
        .stat-value { font-size: 1.6em; font-weight: bold; }
        .footer-actions { margin-top: 20px; text-align: right; }
        .btn-download { background: #2d3748; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        #loadingOverlay { text-align: center; padding: 100px 20px; font-size: 24px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container" id="dashboardNode">
    <h2 id="dashboardTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69</h2>
    
    <div id="loadingOverlay">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>

    <div id="subTitleArea" class="dashboard-subtitle" style="display:none;">
        <span id="displayZone" style="font-size: 26px; font-weight: bold; color: #FF0000;">‡πÄ‡∏Ç‡∏ï ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</span><br>
        <span id="displayDate" style="font-size: 20px; color: #000000;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...</span>
    </div>
    
    <div class="filter-container" id="zoneFilter" style="display:none;"></div>

    <div id="mainDashboard" style="display:none;">
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="sugarChart"></canvas>
            </div>
            <div class="slider-container" id="controlUI">
                <div class="zoom-controls">
                    <button id="btnZoomIn" class="btn-zoom active" onclick="applyZoom(30, this)">30 ‡∏ß‡∏±‡∏ô</button>
                    <button id="btnZoomOut" class="btn-zoom" onclick="applyZoom('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <input type="range" id="chartSlider" min="0" value="0">
                <span id="sliderValue" style="font-size: 11px; color: #666; width: 90px;"></span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card blue"><div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardTarget">-</div></div>
            <div class="stat-card green"><div class="stat-label">‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏° (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardAcc">-</div></div>
            <div class="stat-card orange"><div class="stat-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div><div class="stat-value" id="cardPercent">-</div></div>
            <div class="stat-card red"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardRemain">-</div></div>
            <div class="stat-card purple"><div class="stat-label">‡∏ï‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô (5D)</div><div class="stat-value" id="cardAvg5D">-</div></div>
        </div>
     
        <div class="footer-actions">
            <button class="btn-download" onclick="exportImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
</div>

<script>
    // --- 1. ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏à‡∏≤‡∏Å Google Sheets ---
    const TARGET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBzyNUXjGTBy8z0Hv5jxHk6tKYlYQhBtwg9sPVqqNm8sqxVJ_JljWq2f9JodvZR41Rv65gcvgdNebi/pub?output=csv';
    const ACTUAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyMB_Fxk8PoDzl11U1tbzse2ANnNhh4iROwMXB5LFHGksPLo7aX2I1LniuEd9s-5dkO0FG3focFDzA/pub?output=csv';

    Chart.register(ChartDataLabels);
    let rawTarget = [];
    let rawActual = [];
    let myChart = null;
    let currentViewRange = 30;
    const zones = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12", "21", "C1", "C2", "C3", "C4"];

    window.onload = async function() {
        const status = document.getElementById('loadingOverlay');
        try {
            console.log("Fetching Target Data...");
            const targetRes = await fetch(TARGET_CSV_URL);
            const targetText = await targetRes.text();

            console.log("Fetching Actual Data...");
            const actualRes = await fetch(ACTUAL_CSV_URL);
            const actualText = await actualRes.text();

            if (targetText.includes("<!DOCTYPE html>")) throw new Error("Link Target ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV");

            Papa.parse(targetText, {
                header: true, skipEmptyLines: true, transformHeader: (h) => h.trim(),
                complete: function(tResults) {
                    rawTarget = tResults.data;
                    console.log("Target Data Loaded:", rawTarget.length, "rows");

                    Papa.parse(actualText, {
                        header: true, skipEmptyLines: true, transformHeader: (h) => h.trim(),
                        complete: function(aResults) {
                            rawActual = aResults.data;
                            console.log("Actual Data Loaded:", rawActual.length, "rows");
                            status.style.display = 'none';
                            initDashboard();
                        }
                    });
                }
            });
        } catch (error) {
            status.innerHTML = `‚ùå Error: ${error.message}<br><small>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£ Publish</small>`;
            console.error("Fetch Error:", error);
        }
    };

    function initDashboard() {
        initFilterButtons();
        document.getElementById('zoneFilter').style.display = 'flex';
        document.getElementById('mainDashboard').style.display = 'block';
        document.getElementById('subTitleArea').style.display = 'block';
        updateDashboard('‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï');
    }

    function initFilterButtons() {
        const container = document.getElementById('zoneFilter');
        container.innerHTML = `<button class="btn-zone active" onclick="changeZone(this, '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï')">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</button>`;
        zones.forEach(z => { container.innerHTML += `<button class="btn-zone" onclick="changeZone(this, '${z}')">‡πÄ‡∏Ç‡∏ï ${z}</button>`; });
    }

    function changeZone(btn, zone) {
        document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(zone);
    }

    function generateDateRange() {
        let dates = [], start = new Date(1968, 11, 7, 12, 0, 0), end = new Date(1969, 2, 31, 12, 0, 0), current = new Date(start);
        while (current <= end) { dates.push(new Date(current)); current.setDate(current.getDate() + 1); }
        return dates;
    }

    function updateDashboard(selectedZone) {
        const zoneText = selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? selectedZone : `‡πÄ‡∏Ç‡∏ï ${selectedZone}`;
        document.getElementById('displayZone').innerText = zoneText;
        const dates = generateDateRange();
        let targetMax = 0, std1 = 0, std2 = 0, std3 = 0, std4 = 0;
        const parseNum = (v) => parseFloat(String(v || "").replace(/[^0-9.-]/g, '')) || 0;

        rawTarget.forEach(row => {
            if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                targetMax += parseNum(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]);
                std1 += parseNum(row["STD 14/12"]);
                std2 += parseNum(row["STD 5/1"]);
                std3 += parseNum(row["STD 21/1"]);
                std4 += parseNum(row["STD 10/02"]);
            }
        });

        const targetSeries = dates.map(d => {
            const y = d.getFullYear(), m = d.getMonth() + 1, day = d.getDate();
            if (y === 1968 && m === 12 && day >= 7) return std1;
            if (y === 1969 && m === 1 && day <= 20) return std2;
            if (y === 1969 && ((m === 1 && day >= 21) || (m === 2 && day <= 9))) return std3;
            if (y === 1969 && (m >= 2 && day >= 10)) return std4;
            return 0;
        });

        let lastDataIdx = -1;
        const actualDaily = dates.map((d, idx) => {
            const searchKey = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            let daySum = 0, found = false;
            rawActual.forEach(row => {
                if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                    const val = row[searchKey];
                    if (val !== undefined && val !== null && String(val).trim() !== "") {
                        daySum += parseNum(val);
                        found = true;
                    }
                }
            });
            if (found) lastDataIdx = idx;
            return daySum;
        });

        if (lastDataIdx !== -1) {
            const lastDateObj = dates[lastDataIdx];
            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            document.getElementById('displayDate').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${lastDateObj.getDate()} ${thaiMonths[lastDateObj.getMonth()]} ${lastDateObj.getFullYear() + 543}`;
        }

        let accSum = 0, actualAcc = [];
        for (let i = 0; i <= lastDataIdx; i++) { accSum += actualDaily[i]; actualAcc.push(accSum); }
        
        const projectionLine = new Array(actualAcc.length > 0 ? actualAcc.length - 1 : 0).fill(null);
        if (actualAcc.length > 0) projectionLine.push(accSum);
        if (lastDataIdx < dates.length - 1 && lastDataIdx !== -1) {
            let remTarget = Math.max(0, targetMax - accSum), remDays = (dates.length - 1) - lastDataIdx, dailyProj = remTarget / remDays, tempAcc = accSum;
            for (let i = lastDataIdx + 1; i < dates.length; i++) { tempAcc += dailyProj; projectionLine.push(tempAcc); }
        }

        document.getElementById('cardTarget').innerText = Math.round(targetMax).toLocaleString();
        document.getElementById('cardAcc').innerText = Math.round(accSum).toLocaleString();
        document.getElementById('cardPercent').innerText = ((accSum / (targetMax || 1)) * 100).toFixed(2) + "%";
        document.getElementById('cardRemain').innerText = Math.max(0, Math.round(targetMax - accSum)).toLocaleString();
        
        let sum5D = 0, count5D = 0;
        for(let i=lastDataIdx; i > lastDataIdx-5 && i >= 0; i--) { sum5D += actualDaily[i]; count5D++; }
        document.getElementById('cardAvg5D').innerText = count5D > 0 ? Math.round(sum5D/count5D).toLocaleString() : "0";

        renderChart(dates, targetSeries, actualDaily, actualAcc, projectionLine, lastDataIdx);
    }

    function isValidZone(rowZone, selectedZone) {
        const cleanRowZone = String(rowZone || "").trim();
        return selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? zones.includes(cleanRowZone) : cleanRowZone === selectedZone;
    }

    function renderChart(dates, targets, daily, acc, proj, lastIdx) {
        const labels = dates.map(d => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}`);
        const ctx = document.getElementById('sugarChart').getContext('2d');
        const slider = document.getElementById('chartSlider');
        const maxScroll = Math.max(0, labels.length - currentViewRange);
        slider.max = maxScroll;

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    { type: 'line', label: '‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°', data: acc, borderColor: '#27ae60', borderWidth: 3, yAxisID: 'yAcc', pointRadius: (c) => c.dataIndex === lastIdx ? 5 : 0, pointBackgroundColor: 'red', datalabels: { display: (c) => c.dataIndex === lastIdx, align: 'top', backgroundColor: '#33CCCC', color: 'white', borderRadius: 4, padding: 6, font: { weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } },
                    { type: 'line', label: '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå', data: proj, borderColor: '#27ae60', borderDash: [5, 5], yAxisID: 'yAcc', pointRadius: 0, datalabels: { display: (c) => c.dataIndex === proj.length - 1, align: 'right', backgroundColor: '#4682B4', color: 'white', borderRadius: 4, padding: 6, font: { weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } },
                    { type: 'bar', label: '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', data: daily.slice(0, lastIdx + 1), backgroundColor: '#3498db', yAxisID: 'yDaily', datalabels: { display: (c) => c.dataIndex === lastIdx, anchor: 'end', align: 'top', color: '#3498db', font: { weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } },
                    { type: 'bar', label: '‡πÄ‡∏õ‡πâ‡∏≤ STD', data: targets, backgroundColor: 'rgba(200, 200, 200, 0.3)', yAxisID: 'yDaily', datalabels: { display: false } }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { mode: 'index', intersect: false }, datalabels: { formatter: (v) => v ? Math.round(v).toLocaleString() : null } },
                scales: {
                    x: { min: parseInt(slider.value), max: parseInt(slider.value) + currentViewRange - 1, ticks: { font: { size: 9 } } },
                    yDaily: { beginAtZero: true },
                    yAcc: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                }
            }
        });
        slider.oninput = function() { updateChartRange(parseInt(this.value)); };
        updateChartRange(parseInt(slider.value));
    }

    function updateChartRange(val) {
        myChart.options.scales.x.min = val;
        myChart.options.scales.x.max = val + currentViewRange - 1;
        document.getElementById('sliderValue').innerText = `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${val + 1}-${Math.min(val + currentViewRange, myChart.data.labels.length)}`;
        myChart.update('none');
    }

    function applyZoom(mode, btn) {
        currentViewRange = (mode === 'all') ? myChart.data.labels.length : mode;
        document.querySelectorAll('.btn-zoom').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateChartRange(0);
    }

    function exportImage() {
        const node = document.getElementById('dashboardNode');
        const elementsToHide = ['#controlUI', '.footer-actions', '.filter-container'];
        elementsToHide.forEach(s => { if(document.querySelector(s)) document.querySelector(s).style.display = 'none'; });
        html2canvas(node, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Sugar_Report.png'; link.href = canvas.toDataURL(); link.click();
            elementsToHide.forEach(s => { if(document.querySelector(s)) document.querySelector(s).style.display = (s==='.filter-container'?'flex':'block'); });
        });
    }
</script>
</body>
</html>
