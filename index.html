<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดรายงานอ้อยเข้าหีบ ปี 68/69</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c6e49 0%, #4c956c 100%);
            color: white;
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.5rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .logo p {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .date-display {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .upload-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }
        
        .upload-card h3 {
            color: #2c6e49;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }
        
        .upload-card h3 i {
            color: #4c956c;
        }
        
        .required-columns {
            background-color: #f8f9fa;
            border-left: 4px solid #4c956c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .required-columns h4 {
            margin-bottom: 8px;
            color: #555;
        }
        
        .required-columns ul {
            padding-left: 20px;
            color: #666;
        }
        
        .required-columns li {
            margin-bottom: 5px;
        }
        
        .file-upload-area {
            border: 2px dashed #c1c7d0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #fafbfc;
        }
        
        .file-upload-area:hover {
            border-color: #4c956c;
            background-color: #f0f7f3;
        }
        
        .file-upload-area i {
            font-size: 3rem;
            color: #7a8b94;
            margin-bottom: 15px;
        }
        
        .file-upload-area.dragover {
            border-color: #2c6e49;
            background-color: #e8f4ee;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            text-align: left;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .process-btn {
            background-color: #2c6e49;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            width: 100%;
        }
        
        .process-btn:hover {
            background-color: #245c3d;
        }
        
        .process-btn:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        }
        
        .chart-container h3 {
            color: #2c6e49;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .summary-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #4c956c;
        }
        
        .summary-card h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .summary-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c6e49;
        }
        
        .summary-card .subtext {
            font-size: 0.9rem;
            color: #777;
            margin-top: 5px;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .action-btn.save {
            background-color: #2c6e49;
            color: white;
        }
        
        .action-btn.save:hover {
            background-color: #245c3d;
        }
        
        .action-btn.reset {
            background-color: #f8f9fa;
            color: #555;
        }
        
        .action-btn.reset:hover {
            background-color: #e9ecef;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading.active {
            display: flex;
        }
        
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #2c6e49;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border-left: 5px solid #c3e6cb;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #f5c6cb;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        .data-table th {
            background-color: #2c6e49;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background-color: #f5f9f7;
        }
        
        .debug-info {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        @media (max-width: 992px) {
            .upload-section, .dashboard {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <div>
                        <h1>แดชบอร์ดรายงานอ้อยเข้าหีบ ปี 68/69</h1>
                        <p>สำหรับผู้บริหาร - ระบบวิเคราะห์และติดตามเป้าหมายอ้อยเข้าหีบ</p>
                    </div>
                </div>
                <div class="date-display" id="currentDate"></div>
            </div>
        </header>
        
        <div class="alert" id="alertMessage"></div>
        
        <section class="upload-section">
            <div class="upload-card">
                <h3><i class="fas fa-bullseye"></i> อัพโหลดไฟล์ TARGET</h3>
                <div class="required-columns">
                    <h4>คอลัมน์ที่จำเป็นในไฟล์ (ยืดหยุ่นชื่อ):</h4>
                    <ul>
                        <li>ประเมิน 14/12 หรือ ประเมิน14/12 (ตัน)</li>
                        <li>ประเมิน 5/1 หรือ ประเมิน5/1 (ตัน)</li>
                        <li>ประเมิน 21/1 หรือ ประเมิน21/1 (ตัน)</li>
                        <li>STD 14/12 หรือ STD14/12 (ตัน)</li>
                        <li>STD 5/1 หรือ STD5/1 (ตัน)</li>
                        <li>STD 21/1 หรือ STD21/1 (ตัน)</li>
                    </ul>
                    <p><small>หมายเหตุ: ระบบสามารถอ่านชื่อคอลัมน์ที่มีรูปแบบต่างกันได้</small></p>
                </div>
                <div class="file-upload-area" id="targetUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p><strong>คลิกหรือลากไฟล์ CSV ที่นี้</strong></p>
                    <p>ขนาดไฟล์ไม่เกิน 100MB</p>
                    <p id="targetFileName">ยังไม่ได้เลือกไฟล์</p>
                </div>
                <div class="file-info" id="targetFileInfo"></div>
                <input type="file" id="targetFileInput" accept=".csv" style="display: none;">
                <button id="showTargetDebug" class="process-btn" style="margin-top: 10px; background-color: #6c757d; display: none;">
                    <i class="fas fa-bug"></i> แสดงข้อมูล Debug ไฟล์ TARGET
                </button>
                <div class="debug-info" id="targetDebugInfo"></div>
            </div>
            
            <div class="upload-card">
                <h3><i class="fas fa-file-csv"></i> อัพโหลดไฟล์รายงานอ้อยเข้าหีบ 68/69</h3>
                <div class="required-columns">
                    <h4>รูปแบบไฟล์รายงาน:</h4>
                    <ul>
                        <li>แถวที่ 1: ชื่อคอลัมน์ (วันที่)</li>
                        <li>แถวที่ 2: ข้อมูลวันที่จริง เริ่มจากคอลัมน์ F1 ถึง DP1</li>
                        <li>รูปแบบวันที่: DD/MM/YY</li>
                        <li>เริ่ม: 07/12/68, สิ้นสุด: 31/03/69</li>
                        <li>แถวที่ 7,503: ข้อมูลตันสะสมรายวัน</li>
                    </ul>
                </div>
                <div class="file-upload-area" id="reportUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p><strong>คลิกหรือลากไฟล์ CSV ที่นี้</strong></p>
                    <p>ขนาดไฟล์ไม่เกิน 100MB</p>
                    <p id="reportFileName">ยังไม่ได้เลือกไฟล์</p>
                </div>
                <div class="file-info" id="reportFileInfo"></div>
                <input type="file" id="reportFileInput" accept=".csv" style="display: none;">
            </div>
        </section>
        
        <button class="process-btn" id="processDataBtn" disabled>
            <i class="fas fa-cogs"></i> ประมวลผลข้อมูลและสร้างรายงาน
        </button>
        
        <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
                <i class="fas fa-weight-hanging"></i>
                <h4>เป้าหมายประเมิน 14/12</h4>
                <div class="value" id="target1">0</div>
                <div class="subtext">ตัน</div>
            </div>
            
            <div class="summary-card">
                <i class="fas fa-weight-hanging"></i>
                <h4>เป้าหมายประเมิน 5/1</h4>
                <div class="value" id="target2">0</div>
                <div class="subtext">ตัน</div>
            </div>
            
            <div class="summary-card">
                <i class="fas fa-weight-hanging"></i>
                <h4>เป้าหมายประเมิน 21/1</h4>
                <div class="value" id="target3">0</div>
                <div class="subtext">ตัน</div>
            </div>
            
            <div class="summary-card">
                <i class="fas fa-chart-bar"></i>
                <h4>อ้อยเข้าหีบสะสม</h4>
                <div class="value" id="totalCane">0</div>
                <div class="subtext">ตัน</div>
            </div>
        </div>
        
        <section class="dashboard" id="dashboard" style="display: none;">
            <div class="chart-container">
                <h3><i class="fas fa-chart-line"></i> เปรียบเทียบเป้าหมายกับผลปฏิบัติงาน</h3>
                <div class="chart-wrapper">
                    <canvas id="targetVsActualChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3><i class="fas fa-chart-area"></i> อ้อยเข้าหีบสะสมรายวัน</h3>
                <div class="chart-wrapper">
                    <canvas id="dailyCumulativeChart"></canvas>
                </div>
            </div>
        </section>
        
        <div id="dataPreview" style="display: none;">
            <h3><i class="fas fa-table"></i> ตัวอย่างข้อมูลที่อ่านได้</h3>
            <div class="chart-container">
                <h4>ข้อมูลวันที่ (แถวที่ 2)</h4>
                <div id="dateDataPreview" class="data-preview"></div>
                
                <h4 style="margin-top: 20px;">ข้อมูลตันสะสม (แถวที่ 7,503)</h4>
                <div id="tonDataPreview" class="data-preview"></div>
            </div>
        </div>
        
        <div class="actions" id="actionButtons" style="display: none;">
            <button class="action-btn save" id="saveReportBtn">
                <i class="fas fa-save"></i> บันทึกรายงาน
            </button>
            <button class="action-btn reset" id="resetBtn">
                <i class="fas fa-redo"></i> รีเซ็ตข้อมูล
            </button>
        </div>
        
        <footer>
            <p>ระบบแดชบอร์ดรายงานอ้อยเข้าหีบ ปี 68/69 | สำหรับผู้บริหาร</p>
            <p>พัฒนาเพื่อใช้ในการติดตามและวิเคราะห์ข้อมูลอ้อยเข้าหีบ</p>
        </footer>
    </div>

    <script>
        // ตัวแปรสำหรับเก็บข้อมูล
        let targetData = null;
        let reportData = null;
        let targetChart = null;
        let cumulativeChart = null;
        
        // อัพเดทวันที่ปัจจุบัน
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                timeZone: 'Asia/Bangkok'
            };
            const thaiDate = now.toLocaleDateString('th-TH', options);
            document.getElementById('currentDate').textContent = thaiDate;
        }
        
        // แสดง/ซ่อน loading
        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }
        
        // แสดงข้อความแจ้งเตือน
        function showAlert(message, type) {
            const alertElement = document.getElementById('alertMessage');
            alertElement.textContent = message;
            alertElement.className = `alert ${type}`;
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
        
        // ตั้งค่าการอัพโหลดไฟล์
        function setupFileUpload(uploadAreaId, fileInputId, fileNameId, fileInfoId) {
            const uploadArea = document.getElementById(uploadAreaId);
            const fileInput = document.getElementById(fileInputId);
            const fileName = document.getElementById(fileNameId);
            const fileInfo = document.getElementById(fileInfoId);
            
            // คลิกที่พื้นที่อัพโหลด
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // เมื่อเลือกไฟล์
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    handleFileSelect(file, uploadAreaId, fileName, fileInfo);
                    
                    // แสดงปุ่ม debug สำหรับไฟล์ TARGET
                    if (fileInputId === 'targetFileInput') {
                        document.getElementById('showTargetDebug').style.display = 'block';
                    }
                }
            });
            
            // ลากไฟล์มาวาง
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    const file = e.dataTransfer.files[0];
                    handleFileSelect(file, uploadAreaId, fileName, fileInfo);
                    fileInput.files = e.dataTransfer.files;
                    
                    // แสดงปุ่ม debug สำหรับไฟล์ TARGET
                    if (fileInputId === 'targetFileInput') {
                        document.getElementById('showTargetDebug').style.display = 'block';
                    }
                }
            });
        }
        
        // จัดการเมื่อเลือกไฟล์
        function handleFileSelect(file, uploadAreaId, fileNameElement, fileInfoElement) {
            // ตรวจสอบประเภทไฟล์
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showAlert('ไฟล์ต้องเป็นประเภท .CSV เท่านั้น', 'error');
                return;
            }
            
            // ตรวจสอบขนาดไฟล์ (100MB)
            if (file.size > 100 * 1024 * 1024) {
                showAlert('ขนาดไฟล์ต้องไม่เกิน 100MB', 'error');
                return;
            }
            
            fileNameElement.textContent = `เลือกแล้ว: ${file.name} (${formatFileSize(file.size)})`;
            fileInfoElement.innerHTML = `
                <p><strong>ชื่อไฟล์:</strong> ${file.name}</p>
                <p><strong>ขนาด:</strong> ${formatFileSize(file.size)}</p>
                <p><strong>ประเภท:</strong> ${file.type || 'CSV'}</p>
            `;
            fileInfoElement.classList.add('show');
            
            // ตรวจสอบว่ามีไฟล์ทั้งสองแล้วหรือยัง
            checkFilesReady();
        }
        
        // ฟอร์แมตขนาดไฟล์
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ตรวจสอบว่ามีไฟล์ทั้งสองแล้วหรือยัง
        function checkFilesReady() {
            const targetFile = document.getElementById('targetFileInput').files[0];
            const reportFile = document.getElementById('reportFileInput').files[0];
            const processBtn = document.getElementById('processDataBtn');
            
            if (targetFile && reportFile) {
                processBtn.disabled = false;
            }
        }
        
        // อ่านและประมวลผลไฟล์ CSV
        async function processCSV(file, type) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    encoding: 'UTF-8',
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.warn('ข้อผิดพลาดในการอ่าน CSV:', results.errors);
                        }
                        
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(new Error('เกิดข้อผิดพลาดในการอ่านไฟล์: ' + error.message));
                    }
                });
            });
        }
        
        // แสดงข้อมูล debug สำหรับไฟล์ TARGET
        function showTargetDebugInfo() {
            const targetFile = document.getElementById('targetFileInput').files[0];
            if (!targetFile) {
                showAlert('กรุณาเลือกไฟล์ TARGET ก่อน', 'error');
                return;
            }
            
            showLoading(true);
            
            processCSV(targetFile, 'target').then(data => {
                const debugInfo = document.getElementById('targetDebugInfo');
                let debugHTML = '<h4>ข้อมูล Debug ไฟล์ TARGET:</h4>';
                
                // แสดงจำนวนแถวและคอลัมน์
                debugHTML += `<p><strong>จำนวนแถว:</strong> ${data.length}</p>`;
                
                if (data.length > 0) {
                    debugHTML += `<p><strong>จำนวนคอลัมน์ในแถวแรก:</strong> ${data[0].length}</p>`;
                    
                    // แสดงชื่อคอลัมน์ทั้งหมด (แถวแรก)
                    debugHTML += '<h5>ชื่อคอลัมน์ทั้งหมด (แถวที่ 1):</h5>';
                    debugHTML += '<table class="data-table"><thead><tr><th>ลำดับ</th><th>ชื่อคอลัมน์</th><th>ค่าตัวอย่าง</th></tr></thead><tbody>';
                    
                    const headers = data[0];
                    const firstDataRow = data.length > 1 ? data[1] : [];
                    
                    for (let i = 0; i < headers.length; i++) {
                        const header = headers[i] || `[คอลัมน์ที่ ${i+1}]`;
                        const sampleValue = firstDataRow[i] || '';
                        debugHTML += `<tr><td>${i+1}</td><td><strong>"${header}"</strong></td><td>${sampleValue}</td></tr>`;
                    }
                    
                    debugHTML += '</tbody></table>';
                    
                    // วิเคราะห์คอลัมน์ที่พบ
                    debugHTML += '<h5>คอลัมน์ที่พบตามคำค้นหา:</h5>';
                    debugHTML += '<table class="data-table"><thead><tr><th>คำค้นหา</th><th>พบคอลัมน์</th><th>สถานะ</th></tr></thead><tbody>';
                    
                    const searchTerms = [
                        { key: 'ประเมิน 14/12', terms: ['ประเมิน 14/12', 'ประเมิน14/12', 'ประเมิน1412'] },
                        { key: 'ประเมิน 5/1', terms: ['ประเมิน 5/1', 'ประเมิน5/1', 'ประเมิน51'] },
                        { key: 'ประเมิน 21/1', terms: ['ประเมิน 21/1', 'ประเมิน21/1', 'ประเมิน211'] },
                        { key: 'STD 14/12', terms: ['STD 14/12', 'STD14/12', 'STD1412', 'std 14/12', 'std14/12'] },
                        { key: 'STD 5/1', terms: ['STD 5/1', 'STD5/1', 'STD51', 'std 5/1', 'std5/1'] },
                        { key: 'STD 21/1', terms: ['STD 21/1', 'STD21/1', 'STD211', 'std 21/1', 'std21/1'] }
                    ];
                    
                    searchTerms.forEach(search => {
                        let foundColumn = null;
                        let foundIndex = -1;
                        
                        for (let i = 0; i < headers.length; i++) {
                            const header = headers[i] || '';
                            const headerLower = header.toLowerCase().replace(/\s+/g, '');
                            
                            for (const term of search.terms) {
                                const termLower = term.toLowerCase().replace(/\s+/g, '');
                                if (headerLower.includes(termLower)) {
                                    foundColumn = header;
                                    foundIndex = i;
                                    break;
                                }
                            }
                            
                            if (foundColumn) break;
                        }
                        
                        const status = foundColumn ? '✓ พบ' : '✗ ไม่พบ';
                        const statusClass = foundColumn ? 'style="color: green;"' : 'style="color: red;"';
                        debugHTML += `<tr>
                            <td>${search.key}</td>
                            <td>${foundColumn || '-'}</td>
                            <td ${statusClass}>${status}</td>
                        </tr>`;
                    });
                    
                    debugHTML += '</tbody></table>';
                    
                    // แสดงตัวอย่างข้อมูลบางแถว
                    debugHTML += '<h5>ตัวอย่างข้อมูล (5 แถวแรก):</h5>';
                    debugHTML += '<table class="data-table"><thead><tr>';
                    
                    // หัวตาราง
                    for (let i = 0; i < Math.min(10, headers.length); i++) {
                        debugHTML += `<th>${headers[i] || `คอลัมน์ ${i+1}`}</th>`;
                    }
                    debugHTML += '</tr></thead><tbody>';
                    
                    // ข้อมูล
                    for (let row = 1; row < Math.min(6, data.length); row++) {
                        debugHTML += '<tr>';
                        for (let col = 0; col < Math.min(10, headers.length); col++) {
                            debugHTML += `<td>${data[row][col] || ''}</td>`;
                        }
                        debugHTML += '</tr>';
                    }
                    
                    debugHTML += '</tbody></table>';
                } else {
                    debugHTML += '<p style="color: red;">ไฟล์ว่างเปล่าหรือไม่มีข้อมูล</p>';
                }
                
                debugInfo.innerHTML = debugHTML;
                debugInfo.classList.add('show');
                
                showLoading(false);
            }).catch(error => {
                showAlert('ไม่สามารถอ่านไฟล์เพื่อ debug: ' + error.message, 'error');
                showLoading(false);
            });
        }
        
        // ค้นหาคอลัมน์ด้วยชื่อแบบยืดหยุ่น
        function findColumnIndex(headers, searchPatterns) {
            if (!headers || !Array.isArray(headers)) return -1;
            
            for (let i = 0; i < headers.length; i++) {
                const header = String(headers[i] || '').trim();
                const headerNormalized = header.toLowerCase().replace(/\s+/g, '');
                
                for (const pattern of searchPatterns) {
                    const patternNormalized = pattern.toLowerCase().replace(/\s+/g, '');
                    if (headerNormalized.includes(patternNormalized)) {
                        return i;
                    }
                }
            }
            
            return -1;
        }
        
        // ประมวลผลข้อมูล
        async function processData() {
            const targetFile = document.getElementById('targetFileInput').files[0];
            const reportFile = document.getElementById('reportFileInput').files[0];
            
            if (!targetFile || !reportFile) {
                showAlert('กรุณาเลือกไฟล์ทั้งสองประเภทก่อน', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // อ่านไฟล์ TARGET
                const targetResult = await processCSV(targetFile, 'target');
                targetData = targetResult;
                
                // อ่านไฟล์รายงานอ้อยเข้าหีบ
                const reportResult = await processCSV(reportFile, 'report');
                reportData = reportResult;
                
                // ตรวจสอบข้อมูล TARGET
                if (targetResult.length < 2) {
                    throw new Error('ไฟล์ TARGET ไม่มีข้อมูลเพียงพอ (ต้องการอย่างน้อย 2 แถว)');
                }
                
                // ตรวจสอบคอลัมน์ TARGET ด้วยวิธียืดหยุ่น
                const targetHeaders = targetResult[0];
                console.log('คอลัมน์ทั้งหมดในไฟล์ TARGET:', targetHeaders);
                
                // กำหนด pattern การค้นหาแบบยืดหยุ่น
                const columnPatterns = {
                    'target1': ['ประเมิน 14/12', 'ประเมิน14/12', 'ประเมิน1412'],
                    'target2': ['ประเมิน 5/1', 'ประเมิน5/1', 'ประเมิน51'],
                    'target3': ['ประเมิน 21/1', 'ประเมิน21/1', 'ประเมิน211'],
                    'std1': ['STD 14/12', 'STD14/12', 'STD1412', 'std 14/12', 'std14/12'],
                    'std2': ['STD 5/1', 'STD5/1', 'STD51', 'std 5/1', 'std5/1'],
                    'std3': ['STD 21/1', 'STD21/1', 'STD211', 'std 21/1', 'std21/1']
                };
                
                // ค้นหาดัชนีคอลัมน์ทั้งหมด
                const columnIndices = {};
                let missingColumns = [];
                
                for (const [key, patterns] of Object.entries(columnPatterns)) {
                    const index = findColumnIndex(targetHeaders, patterns);
                    if (index >= 0) {
                        columnIndices[key] = index;
                        console.log(`พบคอลัมน์ ${key} ที่ดัชนี ${index}: "${targetHeaders[index]}"`);
                    } else {
                        missingColumns.push(key);
                    }
                }
                
                // ถ้าพบคอลัมน์ที่จำเป็นไม่ครบ
                if (missingColumns.length > 0 && missingColumns.includes('std1')) {
                    console.warn('ไม่พบคอลัมน์ STD บางส่วน:', missingColumns);
                    // พยายามค้นหาอีกครั้งด้วย pattern อื่น
                    const alternativePatterns = {
                        'std1': ['14/12', '1412'],
                        'std2': ['5/1', '51'],
                        'std3': ['21/1', '211']
                    };
                    
                    for (const key of missingColumns.slice()) {
                        if (alternativePatterns[key]) {
                            const index = findColumnIndex(targetHeaders, alternativePatterns[key]);
                            if (index >= 0) {
                                columnIndices[key] = index;
                                console.log(`พบคอลัมน์ ${key} แบบทางเลือกที่ดัชนี ${index}: "${targetHeaders[index]}"`);
                                missingColumns = missingColumns.filter(col => col !== key);
                            }
                        }
                    }
                }
                
                // ถ้ายังขาดคอลัมน์ที่สำคัญ (target)
                const essentialColumns = ['target1', 'target2', 'target3'];
                const missingEssential = essentialColumns.filter(col => !columnIndices[col]);
                
                if (missingEssential.length > 0) {
                    throw new Error(`ไม่พบคอลัมน์สำคัญ: ${missingEssential.map(col => columnPatterns[col][0]).join(', ')}`);
                }
                
                // ตรวจสอบข้อมูลรายงานอ้อยเข้าหีบ
                if (reportResult.length < 7503) {
                    throw new Error(`ไฟล์รายงานอ้อยเข้าหีบมีแถวไม่เพียงพอ (พบ ${reportResult.length} แถว, ต้องการอย่างน้อย 7503 แถว)`);
                }
                
                // ประมวลผลข้อมูลและสร้างรายงาน
                generateReport(columnIndices);
                showAlert('ประมวลผลข้อมูลสำเร็จ!', 'success');
                
            } catch (error) {
                showAlert(error.message, 'error');
                console.error('ข้อผิดพลาดในการประมวลผล:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // สร้างรายงานและกราฟ
        function generateReport(columnIndices) {
            // แสดงส่วนผลลัพธ์
            document.getElementById('summaryCards').style.display = 'grid';
            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('actionButtons').style.display = 'flex';
            
            // 1. ดึงข้อมูลเป้าหมายจากไฟล์ TARGET
            const targetValues = extractTargetValues(targetData, columnIndices);
            
            // 2. ดึงข้อมูลอ้อยเข้าหีบจากไฟล์รายงาน
            const reportAnalysis = extractReportData(reportData);
            
            // 3. อัปเดตการ์ดสรุป
            updateSummaryCards(targetValues, reportAnalysis);
            
            // 4. สร้างกราฟ
            createCharts(targetValues, reportAnalysis);
            
            // 5. แสดงตัวอย่างข้อมูล
            showDataPreview(reportAnalysis);
        }
        
        // ดึงข้อมูลเป้าหมายจากไฟล์ TARGET (แบบยืดหยุ่น)
        function extractTargetValues(data, columnIndices) {
            const headers = data[0];
            const firstDataRow = data[1] || [];
            
            // ฟังก์ชันช่วยอ่านค่าจากคอลัมน์
            const getValue = (key) => {
                const index = columnIndices[key];
                if (index !== undefined && index >= 0 && firstDataRow[index] !== undefined) {
                    const value = firstDataRow[index];
                    // ลองแปลงเป็นตัวเลข
                    const numValue = parseFloat(String(value).replace(/,/g, ''));
                    return isNaN(numValue) ? 0 : numValue;
                }
                return 0;
            };
            
            return {
                target1: getValue('target1'),
                target2: getValue('target2'),
                target3: getValue('target3'),
                std1: getValue('std1'),
                std2: getValue('std2'),
                std3: getValue('std3')
            };
        }
        
        // ดึงข้อมูลจากไฟล์รายงานอ้อยเข้าหีบ
        function extractReportData(data) {
            // แถวที่ 1: ชื่อคอลัมน์ (วันที่)
            const dateHeaders = data[0] || [];
            
            // แถวที่ 2: ข้อมูลวันที่จริง (เริ่มจากคอลัมน์ F ถึง DP)
            const dateRow = data[1] || [];
            
            // แถวที่ 7,503: ข้อมูลตันสะสมรายวัน
            const tonRow = data[7502] || []; // index 7502 = แถวที่ 7503 (0-based index)
            
            // สร้างโครงสร้างข้อมูลวันที่และตันสะสม
            const dateData = [];
            const tonData = [];
            const cumulativeData = [];
            
            // คำนวณคอลัมน์เริ่มต้น (F = คอลัมน์ที่ 6 ใน 0-based index)
            const startCol = 5; // F คือคอลัมน์ที่ 6 (0-based index = 5)
            
            // คำนวณคอลัมน์สิ้นสุด (DP)
            const endCol = Math.min(dateHeaders.length - 1, 118); // DP index
            
            for (let col = startCol; col <= endCol; col++) {
                const dateStr = dateRow[col] || '';
                const tonStr = tonRow[col] || '';
                
                // แปลงวันที่จาก DD/MM/YY
                if (dateStr && isValidDate(dateStr)) {
                    const dateParts = dateStr.split('/');
                    if (dateParts.length === 3) {
                        const day = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // เดือนใน JavaScript เป็น 0-11
                        let year = parseInt(dateParts[2]);
                        
                        // แปลงปีจาก 68 เป็น 2568
                        if (year < 100) {
                            year = year + 2500 - 543; // แปลงจาก พ.ศ. เป็น ค.ศ.
                        }
                        
                        const date = new Date(year, month, day);
                        
                        // แปลงตันสะสม
                        const tons = parseFloat(tonStr.replace(/,/g, '')) || 0;
                        
                        dateData.push({
                            column: getColumnName(col),
                            date: dateStr,
                            fullDate: date
                        });
                        
                        tonData.push({
                            column: getColumnName(col),
                            tons: tons,
                            formattedTons: formatNumber(tons)
                        });
                        
                        cumulativeData.push({
                            date: date,
                            dateString: dateStr,
                            tons: tons
                        });
                    }
                }
            }
            
            // เรียงลำดับข้อมูลตามวันที่
            cumulativeData.sort((a, b) => a.date - b.date);
            
            return {
                dateData: dateData,
                tonData: tonData,
                cumulativeData: cumulativeData,
                startColumn: getColumnName(startCol),
                endColumn: getColumnName(endCol),
                totalDays: dateData.length
            };
        }
        
        // ตรวจสอบว่ารูปแบบวันที่ถูกต้องหรือไม่
        function isValidDate(dateStr) {
            const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{2}$/;
            if (!dateRegex.test(dateStr)) return false;
            
            const parts = dateStr.split('/');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            
            if (month < 1 || month > 12) return false;
            if (day < 1 || day > 31) return false;
            
            return true;
        }
        
        // แปลงคอลัมน์ index เป็นชื่อคอลัมน์ Excel (A, B, C, ..., Z, AA, AB, ...)
        function getColumnName(colIndex) {
            let name = '';
            let index = colIndex;
            
            while (index >= 0) {
                name = String.fromCharCode(65 + (index % 26)) + name;
                index = Math.floor(index / 26) - 1;
            }
            
            return name;
        }
        
        // แสดงตัวอย่างข้อมูล
        function showDataPreview(reportAnalysis) {
            const container = document.getElementById('dataPreview');
            container.style.display = 'block';
            
            // สร้างตารางข้อมูลวันที่
            let dateTableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>คอลัมน์</th>
                            <th>วันที่</th>
                            <th>รูปแบบ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // แสดงตัวอย่างข้อมูล
            const dateData = reportAnalysis.dateData;
            const totalDates = dateData.length;
            
            for (let i = 0; i < Math.min(5, totalDates); i++) {
                const item = dateData[i];
                dateTableHTML += `
                    <tr>
                        <td>${item.column}</td>
                        <td>${item.date}</td>
                        <td>DD/MM/YY</td>
                    </tr>
                `;
            }
            
            if (totalDates > 10) {
                dateTableHTML += `
                    <tr>
                        <td colspan="3" style="text-align: center; font-style: italic;">...</td>
                    </tr>
                `;
                
                for (let i = Math.max(5, totalDates - 5); i < totalDates; i++) {
                    const item = dateData[i];
                    dateTableHTML += `
                        <tr>
                            <td>${item.column}</td>
                            <td>${item.date}</td>
                            <td>DD/MM/YY</td>
                        </tr>
                    `;
                }
            }
            
            dateTableHTML += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: center; font-weight: bold;">
                                รวม ${totalDates} วัน (${reportAnalysis.startColumn}2 ถึง ${reportAnalysis.endColumn}2)
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            document.getElementById('dateDataPreview').innerHTML = dateTableHTML;
            
            // สร้างตารางข้อมูลตันสะสม
            let tonTableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>คอลัมน์</th>
                            <th>ตันสะสม</th>
                            <th>วันที่</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const tonData = reportAnalysis.tonData;
            
            for (let i = 0; i < Math.min(5, totalDates); i++) {
                const tonItem = tonData[i];
                const dateItem = dateData[i];
                tonTableHTML += `
                    <tr>
                        <td>${tonItem.column}</td>
                        <td>${tonItem.formattedTons}</td>
                        <td>${dateItem.date}</td>
                    </tr>
                `;
            }
            
            if (totalDates > 10) {
                tonTableHTML += `
                    <tr>
                        <td colspan="3" style="text-align: center; font-style: italic;">...</td>
                    </tr>
                `;
                
                for (let i = Math.max(5, totalDates - 5); i < totalDates; i++) {
                    const tonItem = tonData[i];
                    const dateItem = dateData[i];
                    tonTableHTML += `
                        <tr>
                            <td>${tonItem.column}</td>
                            <td>${tonItem.formattedTons}</td>
                            <td>${dateItem.date}</td>
                        </tr>
                    `;
                }
            }
            
            // คำนวณผลรวม
            const totalTons = tonData.reduce((sum, item) => sum + item.tons, 0);
            
            tonTableHTML += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align: center; font-weight: bold;">
                                รวมตันสะสม: ${formatNumber(totalTons)} ตัน (แถวที่ 7,503)
                            </td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            document.getElementById('tonDataPreview').innerHTML = tonTableHTML;
        }
        
        // อัปเดตการ์ดสรุป
        function updateSummaryCards(targetValues, reportAnalysis) {
            document.getElementById('target1').textContent = formatNumber(targetValues.target1);
            document.getElementById('target2').textContent = formatNumber(targetValues.target2);
            document.getElementById('target3').textContent = formatNumber(targetValues.target3);
            
            // คำนวณอ้อยเข้าหีบสะสมล่าสุด
            const cumulativeData = reportAnalysis.cumulativeData;
            const latestTons = cumulativeData.length > 0 ? cumulativeData[cumulativeData.length - 1].tons : 0;
            document.getElementById('totalCane').textContent = formatNumber(latestTons);
        }
        
        // สร้างกราฟ
        function createCharts(targetValues, reportAnalysis) {
            const cumulativeData = reportAnalysis.cumulativeData;
            
            // 1. กราฟเปรียบเทียบเป้าหมายกับผลปฏิบัติงาน
            const targetCtx = document.getElementById('targetVsActualChart').getContext('2d');
            
            // ทำลายกราฟเดิมถ้ามี
            if (targetChart) {
                targetChart.destroy();
            }
            
            // คำนวณเปอร์เซ็นต์ความสำเร็จ
            const latestTons = cumulativeData.length > 0 ? cumulativeData[cumulativeData.length - 1].tons : 0;
            const achievement1 = targetValues.target1 > 0 ? (latestTons / targetValues.target1) * 100 : 0;
            const achievement2 = targetValues.target2 > 0 ? (latestTons / targetValues.target2) * 100 : 0;
            const achievement3 = targetValues.target3 > 0 ? (latestTons / targetValues.target3) * 100 : 0;
            
            targetChart = new Chart(targetCtx, {
                type: 'bar',
                data: {
                    labels: ['ประเมิน 14/12', 'ประเมิน 5/1', 'ประเมิน 21/1'],
                    datasets: [
                        {
                            label: 'เป้าหมาย (ตัน)',
                            data: [targetValues.target1, targetValues.target2, targetValues.target3],
                            backgroundColor: 'rgba(44, 110, 73, 0.7)',
                            borderColor: 'rgba(44, 110, 73, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ผลปฏิบัติงาน (ตัน)',
                            data: [latestTons, latestTons, latestTons],
                            backgroundColor: 'rgba(76, 149, 108, 0.7)',
                            borderColor: 'rgba(76, 149, 108, 1)',
                            borderWidth: 1
                        },
                        {
                            label: '% ความสำเร็จ',
                            data: [achievement1, achievement2, achievement3],
                            type: 'line',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ตัน'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            max: Math.max(100, achievement1, achievement2, achievement3) * 1.1,
                            title: {
                                display: true,
                                text: '%'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 2) {
                                        // สำหรับ % ความสำเร็จ
                                        label += context.parsed.y.toFixed(2) + '%';
                                    } else {
                                        // สำหรับตัน
                                        label += formatNumber(context.parsed.y) + ' ตัน';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // 2. กราฟอ้อยเข้าหีบสะสมรายวัน
            const cumulativeCtx = document.getElementById('dailyCumulativeChart').getContext('2d');
            
            // ทำลายกราฟเดิมถ้ามี
            if (cumulativeChart) {
                cumulativeChart.destroy();
            }
            
            // เตรียมข้อมูลสำหรับกราฟ
            const dates = cumulativeData.map(item => item.dateString);
            const tons = cumulativeData.map(item => item.tons);
            
            cumulativeChart = new Chart(cumulativeCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'อ้อยเข้าหีบสะสม (ตัน)',
                            data: tons,
                            borderColor: 'rgba(44, 110, 73, 1)',
                            backgroundColor: 'rgba(44, 110, 73, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ตันสะสม'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'วันที่'
                            },
                            ticks: {
                                maxTicksLimit: 15,
                                callback: function(value, index, values) {
                                    // แสดงเพียงบางวันที่เท่านั้น
                                    if (index % Math.ceil(dates.length / 15) === 0 || index === dates.length - 1) {
                                        return dates[index];
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `อ้อยเข้าหีบสะสม: ${formatNumber(context.parsed.y)} ตัน (${dates[context.dataIndex]})`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // บันทึกรายงาน
        function saveReport() {
            showLoading(true);
            
            // สร้างข้อมูลสำหรับบันทึก
            const report = {
                timestamp: new Date().toISOString(),
                targetData: targetData,
                reportData: reportData,
                generatedDate: new Date().toLocaleDateString('th-TH'),
                summary: {
                    target1: parseFloat(document.getElementById('target1').textContent.replace(/,/g, '')),
                    target2: parseFloat(document.getElementById('target2').textContent.replace(/,/g, '')),
                    target3: parseFloat(document.getElementById('target3').textContent.replace(/,/g, '')),
                    totalCane: parseFloat(document.getElementById('totalCane').textContent.replace(/,/g, ''))
                }
            };
            
            // สร้างลิงก์สำหรับดาวน์โหลดไฟล์
            const dataStr = JSON.stringify(report, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `อ้อยเข้าหีบ_รายงาน_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            setTimeout(() => {
                showLoading(false);
                showAlert('บันทึกรายงานสำเร็จ!', 'success');
            }, 1000);
        }
        
        // รีเซ็ตข้อมูล
        function resetData() {
            if (confirm('คุณแน่ใจที่จะรีเซ็ตข้อมูลทั้งหมดใช่หรือไม่?')) {
                // รีเซ็ตอินพุตไฟล์
                document.getElementById('targetFileInput').value = '';
                document.getElementById('reportFileInput').value = '';
                
                // รีเซ็ตข้อความแสดงชื่อไฟล์
                document.getElementById('targetFileName').textContent = 'ยังไม่ได้เลือกไฟล์';
                document.getElementById('reportFileName').textContent = 'ยังไม่ได้เลือกไฟล์';
                
                // ซ่อนข้อมูลไฟล์
                document.getElementById('targetFileInfo').classList.remove('show');
                document.getElementById('reportFileInfo').classList.remove('show');
                document.getElementById('targetDebugInfo').classList.remove('show');
                document.getElementById('showTargetDebug').style.display = 'none';
                
                // ปิดปุ่มประมวลผล
                document.getElementById('processDataBtn').disabled = true;
                
                // ซ่อนผลลัพธ์
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('dataPreview').style.display = 'none';
                
                // รีเซ็ตข้อมูล
                targetData = null;
                reportData = null;
                
                // ทำลายกราฟ
                if (targetChart) {
                    targetChart.destroy();
                    targetChart = null;
                }
                
                if (cumulativeChart) {
                    cumulativeChart.destroy();
                    cumulativeChart = null;
                }
                
                showAlert('รีเซ็ตข้อมูลสำเร็จ', 'success');
            }
        }
        
        // ฟอร์แมตตัวเลข
        function formatNumber(num) {
            return new Intl.NumberFormat('th-TH').format(num);
        }
        
        // เริ่มต้นแอปพลิเคชัน
        document.addEventListener('DOMContentLoaded', function() {
            // อัปเดตวันที่ปัจจุบัน
            updateCurrentDate();
            
            // ตั้งค่าการอัพโหลดไฟล์
            setupFileUpload('targetUploadArea', 'targetFileInput', 'targetFileName', 'targetFileInfo');
            setupFileUpload('reportUploadArea', 'reportFileInput', 'reportFileName', 'reportFileInfo');
            
            // ตั้งค่าปุ่มประมวลผลข้อมูล
            document.getElementById('processDataBtn').addEventListener('click', processData);
            
            // ตั้งค่าปุ่มแสดง debug ไฟล์ TARGET
            document.getElementById('showTargetDebug').addEventListener('click', showTargetDebugInfo);
            
            // ตั้งค่าปุ่มบันทึกรายงาน
            document.getElementById('saveReportBtn').addEventListener('click', saveReport);
            
            // ตั้งค่าปุ่มรีเซ็ต
            document.getElementById('resetBtn').addEventListener('click', resetData);
            
            console.log('แดชบอร์ดรายงานอ้อยเข้าหีบปี 68/69 พร้อมใช้งาน');
            console.log('ระบบสนับสนุนการอ่านชื่อคอลัมน์แบบยืดหยุ่น');
        });
    </script>
</body>
</html>
