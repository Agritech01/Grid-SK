<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard - Cane Production 68/69</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --executive-blue: #1a237e; /* ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡∏™‡∏∏‡∏Ç‡∏∏‡∏° */
            --accent-gold: #c5a059;    /* ‡∏ó‡∏≠‡∏á‡∏´‡∏°‡πà‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
            --success-green: #2e7d32;
            --bg-gray: #f8f9fa;
            --text-dark: #202124;
            --white: #ffffff;
        }
        
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
        }

        /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ */
        #report-area {
            padding: 30px;
            max-width: 1400px;
            margin: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--executive-blue);
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        .title-group h1 {
            margin: 0;
            font-size: 24px;
            color: var(--executive-blue);
        }

        .title-group p {
            margin: 5px 0 0;
            color: #666;
            font-size: 14px;
        }

        /* Upload Section */
        .upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            background: #fdfdfd;
        }

        .upload-box.ready {
            border-color: var(--success-green);
            background: #f1f8e9;
        }

        .upload-box h3 { margin-top: 0; font-size: 16px; }

        /* Dashboard Elements */
        .zone-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .btn-zone {
            padding: 8px 18px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #555;
            transition: 0.3s;
        }

        .btn-zone:hover { background: #eee; }
        .btn-zone.active {
            background: var(--executive-blue);
            color: white;
            border-color: var(--executive-blue);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--accent-gold);
        }

        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            display: block;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--executive-blue);
        }

        .chart-wrapper {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: 550px;
            position: relative;
        }

        .action-bar {
            margin-top: 30px;
            text-align: right;
        }

        .btn-save {
            background: var(--success-green);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-save:hover { opacity: 0.9; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 5px;
        }
        .status-pending { background: #ffe0b2; color: #e65100; }
        .status-complete { background: #c8e6c9; color: #1b5e20; }
    </style>
</head>
<body>

<div id="report-area">
    <header>
        <div class="title-group">
            <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏• 68/69</h1>
            <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="current-date">-</span> | ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏´‡∏µ‡∏ö</p>
        </div>
        <div id="file-status-indicator">
            <span class="status-badge status-pending" id="process-status">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</span>
        </div>
    </header>

    <div class="upload-container no-print">
        <div class="upload-box" id="target-drop">
            <h3>1. ‡πÑ‡∏ü‡∏•‡πå DATA TARGET</h3>
            <input type="file" id="file-target" accept=".csv" hidden>
            <button onclick="document.getElementById('file-target').click()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</button>
            <div class="file-info" id="target-name">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
        </div>
        <div class="upload-box" id="actual-drop">
            <h3>2. ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö 68/69</h3>
            <input type="file" id="file-actual" accept=".csv" hidden>
            <button onclick="document.getElementById('file-actual').click()">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</button>
            <div class="file-info" id="actual-name">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
        </div>
    </div>
<div id="dashboard-content" class="hidden">
        <div class="zone-selector" id="zone-btns">
            </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <span class="metric-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï (‡∏ï‡∏±‡∏ô)</span>
                <div class="metric-value" id="val-target">-</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">‡∏´‡∏µ‡∏ö‡∏™‡∏∞‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏±‡∏ô)</span>
                <div class="metric-value" id="val-actual">-</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ (%)</span>
                <div class="metric-value" id="val-percent">-</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏ï‡∏±‡∏ô)</span>
                <div class="metric-value" id="val-remain">-</div>
            </div>
        </div>

        <div class="chart-wrapper">
            <canvas id="mainChart"></canvas>
        </div>

        <div class="action-bar">
            <button class="btn-save" id="btn-save-img">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
</div> <script>
    // Global Variables
    let targetData = [];
    let actualData = [];
    let selectedZone = "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï";
    let chartInstance = null;

    // Configuration
    const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

    // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    const fileInputs = {
        target: document.getElementById('file-target'),
        actual: document.getElementById('file-actual')
    };

    const displayNames = {
        target: document.getElementById('target-name'),
        actual: document.getElementById('actual-name')
    };

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
    function handleFileSelect(type, file) {
        if (!file) return;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
        if (file.size > MAX_FILE_SIZE) {
            alert(`‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100MB`);
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå
        if (!file.name.endsWith('.csv')) {
            alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (${file.name})`);
            return;
        }

        displayNames[type].innerText = `‚úÖ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        document.getElementById(`${type}-drop`).classList.add('ready');

        checkReadyToProcess();
    }

    fileInputs.target.addEventListener('change', (e) => handleFileSelect('target', e.target.files[0]));
    fileInputs.actual.addEventListener('change', (e) => handleFileSelect('actual', e.target.files[0]));

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á 2 ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    function checkReadyToProcess() {
        if (fileInputs.target.files.length > 0 && fileInputs.actual.files.length > 0) {
            document.getElementById('process-status').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            document.getElementById('process-status').className = "status-badge status-complete";
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏à‡∏∞‡∏™‡πà‡∏á Logic ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3)
            parseAllFiles();
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ö‡∏ô‡∏´‡∏±‡∏ß‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    document.getElementById('current-date').innerText = new Date().toLocaleDateString('th-TH', {
        year: 'numeric', month: 'long', day: 'numeric'
    });
// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á
    async function parseAllFiles() {
        const targetFile = fileInputs.target.files[0];
        const actualFile = fileInputs.actual.files[0];

        try {
            // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Target
            targetData = await parseCSV(targetFile);
            // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö
            actualData = await parseCSV(actualFile);

            console.log("Data loaded successfully");
            initDashboard(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á UI ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à
        } catch (error) {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå: " + error);
            console.error(error);
        }
    }

    // Helper: ‡∏™‡∏±‡πà‡∏á parse CSV ‡πÄ‡∏õ‡πá‡∏ô JSON
    function parseCSV(file) {
        return new Promise((resolve, reject) => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: (results) => resolve(results.data),
                error: (error) => reject(error)
            });
        });
    }

    // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
    const ZONES = ['1', '2', '3', '4', '5', '6', '7', '8', '10', '11', '12', '21', 'C1', 'C2', 'C3', 'C4'];
    
    function initDashboard() {
        const zoneBtnsContainer = document.getElementById('zone-btns');
        zoneBtnsContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï"
        const btnAll = createZoneBtn("‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï");
        zoneBtnsContainer.appendChild(btnAll);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏Ç‡∏ï
        ZONES.forEach(z => {
            zoneBtnsContainer.appendChild(createZoneBtn(z));
        });

        document.getElementById('dashboard-content').classList.remove('hidden');
        updateDashboard("‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï"); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    }

    function createZoneBtn(label) {
        const btn = document.createElement('button');
        btn.className = 'btn-zone';
        btn.innerText = label;
        btn.onclick = () => {
            document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateDashboard(label);
        };
        if(label === "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï") btn.classList.add('active');
        return btn;
    }

    // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateDashboard(zone) {
        selectedZone = zone;
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏î‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target) ---
        let targetMax = 0;
        let std14 = 0, std5 = 0, std21 = 0;

        if (zone === "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï") {
            targetMax = targetData.reduce((sum, row) => sum + (Number(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]) || 0), 0);
            std14 = targetData.reduce((sum, row) => sum + (Number(row["STD 14/12"]) || 0), 0);
            std5 = targetData.reduce((sum, row) => sum + (Number(row["STD 5/1"]) || 0), 0);
            std21 = targetData.reduce((sum, row) => sum + (Number(row["STD 21/1"]) || 0), 0);
        } else {
            const row = targetData.find(r => String(r["‡πÄ‡∏Ç‡∏ï"]) === zone);
            if (row) {
                targetMax = Number(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]) || 0;
                std14 = Number(row["STD 14/12"]) || 0;
                std5 = Number(row["STD 5/1"]) || 0;
                std21 = Number(row["STD 21/1"]) || 0;
            }
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (Actual) ---
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Column name ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Actual)
        const dateHeaders = Object.keys(actualData[0]).filter(h => h !== "‡πÄ‡∏Ç‡∏ï");
        const dailyActual = dateHeaders.map(date => {
            let sum = 0;
            actualData.forEach(row => {
                if (zone === "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï" || String(row["‡πÄ‡∏Ç‡∏ï"]) === zone) {
                    sum += (Number(row[date]) || 0);
                }
            });
            return { date, value: sum };
        });

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Accumulated & Forecast) ---
        let runningSum = 0;
        let lastActualIndex = -1;
        const accumulatedData = dailyActual.map((d, index) => {
            if (d.value > 0) {
                runningSum += d.value;
                lastActualIndex = index;
                return runningSum;
            }
            return null; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
        });

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Forecast ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        const remainingTarget = targetMax - runningSum;
        const remainingDays = dailyActual.length - (lastActualIndex + 1);
        const avgNeeded = remainingDays > 0 ? (remainingTarget / remainingDays) : 0;

        const forecastData = dailyActual.map((d, index) => {
            if (index < lastActualIndex) return null;
            if (index === lastActualIndex) return runningSum;
            runningSum += avgNeeded;
            return runningSum;
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Metrics)
        document.getElementById('val-target').innerText = targetMax.toLocaleString();
        document.getElementById('val-actual').innerText = (accumulatedData[lastActualIndex] || 0).toLocaleString();
        const percent = targetMax > 0 ? ((accumulatedData[lastActualIndex] || 0) / targetMax * 100).toFixed(2) : 0;
        document.getElementById('val-percent').innerText = percent + "%";
        document.getElementById('val-remain').innerText = (targetMax - (accumulatedData[lastActualIndex] || 0)).toLocaleString();

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (‡∏à‡∏∞‡∏™‡πà‡∏á Logic ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 4)
        renderChart(dateHeaders, dailyActual.map(d => d.value), accumulatedData, forecastData, {std14, std5, std21});
    }
    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü (‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö <script>)
    function renderChart(labels, actualDaily, accumulated, forecast, targetSTDs) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        
        // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
        if (chartInstance) {
            chartInstance.destroy();
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Background Target)
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: STD 14/12 (7-27 ‡∏ò.‡∏Ñ.), STD 5/1 (5-20 ‡∏°.‡∏Ñ.), STD 21/1 (21 ‡∏°.‡∏Ñ. - 31 ‡∏°‡∏µ.‡∏Ñ.)
        const targetBackground = labels.map(date => {
            const [d, m, y] = date.split('/');
            const day = parseInt(d);
            const month = parseInt(m);
            
            // ‡∏ä‡πà‡∏ß‡∏á 7/12 - 27/12
            if (month === 12 && day >= 7 && day <= 27) return targetSTDs.std14;
            // ‡∏ä‡πà‡∏ß‡∏á 5/1 - 20/1
            if (month === 1 && day >= 5 && day <= 20) return targetSTDs.std5;
            // ‡∏ä‡πà‡∏ß‡∏á 21/1 - 31/3
            if ((month === 1 && day >= 21) || (month === 2) || (month === 3)) return targetSTDs.std21;
            
            return null; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 28/12 - 04/01)
        });

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Target)',
                        data: targetBackground,
                        backgroundColor: 'rgba(197, 160, 89, 0.2)', // ‡∏™‡∏µ‡∏ó‡∏≠‡∏á‡∏à‡∏≤‡∏á‡πÜ
                        borderColor: 'transparent',
                        borderWidth: 0,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0,
                        order: 3
                    },
                    {
                        label: '‡∏¢‡∏≠‡∏î‡∏´‡∏µ‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (Actual)',
                        data: actualDaily,
                        backgroundColor: '#1a237e', // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏°
                        borderRadius: 4,
                        order: 2
                    },
                    {
                        label: '‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏∞‡∏™‡∏°/‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå',
                        data: forecast,
                        type: 'line',
                        borderColor: '#2e7d32', // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: false,
                        tension: 0.1,
                        order: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString() + ' ‡∏ï‡∏±‡∏ô';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10 } }
                    },
                    y: {
                        title: { display: true, text: '‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏≠‡πâ‡∏≠‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏ï‡∏±‡∏ô)' },
                        beginAtZero: true
                    },
                    y1: {
                        title: { display: true, text: '‡∏™‡∏∞‡∏™‡∏°‡∏£‡∏ß‡∏° (‡∏ï‡∏±‡∏ô)' },
                        position: 'right',
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    }
    // 6. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö <script>)
    document.getElementById('btn-save-img').addEventListener('click', function() {
        const reportArea = document.getElementById('report-area');
        const actionButtons = document.querySelector('.action-bar');
        const uploadSection = document.querySelector('.upload-container');

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        actionButtons.style.display = 'none';
        uploadSection.style.display = 'none';

        html2canvas(reportArea, {
            scale: 2, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            backgroundColor: "#f8f9fa",
            logging: false
        }).then(canvas => {
            const link = document.createElement('a');
            const dateStr = new Date().toISOString().slice(0, 10);
            link.download = `Dashboard-Cane-${selectedZone}-${dateStr}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            actionButtons.style.display = 'block';
            uploadSection.style.display = 'grid';
        });
    });

    // 7. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏≤‡∏á (Drag and Drop) - ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å
    ['target-drop', 'actual-drop'].forEach(id => {
        const dropZone = document.getElementById(id);
        const type = id.split('-')[0];
        const input = document.getElementById(`file-${type}`);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length) {
                input.files = files;
                handleFileSelect(type, files[0]);
            }
        });
    });
</body>
</html>
</script>

    
