<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugar Cane Dashboard 68/69 - Auto Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* ‡∏Ñ‡∏á CSS ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Dashboard */
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --light: #f4f7f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--light); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #000000; margin-bottom: 0px; line-height: 1.1; font-size: 32px; }
        .dashboard-subtitle { text-align: center; margin-top: 5px; margin-bottom: 0px; line-height: 1.2; }
        .filter-container { display: flex; flex-wrap: nowrap; gap: 4px; justify-content: space-between; margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 12px; overflow-x: auto; }
        .btn-zone { flex: 1; padding: 8px 4px; border: 1px solid #cbd5e0; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; text-align: center; }
        .btn-zone.active { background: var(--primary); color: white; border-color: var(--primary); }
        .chart-wrapper { background: #fff; padding: 0px 10px; border-radius: 12px; margin-top: -5px; margin-bottom: 10px; }
        .chart-container { position: relative; height: 550px; width: 100%; }
        .slider-container { margin-top: 5px; padding: 8px 15px; display: flex; align-items: center; gap: 15px; background: #f8fafc; border-radius: 8px; }
        .slider-container input { flex-grow: 1; cursor: pointer; height: 8px; border-radius: 5px; background: #dcdde1; outline: none; }
        .zoom-controls { display: flex; gap: 5px; align-items: center; }
        .btn-zoom { background: #fff; border: 1px solid #cbd5e0; border-radius: 6px; padding: 4px 10px; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--primary); }
        .btn-zoom.active { background: var(--primary); color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 10px; }
        .stat-card { padding: 15px; border-radius: 12px; color: #2c3e50; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .stat-card.blue { background: linear-gradient(135deg, #D6EAF8, #AED6F1); }
        .stat-card.green { background: linear-gradient(135deg, #D5F5E3, #ABEBC6); }
        .stat-card.purple { background: linear-gradient(135deg, #E8DAEF, #D2B4DE); }
        .stat-card.orange { background: linear-gradient(135deg, #FCF3CF, #FAD7A0); }
        .stat-card.red { background: linear-gradient(135deg, #FADBD8, #F5B7B1); }
        .stat-label { font-size: 0.9em; font-weight: 600; opacity: 0.85; margin-bottom: 5px; }
        .stat-value { font-size: 1.6em; font-weight: bold; }
        .footer-actions { margin-top: 20px; text-align: right; }
        .btn-download { background: #2d3748; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        #loadingOverlay { text-align: center; padding: 100px 20px; font-size: 24px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div class="container" id="dashboardNode">
    <h2 id="dashboardTitle">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡πâ‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏µ‡∏ö ‡∏õ‡∏µ 68/69</h2>
    
    <div id="loadingOverlay">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>

    <div id="subTitleArea" class="dashboard-subtitle" style="display:none;">
        <span id="displayZone" style="font-size: 26px; font-weight: bold; color: #FF0000;">‡πÄ‡∏Ç‡∏ï ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</span><br>
        <span id="displayDate" style="font-size: 20px; color: #000000;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà...</span>
    </div>
    
    <div class="filter-container" id="zoneFilter" style="display:none;"></div>

    <div id="mainDashboard" style="display:none;">
        <div class="chart-wrapper">
            <div class="chart-container">
                <canvas id="sugarChart"></canvas>
            </div>
            <div class="slider-container" id="controlUI">
                <div class="zoom-controls">
                    <button id="btnZoomIn" class="btn-zoom active" onclick="applyZoom(30, this)">30 ‡∏ß‡∏±‡∏ô</button>
                    <button id="btnZoomOut" class="btn-zoom" onclick="applyZoom('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <input type="range" id="chartSlider" min="0" value="0">
                <span id="sliderValue" style="font-size: 11px; color: #666; width: 90px;"></span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card blue"><div class="stat-label">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardTarget">-</div></div>
            <div class="stat-card green"><div class="stat-label">‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏° (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardAcc">-</div></div>
            <div class="stat-card orange"><div class="stat-label">% ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</div><div class="stat-value" id="cardPercent">-</div></div>
            <div class="stat-card red"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤ (‡∏ï‡∏±‡∏ô)</div><div class="stat-value" id="cardRemain">-</div></div>
            <div class="stat-card purple"><div class="stat-label">‡∏ï‡∏±‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏ß‡∏±‡∏ô (5D)</div><div class="stat-value" id="cardAvg5D">-</div></div>
        </div>
     
        <div class="footer-actions">
            <button class="btn-download" onclick="exportImage()">üì∏ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        </div>
    </div>
</div>

<script>
    // --- 1. ‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå CSV ‡∏ó‡∏µ‡πà‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Sheets ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ---
    const TARGET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBzyNUXjGTBy8z0Hv5jxHk6tKYlYQhBtwg9sPVqqNm8sqxVJ_JljWq2f9JodvZR41Rv65gcvgdNebi/pub?output=csv';
    const ACTUAL_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSyMB_Fxk8PoDzl11U1tbzse2ANnNhh4iROwMXB5LFHGksPLo7aX2I1LniuEd9s-5dkO0FG3focFDzA/pub?output=csv';

    Chart.register(ChartDataLabels);
    let rawTarget = [];
    let rawActual = [];
    let myChart = null;
    let currentViewRange = 30;
    const zones = ["1", "2", "3", "4", "5", "6", "7", "8", "10", "11", "12", "21", "C1", "C2", "C3", "C4"]; [cite: 147]

    // --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ ---
    window.onload = async function() {
        try {
            const [targetRes, actualRes] = await Promise.all([
                fetch(TARGET_CSV_URL),
                fetch(ACTUAL_CSV_URL)
            ]);

            const targetText = await targetRes.text();
            const actualText = await actualRes.text();

            Papa.parse(targetText, {
                header: true,
                skipEmptyLines: true,
                transformHeader: (h) => h.trim(),
                complete: function(tResults) {
                    rawTarget = tResults.data;
                    Papa.parse(actualText, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (h) => h.trim(),
                        complete: function(aResults) {
                            rawActual = aResults.data;
                            document.getElementById('loadingOverlay').style.display = 'none';
                            initDashboard();
                        }
                    });
                }
            });
        } catch (error) {
            document.getElementById('loadingOverlay').innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Publish ‡∏•‡∏¥‡∏á‡∏Å‡πå";
            console.error(error);
        }
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞ Render ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    function initDashboard() {
        initFilterButtons(); [cite: 153]
        document.getElementById('zoneFilter').style.display = 'flex'; [cite: 154]
        document.getElementById('mainDashboard').style.display = 'block'; [cite: 154]
        document.getElementById('subTitleArea').style.display = 'block'; [cite: 154]
        updateDashboard('‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï'); [cite: 154]
    }

    function initFilterButtons() {
        const container = document.getElementById('zoneFilter');
        container.innerHTML = `<button class="btn-zone active" onclick="changeZone(this, '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï')">‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï</button>`;
        zones.forEach(z => { container.innerHTML += `<button class="btn-zone" onclick="changeZone(this, '${z}')">‡πÄ‡∏Ç‡∏ï ${z}</button>`; }); [cite: 156]
    }

    function changeZone(btn, zone) {
        document.querySelectorAll('.btn-zone').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateDashboard(zone); [cite: 157]
    }

    function generateDateRange() {
        let dates = [], start = new Date(1968, 11, 7, 12, 0, 0), end = new Date(1969, 2, 31, 12, 0, 0), current = new Date(start); [cite: 158]
        while (current <= end) { dates.push(new Date(current)); current.setDate(current.getDate() + 1); } [cite: 159]
        return dates;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (applyZoom, updateChartRange, updateDashboard, renderChart) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
    // (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ú‡∏°‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
    
    /* ... ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ... */
    
    function applyZoom(mode, btn) {
        const totalDays = myChart.data.labels.length; [cite: 160]
        if (mode === 'all') { currentViewRange = totalDays; } else { currentViewRange = mode; } [cite: 161]
        document.querySelectorAll('.btn-zoom').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const slider = document.getElementById('chartSlider');
        const maxScroll = Math.max(0, totalDays - currentViewRange); [cite: 163]
        slider.max = maxScroll;
        slider.value = 0;
        updateChartRange(0); [cite: 163]
    }

    function updateChartRange(val) {
        const sliderValueDisplay = document.getElementById('sliderValue');
        myChart.options.scales.x.min = val; [cite: 165]
        myChart.options.scales.x.max = val + currentViewRange - 1; [cite: 165]
        sliderValueDisplay.innerText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${val + 1}-${Math.min(val + currentViewRange, myChart.data.labels.length)}`; [cite: 165]
        myChart.update('none'); [cite: 165]
    }

    function updateDashboard(selectedZone) {
        const zoneText = selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? selectedZone : `‡πÄ‡∏Ç‡∏ï ${selectedZone}`; [cite: 166, 167]
        document.getElementById('displayZone').innerText = zoneText; [cite: 167]
        const dates = generateDateRange(); [cite: 167]
        let targetMax = 0, std1 = 0, std2 = 0, std3 = 0, std4 = 0; [cite: 168]
        const parseNum = (v) => parseFloat(String(v || "").replace(/[^0-9.-]/g, '')) || 0; [cite: 169]
        rawTarget.forEach(row => {
            if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                targetMax += parseNum(row["‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ MAX"]);
                std1 += parseNum(row["STD 14/12"]);
                std2 += parseNum(row["STD 5/1"]);
                std3 += parseNum(row["STD 21/1"]);
                std4 += parseNum(row["STD 10/02"]); 
            }
        }); [cite: 170]
        const targetSeries = dates.map(d => {
            const y = d.getFullYear(); const m = d.getMonth() + 1; const day = d.getDate();
            if (y === 1968 && m === 12 && day >= 7 && day <= 27) return std1; [cite: 171]
            if (y === 1969 && m === 1 && day >= 5 && day <= 20) return std2; [cite: 171, 172]
            if (y === 1969 && ((m === 1 && day >= 21) || (m === 2 && day <= 9))) return std3; [cite: 172]
            if (y === 1969 && ((m === 2 && day >= 10) || m === 3)) return std4; [cite: 172]
            return 0; 
        }); [cite: 172]
        let lastDataIdx = -1;
        const actualDaily = dates.map((d, idx) => {
            const searchKey = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            let daySum = 0, found = false;
            rawActual.forEach(row => {
                if (isValidZone(row["‡πÄ‡∏Ç‡∏ï"], selectedZone)) {
                    const val = row[searchKey]; [cite: 174]
                    if (val !== undefined && val !== null && String(val).trim() !== "") { daySum += parseNum(val); found = true; } [cite: 174]
                }
            });
            if (found) lastDataIdx = idx; [cite: 174]
            return daySum;
        }); [cite: 175]

        if (lastDataIdx !== -1) {
            const lastDateObj = dates[lastDataIdx]; [cite: 175]
            const thaiMonths = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"]; [cite: 176]
            const thaiYear = lastDateObj.getFullYear() + 600; [cite: 177]
            document.getElementById('displayDate').innerText = `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${lastDateObj.getDate()} ${thaiMonths[lastDateObj.getMonth()]} ${thaiYear}`; [cite: 177]
        }

        let accSum = 0, actualAcc = []; [cite: 178]
        for (let i = 0; i <= lastDataIdx; i++) { accSum += actualDaily[i]; actualAcc.push(accSum); } [cite: 179]
        const projectionLine = new Array(actualAcc.length > 0 ? actualAcc.length - 1 : 0).fill(null); [cite: 180]
        if (actualAcc.length > 0) projectionLine.push(accSum); [cite: 181]
        if (lastDataIdx < dates.length - 1 && lastDataIdx !== -1) {
            let remTarget = Math.max(0, targetMax - accSum), remDays = (dates.length - 1) - lastDataIdx, dailyProj = remTarget / remDays, tempAcc = accSum; [cite: 181]
            for (let i = lastDataIdx + 1; i < dates.length; i++) { tempAcc += dailyProj; projectionLine.push(tempAcc); } [cite: 182]
        }

        document.getElementById('cardTarget').innerText = Math.round(targetMax).toLocaleString(); [cite: 183]
        document.getElementById('cardAcc').innerText = Math.round(accSum).toLocaleString(); [cite: 184]
        const percentRaw = (accSum / (targetMax || 1)) * 100; [cite: 184]
        document.getElementById('cardPercent').innerText = Number(percentRaw.toFixed(2)) + "%"; [cite: 185]
        document.getElementById('cardRemain').innerText = Math.max(0, Math.round(targetMax - accSum)).toLocaleString(); [cite: 185]
        let sum5D = 0, count5D = 0;
        for(let i=lastDataIdx; i > lastDataIdx-5 && i >= 0; i--) { sum5D += actualDaily[i]; count5D++; } [cite: 186, 187]
        document.getElementById('cardAvg5D').innerText = count5D > 0 ? Math.round(sum5D/count5D).toLocaleString() : "0"; [cite: 187]
        renderChart(dates, targetSeries, actualDaily, actualAcc, projectionLine, lastDataIdx); [cite: 188]
    }

    function isValidZone(rowZone, selectedZone) {
        const cleanRowZone = String(rowZone || "").trim(); [cite: 188]
        return selectedZone === '‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï' ? zones.includes(cleanRowZone) : cleanRowZone === selectedZone; [cite: 189]
    }

    function renderChart(dates, targets, daily, acc, proj, lastIdx) {
        const labels = dates.map(d => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth()+1).padStart(2, '0')}`); [cite: 190]
        const ctx = document.getElementById('sugarChart').getContext('2d'); [cite: 191]
        const slider = document.getElementById('chartSlider');
        const maxScroll = Math.max(0, labels.length - currentViewRange); [cite: 191]
        slider.max = maxScroll;
        slider.value = Math.min(maxScroll, Math.max(0, lastIdx - (currentViewRange / 2))); [cite: 192]

        if (myChart) myChart.destroy(); [cite: 192]
        myChart = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    { type: 'line', label: '‡∏ï‡∏±‡∏ô‡∏™‡∏∞‡∏™‡∏°', data: acc, borderColor: '#27ae60', borderWidth: 3, yAxisID: 'yAcc', pointRadius: (c) => c.dataIndex === lastIdx ? 4 : 0, pointBackgroundColor: '#FF0000', pointBorderColor: '#FF0000', datalabels: { display: (c) => c.dataIndex === lastIdx, align:315, backgroundColor: '#33CCCC', color: 'white', borderRadius: 4, padding: 6, font: { size: 14, weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } }, [cite: 193, 194]
                    { type: 'line', label: '‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏∞‡∏™‡∏°', data: proj, borderColor: '#27ae60', borderDash: [5, 5], yAxisID: 'yAcc', pointRadius: (c) => c.dataIndex === proj.length - 1 ? 4 : 0, pointBackgroundColor: '#FF0000', pointBorderColor: '#FF0000', datalabels: { display: (c) => c.dataIndex === proj.length - 1, align: 'right', backgroundColor: '#4682B4', color: 'white', borderRadius: 4, padding: 6, font: { size: 14, weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } }, [cite: 194, 195]
                    { type: 'bar', label: '‡∏ï‡∏±‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', data: daily.slice(0, lastIdx + 1), backgroundColor: '#3498db', yAxisID: 'yDaily', datalabels: { display: (c) => c.dataIndex === lastIdx, anchor: 'end', align: 'top', backgroundColor: '#00CCFF', color: 'white', borderRadius: 4, padding: 4, font: { size: 14, weight: 'bold' }, formatter: (v) => Math.round(v).toLocaleString() } }, [cite: 195]
                    { type: 'bar', label: '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ STD', data: targets, backgroundColor: 'rgba(200, 200, 200, 0.6)', yAxisID: 'yDaily', datalabels: { display: false } } [cite: 196]
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { mode: 'index', intersect: false }, datalabels: { font: { weight: 'bold', size: 10 } } },
                scales: {
                    x: { min: parseInt(slider.value), max: parseInt(slider.value) + currentViewRange - 1, ticks: { autoSkip: false, maxRotation: 90, font: { size: 9 } }, grid: { display: false } }, [cite: 197]
                    yDaily: { type: 'linear', position: 'left', beginAtZero: true }, [cite: 198]
                    yAcc: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } } [cite: 198]
                }
            }
        });
        slider.oninput = function() { updateChartRange(parseInt(this.value)); }; [cite: 199]
        updateChartRange(parseInt(slider.value)); [cite: 199]
    }

    function exportImage() {
        const node = document.getElementById('dashboardNode'); [cite: 200]
        const elementsToHide = ['#controlUI', '.footer-actions', '.filter-container']; [cite: 201]
        elementsToHide.forEach(s => { const el = document.querySelector(s); if(el) el.style.display = 'none'; }); [cite: 201]
        html2canvas(node, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a'); link.download = 'Sugar_Report_Final.png'; link.href = canvas.toDataURL('image/png'); link.click(); [cite: 202]
            elementsToHide.forEach(s => { const el = document.querySelector(s); if(el) el.style.display = (s === '.filter-container' ? 'flex' : (s === '#controlUI' ? 'flex' : 'block')); }); [cite: 203]
        });
    }
</script>
</body>
</html>
